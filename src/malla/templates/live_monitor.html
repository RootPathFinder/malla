{% extends "base.html" %}

{% block title %}Live Monitor - {{ APP_NAME }}{% endblock %}

{% block extra_css %}
<style>
    .live-monitor-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .live-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--bs-border-color);
    }

    .live-title {
        font-size: 1.75rem;
        font-weight: 600;
    }

    .connection-status {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 16px;
        border-radius: 20px;
        background: var(--bs-light);
        font-weight: 500;
    }

    .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    .status-connected {
        background: var(--bs-success);
    }

    .status-disconnected {
        background: var(--bs-danger);
        animation: none;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .stat-card {
        background: var(--bs-primary);
        color: white;
        padding: 20px;
        border-radius: var(--bs-border-radius);
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    }

    .stat-card.success {
        background: var(--bs-success);
    }

    .stat-card.warning {
        background: var(--bs-warning);
    }

    .stat-card.info {
        background: var(--bs-info);
    }

    .stat-label {
        font-size: 0.75rem;
        opacity: 0.9;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        margin-top: 5px;
    }

    .activity-feed {
        background: var(--bs-body-bg);
        border-radius: var(--bs-border-radius);
        border: 1px solid var(--bs-border-color);
        overflow: hidden;
    }

    .feed-header {
        background: var(--bs-light);
        padding: 15px 20px;
        border-bottom: 1px solid var(--bs-border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .feed-title {
        font-size: 1.125rem;
        font-weight: 600;
    }

    .feed-controls {
        display: flex;
        gap: 10px;
    }

    .filter-btn {
        padding: 6px 12px;
        border: 1px solid var(--bs-border-color);
        background: var(--bs-body-bg);
        color: var(--bs-body-color);
        border-radius: var(--bs-border-radius-sm);
        cursor: pointer;
        font-size: 0.8125rem;
        transition: all 0.2s;
    }

    .filter-btn:hover {
        background: var(--bs-light);
    }

    .filter-btn.active {
        background: var(--bs-primary);
        color: white;
        border-color: var(--bs-primary);
    }

    .feed-content {
        max-height: calc(100vh - 400px);
        min-height: 400px;
        overflow-y: auto;
    }

    .activity-item {
        padding: 15px 20px;
        border-bottom: 1px solid var(--bs-border-color);
        display: flex;
        gap: 15px;
        animation: slideIn 0.3s ease-out;
        transition: background 0.2s;
    }

    .activity-item:hover {
        background: var(--bs-light);
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .activity-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.125rem;
        flex-shrink: 0;
        color: white;
    }

    .activity-icon.packet {
        background: var(--bs-primary);
    }

    .activity-icon.node_online {
        background: var(--bs-success);
    }

    .activity-icon.node_offline {
        background: var(--bs-danger);
    }

    .activity-icon.alert {
        background: var(--bs-warning);
    }

    .activity-icon.traceroute {
        background: var(--bs-info);
    }

    .activity-details {
        flex: 1;
    }

    .activity-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 5px;
    }

    .activity-title {
        font-weight: 600;
        font-size: 0.9375rem;
    }

    .activity-time {
        font-size: 0.75rem;
        color: var(--bs-secondary);
    }

    .activity-description {
        color: var(--bs-secondary);
        font-size: 0.875rem;
        line-height: 1.5;
    }

    .activity-meta {
        display: flex;
        gap: 15px;
        margin-top: 8px;
        flex-wrap: wrap;
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.75rem;
        color: var(--bs-secondary);
        background: var(--bs-light);
        padding: 4px 10px;
        border-radius: 12px;
    }

    .meta-icon {
        font-size: 0.625rem;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--bs-secondary);
    }

    .empty-icon {
        font-size: 3rem;
        margin-bottom: 15px;
        opacity: 0.5;
    }

    .severity-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.6875rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .severity-info {
        background: rgba(var(--bs-info-rgb), 0.1);
        color: var(--bs-info);
    }

    .severity-warning {
        background: rgba(var(--bs-warning-rgb), 0.1);
        color: var(--bs-warning);
    }

    .severity-critical {
        background: rgba(var(--bs-danger-rgb), 0.1);
        color: var(--bs-danger);
    }

    .signal-quality {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .signal-bar {
        width: 3px;
        height: 12px;
        background: var(--bs-border-color);
        border-radius: 2px;
    }

    .signal-bar.active {
        background: var(--bs-success);
    }

    .signal-bar.weak {
        background: var(--bs-warning);
    }

    .auto-scroll-toggle {
        padding: 6px 12px;
        background: var(--bs-primary);
        color: white;
        border: none;
        border-radius: var(--bs-border-radius-sm);
        cursor: pointer;
        font-size: 0.8125rem;
        transition: all 0.2s;
    }

    .auto-scroll-toggle:hover {
        background: var(--bs-primary);
        filter: brightness(0.9);
    }

    .auto-scroll-toggle.disabled {
        background: var(--bs-secondary);
        opacity: 0.65;
    }

    /* Scrollbar styling */
    .feed-content::-webkit-scrollbar {
        width: 8px;
    }

    .feed-content::-webkit-scrollbar-track {
        background: var(--bs-light);
    }

    .feed-content::-webkit-scrollbar-thumb {
        background: var(--bs-secondary);
        border-radius: 4px;
    }

    .feed-content::-webkit-scrollbar-thumb:hover {
        background: var(--bs-dark);
    }
</style>
{% endblock %}

{% block content %}
<div class="live-monitor-container">
    <div class="live-header">
        <h1 class="live-title">ðŸ”´ Live Activity Monitor</h1>
        <div class="connection-status" id="connectionStatus">
            <div class="status-indicator status-disconnected" id="statusIndicator"></div>
            <span id="statusText">Connecting...</span>
        </div>
    </div>

    <div class="stats-grid" id="statsGrid">
        <div class="stat-card info">
            <div class="stat-label">Total Events</div>
            <div class="stat-value" id="totalEvents">0</div>
        </div>
        <div class="stat-card success">
            <div class="stat-label">Packets/sec</div>
            <div class="stat-value" id="packetsPerSec">0.0</div>
        </div>
        <div class="stat-card warning">
            <div class="stat-label">Active Nodes</div>
            <div class="stat-value" id="activeNodes">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Clients Connected</div>
            <div class="stat-value" id="clientsConnected">0</div>
        </div>
    </div>

    <div class="activity-feed">
        <div class="feed-header">
            <h2 class="feed-title">Live Activity Feed</h2>
            <div class="feed-controls">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="packet">Packets</button>
                <button class="filter-btn" data-filter="node_online">Nodes</button>
                <button class="filter-btn" data-filter="alert">Alerts</button>
                <button class="auto-scroll-toggle" id="autoScrollToggle">Auto-scroll: ON</button>
            </div>
        </div>
        <div class="feed-content" id="feedContent">
            <div class="empty-state">
                <div class="empty-icon">ðŸ“¡</div>
                <div>Waiting for mesh activity...</div>
                <div style="font-size: 13px; margin-top: 10px; color: #bbb;">
                    Real-time events will appear here as they occur
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Live Monitor JavaScript
(function() {
    let eventSource = null;
    let autoScroll = true;
    let currentFilter = 'all';
    let eventCount = 0;

    const feedContent = document.getElementById('feedContent');
    const statusIndicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    const autoScrollToggle = document.getElementById('autoScrollToggle');

    // Icon mapping for different event types
    const eventIcons = {
        packet: 'ðŸ“¨',
        node_online: 'ðŸŸ¢',
        node_offline: 'ðŸ”´',
        alert: 'âš ï¸',
        traceroute: 'ðŸ—ºï¸',
        connected: 'âœ“'
    };

    function connectToStream() {
        eventSource = new EventSource('/api/live/stream');

        eventSource.onopen = function() {
            updateConnectionStatus(true);
        };

        eventSource.onerror = function() {
            updateConnectionStatus(false);
            // Reconnect after 5 seconds
            setTimeout(connectToStream, 5000);
        };

        eventSource.onmessage = function(e) {
            try {
                const event = JSON.parse(e.data);
                handleEvent(event);
            } catch (err) {
                console.error('Error parsing event:', err);
            }
        };
    }

    function updateConnectionStatus(connected) {
        if (connected) {
            statusIndicator.className = 'status-indicator status-connected';
            statusText.textContent = 'Connected';
        } else {
            statusIndicator.className = 'status-indicator status-disconnected';
            statusText.textContent = 'Disconnected';
        }
    }

    function handleEvent(event) {
        if (event.type === 'connected') {
            return;
        }

        eventCount++;

        // Update stats
        updateStats();

        // Add to feed if filter matches
        if (currentFilter === 'all' || currentFilter === event.type) {
            addEventToFeed(event);
        }
    }

    function addEventToFeed(event) {
        // Remove empty state if present
        const emptyState = feedContent.querySelector('.empty-state');
        if (emptyState) {
            emptyState.remove();
        }

        const eventEl = createEventElement(event);
        feedContent.insertBefore(eventEl, feedContent.firstChild);

        // Limit to 100 events in DOM
        while (feedContent.children.length > 100) {
            feedContent.removeChild(feedContent.lastChild);
        }

        // Auto-scroll if enabled
        if (autoScroll) {
            feedContent.scrollTop = 0;
        }
    }

    function createEventElement(event) {
        const div = document.createElement('div');
        div.className = 'activity-item';

        const icon = eventIcons[event.type] || 'â€¢';
        const timeAgo = getTimeAgo(event.timestamp);

        let title = '';
        let description = '';
        let metaItems = [];

        if (event.type === 'packet') {
            const d = event.data;
            title = `${d.type || 'Unknown'} packet`;
            description = `${d.from_name} â†’ ${d.to_name}`;

            if (d.rssi) metaItems.push(`RSSI: ${d.rssi}dBm`);
            if (d.snr) metaItems.push(`SNR: ${d.snr.toFixed(1)}dB`);
            if (d.hop_limit) metaItems.push(`Hops: ${d.hop_limit}`);
            if (d.text) description += `: "${d.text}"`;
        } else if (event.type.startsWith('node_')) {
            const d = event.data;
            title = `Node ${d.status}`;
            description = d.node_name;
        } else if (event.type === 'alert') {
            const d = event.data;
            title = d.alert_type;
            description = d.message;
        }

        const metaHtml = metaItems.map(item =>
            `<span class="meta-item">${item}</span>`
        ).join('');

        div.innerHTML = `
            <div class="activity-icon ${event.type}">
                ${icon}
            </div>
            <div class="activity-details">
                <div class="activity-header">
                    <span class="activity-title">${title}</span>
                    <span class="activity-time">${timeAgo}</span>
                </div>
                <div class="activity-description">${description}</div>
                ${metaItems.length > 0 ? `<div class="activity-meta">${metaHtml}</div>` : ''}
            </div>
        `;

        return div;
    }

    function getTimeAgo(timestamp) {
        const seconds = Math.floor(Date.now() / 1000 - timestamp);
        if (seconds < 5) return 'just now';
        if (seconds < 60) return `${seconds}s ago`;
        if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
        return `${Math.floor(seconds / 3600)}h ago`;
    }

    function updateStats() {
        // Fetch stats from API
        fetch('/api/live/stats')
            .then(r => r.json())
            .then(data => {
                const stats = data.stats;
                document.getElementById('totalEvents').textContent = stats.total_events || 0;
                document.getElementById('packetsPerSec').textContent = (stats.packets_per_second || 0).toFixed(1);
                document.getElementById('clientsConnected').textContent = stats.clients_connected || 0;
            });

        // Fetch summary for active nodes
        fetch('/api/live/summary?window=300')
            .then(r => r.json())
            .then(data => {
                const summary = data.summary;
                document.getElementById('activeNodes').textContent = summary.unique_nodes || 0;
            });
    }

    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentFilter = this.dataset.filter;

            // Reload recent events with filter
            loadRecentEvents();
        });
    });

    // Auto-scroll toggle
    autoScrollToggle.addEventListener('click', function() {
        autoScroll = !autoScroll;
        this.textContent = `Auto-scroll: ${autoScroll ? 'ON' : 'OFF'}`;
        this.classList.toggle('disabled', !autoScroll);
    });

    function loadRecentEvents() {
        const url = currentFilter === 'all'
            ? '/api/live/recent?limit=50'
            : `/api/live/recent?limit=50&type=${currentFilter}`;

        fetch(url)
            .then(r => r.json())
            .then(data => {
                feedContent.innerHTML = '';
                if (data.events.length === 0) {
                    feedContent.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ðŸ“¡</div>
                            <div>No ${currentFilter === 'all' ? '' : currentFilter} events yet</div>
                        </div>
                    `;
                } else {
                    data.events.reverse().forEach(event => {
                        addEventToFeed(event);
                    });
                }
            });
    }

    // Initialize
    connectToStream();
    loadRecentEvents();
    updateStats();

    // Update stats every 5 seconds
    setInterval(updateStats, 5000);

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (eventSource) {
            eventSource.close();
        }
    });
})();
</script>
{% endblock %}
