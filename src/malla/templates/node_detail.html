{% extends "base.html" %}
{% from "macros.html" import node_link, node_badge, gateway_link, protocol_badge, signal_indicator %}

{% block title %}{{ node.node_name }} - Node Details{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    .card-metric {
        text-align: center;
    }
    .metric-value {
        font-size: 2rem;
        font-weight: bold;
    }
    .metric-label {
        color: #6c757d;
        font-size: 0.875rem;
    }
    .signal-indicator {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
    }
    .protocol-badge {
        font-size: 0.75rem;
        padding: 4px 8px;
    }
    .neighbor-card {
        border-left: 4px solid #007bff;
        margin-bottom: 0.5rem;
    }
    .vertical-header {
        writing-mode: vertical-rl;
        transform: rotate(180deg);
        padding: 4px 2px;
        white-space: nowrap;
        text-align: left;
    }
    .matrix-table th, .matrix-table td {
        padding: 2px 4px;
        font-size: 0.75rem;
    }
    .matrix-table td { text-align: center; }
    .hw-thumbnail {
        max-height: 48px;
        max-width: 80px;
        margin-left: 12px;
        border-radius: 4px;
        vertical-align: middle;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .hw-model-container {
        display: flex;
        align-items: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item"><a href="/nodes">Nodes</a></li>
                    <li class="breadcrumb-item active">{{ node.node_name }}</li>
                </ol>
            </nav>
            <h1>
                <i class="bi bi-router"></i> {{ node.node_name }}
                {% if node.last_seen_relative == "Just now" or "minute" in node.last_seen_relative %}
                    <span class="badge bg-success">Online</span>
                {% elif "hour" in node.last_seen_relative %}
                    <span class="badge bg-warning">Recent</span>
                {% else %}
                    <span class="badge bg-secondary">Offline</span>
                {% endif %}
            </h1>
            <p class="text-muted">
                Node ID: {{ node.hex_id }} ({{ node.node_id }})
                • Last seen: {{ node.last_seen_relative }}
            </p>
        </div>
    </div>

    <!-- Overview Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card card-metric">
                <div class="card-body">
                    <div class="metric-value">{{ node.total_packets }}</div>
                    <div class="metric-label">Total Packets</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-metric">
                <div class="card-body">
                    <div class="metric-value">{{ node.unique_destinations or 0 }}</div>
                    <div class="metric-label">Destinations</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-metric">
                <div class="card-body">
                    <div class="metric-value">
                        {% if node.avg_rssi %}{{ node.avg_rssi|format_rssi }}{% else %}?{% endif %}
                    </div>
                    <div class="metric-label">Avg RSSI (dBm)</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-metric">
                <div class="card-body">
                    <div class="metric-value">
                        {% if node.avg_hops %}{{ node.avg_hops }}{% else %}?{% endif %}
                    </div>
                    <div class="metric-label">Avg Hops</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Node Information -->
        <div class="col-lg-8">
            <!-- Basic Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="bi bi-info-circle"></i> Node Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr>
                                    <th>Node Name:</th>
                                    <td><strong>{{ node.node_name }}</strong></td>
                                </tr>
                                <tr>
                                    <th>Node ID (Hex):</th>
                                    <td><code>{{ node.hex_id }}</code></td>
                                </tr>
                                <tr>
                                    <th>Node ID (Dec):</th>
                                    <td><code>{{ node.node_id }}</code></td>
                                </tr>
                                {% if node.hw_model %}
                                <tr>
                                    <th>Hardware Model:</th>
                                    <td>
                                        <div class="hw-model-container">
                                            <span>{{ node.hw_model }}</span>
                                            <img src="https://flasher.meshtastic.org/img/devices/{{ node.hw_model | replace('_', '-') | lower }}.svg"
                                                 alt="{{ node.hw_model }}"
                                                 class="hw-thumbnail"
                                                 onerror="this.src='https://flasher.meshtastic.org/img/devices/unknown.svg'"
                                                 loading="lazy">
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                                {% if node.role %}
                                <tr>
                                    <th>Role:</th>
                                    <td>{{ node.role }}</td>
                                </tr>
                                {% endif %}
                                {% if node.primary_channel %}
                                <tr>
                                    <th>Primary Channel:</th>
                                    <td>{{ node.primary_channel }}</td>
                                </tr>
                                {% endif %}
                                {% if node.mac_address %}
                                <tr>
                                    <th>MAC Address:</th>
                                    <td><code>{{ node.mac_address }}</code></td>
                                </tr>
                                {% endif %}
                                <tr>
                                    <th>First Seen:</th>
                                    <td>{{ node.first_seen }}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr>
                                    <th>Last Seen:</th>
                                    <td class="timestamp-display" data-timestamp="{{ node.last_seen_timestamp }}">{{ node.last_seen }}</td>
                                </tr>
                                <tr>
                                    <th>Avg Signal:</th>
                                    <td>
                                        {% if node.avg_rssi %}
                                            {% if node.avg_rssi >= -60 %}
                                                <span class="signal-indicator signal-excellent">{{ node.avg_rssi|format_rssi }} dBm</span>
                                            {% elif node.avg_rssi >= -70 %}
                                                                                <span class="signal-indicator signal-good">{{ node.avg_rssi|format_rssi }} dBm</span>
                            {% elif node.avg_rssi >= -80 %}
                                <span class="signal-indicator signal-fair">{{ node.avg_rssi|format_rssi }} dBm</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">Unknown</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Avg SNR:</th>
                                    <td>
                                        {% if node.avg_snr %}
                                            {% if node.avg_snr > 5 %}
                                                                                <span class="signal-indicator signal-excellent">{{ node.avg_snr|format_snr }} dB</span>
                            {% elif node.avg_snr > 0 %}
                                <span class="signal-indicator signal-good">{{ node.avg_snr|format_snr }} dB</span>
                            {% else %}
                                <span class="signal-indicator signal-poor">{{ node.avg_snr|format_snr }} dB</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">Unknown</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Firmware Version:</th>
                                    <td>
                                        <span class="text-muted">Not available</span>
                                        <i class="bi bi-info-circle text-muted ms-1"
                                           data-bs-toggle="tooltip"
                                           data-bs-placement="top"
                                           title="Firmware version information is not transmitted in standard nodeinfo packets. It would require admin access to query device metadata."></i>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Unique Gateways:</th>
                                    <td>{{ node.unique_gateways }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Location Information -->
            {% if location %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="bi bi-geo-alt"></i> Location Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr>
                                    <th>Latitude:</th>
                                    <td>{{ "%.6f"|format(location.latitude) }}°</td>
                                </tr>
                                <tr>
                                    <th>Longitude:</th>
                                    <td>{{ "%.6f"|format(location.longitude) }}°</td>
                                </tr>
                                {% if location.altitude %}
                                <tr>
                                    <th>Altitude:</th>
                                    <td>{{ location.altitude }} m</td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr>
                                    <th>Location Updated:</th>
                                    <td class="timestamp-display" data-timestamp="{{ location.timestamp_unix }}">{{ location.timestamp }}</td>
                                </tr>
                                <tr>
                                    <th>Time Ago:</th>
                                    <td>{{ location.timestamp_relative }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- Current Location Map -->
                    <div class="mt-3">
                        <div id="current-location-map" style="height: 300px; border: 1px solid #dee2e6; border-radius: 0.375rem; margin-bottom: 15px;"></div>
                        <a href="https://www.google.com/maps?q={{ location.latitude }},{{ location.longitude }}"
                           target="_blank" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-map"></i> View on Google Maps
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Telemetry Information - Comprehensive -->
            <div class="card mb-4" id="telemetry-card" style="display: none;">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="mb-1"><i class="bi bi-activity"></i> Telemetry & Health</h5>
                            <small class="text-muted">Complete device status and environmental data</small>
                        </div>
                        <small class="text-muted" id="telemetry-timestamp" style="font-size: 0.8rem;"></small>
                    </div>
                </div>
                <div class="card-body" id="telemetry-content">
                    <div class="d-flex align-items-center justify-content-center" style="min-height: 200px;">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status" style="width: 2rem; height: 2rem;">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3 text-muted">Loading telemetry data...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Location History Map -->
            <div class="card mb-4" id="location-history-card" style="display: none;">
                <div class="card-header">
                    <h5><i class="bi bi-map"></i> Location History Map</h5>
                    <small class="text-muted">Historical GPS coordinates sent by this node</small>
                </div>
                <div class="card-body">
                    <div id="location-history-map" style="height: 400px; border: 1px solid #dee2e6; border-radius: 0.375rem;">
                        <div class="d-flex align-items-center justify-content-center h-100">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">Loading location history...</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="row">
                            <div class="col-md-8">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i>
                                    Map shows historical GPS coordinates reported by this node.
                                    Recent locations are shown in <span class="text-success">green</span>,
                                    older locations in <span class="text-danger">red</span>.
                                    Click markers for details.
                                </small>
                            </div>
                            <div class="col-md-4 text-end">
                                <small class="text-muted" id="location-count">
                                    Loading location data...
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Direct Receptions Graph (Gateway only) -->
            {% include "components/direct_receptions.html" %}

            <!-- Relay Node Analysis (Gateway only) -->
            {% include "components/relay_node_analysis.html" %}

            <!-- Protocol Breakdown -->
            {% if protocols %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="bi bi-graph-up"></i> Protocol Usage</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Protocol</th>
                                    <th>Count</th>
                                    <th>Percentage</th>
                                    <th>Avg RSSI</th>
                                    <th>Avg SNR</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for protocol in protocols %}
                                <tr>
                                    <td>
                                        <span class="badge bg-secondary protocol-badge">{{ protocol.protocol }}</span>
                                    </td>
                                    <td>{{ protocol.count }}</td>
                                    <td>
                                        {% set percentage = (protocol.count / node.total_packets * 100) %}
                                        {% set percentage_str = "%.1f"|format(percentage) %}
                                        {{ percentage_str }}%
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar" data-width="{{ percentage_str }}"></div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if protocol.avg_rssi %}
                                            {{ protocol.avg_rssi|format_rssi }} dBm
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if protocol.avg_snr %}
                                            {{ protocol.avg_snr|format_snr }} dB
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Recent Packets (Sent / Reported) -->
            {% if recent_packets or recent_reported_packets %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="bi bi-clock-history"></i> Recent Packets</h5>
                </div>
                <div class="card-body">
                    <!-- Tab selector -->
                    <ul class="nav nav-tabs" id="recentPacketsTab" role="tablist">
                        {% if recent_packets %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="sent-tab" data-bs-toggle="tab" data-bs-target="#sent-tab-pane" type="button" role="tab">Sent</button>
                        </li>
                        {% endif %}
                        {% if recent_reported_packets %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link {% if not recent_packets %}active{% endif %}" id="reported-tab" data-bs-toggle="tab" data-bs-target="#reported-tab-pane" type="button" role="tab">Reported</button>
                        </li>
                        {% endif %}
                        {% if matrix_gateways and recent_packets %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="matrix-tab" data-bs-toggle="tab" data-bs-target="#matrix-tab-pane" type="button" role="tab">Reception Matrix</button>
                        </li>
                        {% endif %}
                    </ul>

                    <div class="tab-content mt-3">
                        {% if recent_packets %}
                        <div class="tab-pane fade show active" id="sent-tab-pane" role="tabpanel" aria-labelledby="sent-tab">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Protocol</th>
                                            <th>To Node</th>
                                            <th>Gateway</th>
                                            <th>RSSI</th>
                                            <th>SNR</th>
                                            <th>Hops</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for packet in recent_packets %}
                                        <tr>
                                            <td><small>{{ packet.timestamp_relative }}</small></td>
                                            <td>{{ protocol_badge(packet.protocol) }}</td>
                                            <td>
                                                {% if packet.to_node_id %}
                                                    {{ node_link(packet.to_node_id, packet.to_node_name) }}
                                                {% else %}
                                                    {{ packet.to_node_name or "Unknown" }}
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if packet.is_grouped %}
                                                    <span class="text-info">{{ packet.gateway_display }}</span>
                                                    {% if packet.gateway_list %}
                                                        <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip" title="Gateways: {{ packet.gateway_list|join(', ') }}"></i>
                                                    {% endif %}
                                                {% else %}
                                                    {% if packet.gateway_node_id %}
                                                        {{ node_link(packet.gateway_node_id, packet.gateway_name) }}
                                                    {% else %}
                                                        {{ packet.gateway_id or "Unknown" }}
                                                    {% endif %}
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if packet.rssi %}
                                                    {% if packet.is_grouped %}
                                                        <span class="text-info">{{ packet.rssi }}</span>
                                                    {% else %}
                                                        {{ packet.rssi }} dBm
                                                    {% endif %}
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if packet.snr %}
                                                    {% if packet.is_grouped %}
                                                        <span class="text-info">{{ packet.snr }}</span>
                                                    {% else %}
                                                        {{ packet.snr }} dB
                                                    {% endif %}
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if packet.hop_count is not none %}
                                                    {{ packet.hop_count }}
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="/packet/{{ packet.id }}" class="btn btn-sm btn-outline-primary">View</a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3">
                                <a href="/packets?from_node={{ node.node_id }}" class="btn btn-outline-primary">
                                    <i class="bi bi-box"></i> View All Packets from This Node
                                </a>
                            </div>
                        </div>
                        {% endif %}

                        {% if recent_reported_packets %}
                        <div class="tab-pane fade {% if not recent_packets %}show active{% endif %}" id="reported-tab-pane" role="tabpanel" aria-labelledby="reported-tab">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Protocol</th>
                                            <th>From Node</th>
                                            <th>To Node</th>
                                            <th>RSSI</th>
                                            <th>SNR</th>
                                            <th>Hops</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for packet in recent_reported_packets %}
                                        <tr>
                                            <td><small>{{ packet.timestamp_relative }}</small></td>
                                            <td>{{ protocol_badge(packet.protocol) }}</td>
                                            <td>
                                                {% if packet.from_node_id %}
                                                    {{ node_link(packet.from_node_id, packet.from_node_name) }}
                                                {% else %}
                                                    {{ packet.from_node_name or "Unknown" }}
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if packet.to_node_id %}
                                                    {{ node_link(packet.to_node_id, packet.to_node_name) }}
                                                {% else %}
                                                    {{ packet.to_node_name or "Unknown" }}
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if packet.rssi is not none %}
                                                    {{ packet.rssi }} dBm
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if packet.snr is not none %}
                                                    {{ packet.snr }} dB
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if packet.hop_count is not none %}
                                                    {{ packet.hop_count }}
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="/packet/{{ packet.id }}" class="btn btn-sm btn-outline-primary">View</a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3">
                                <a href="/packets?gateway_id={{ node.node_id }}&exclude_self=true" class="btn btn-outline-primary">
                                    <i class="bi bi-box"></i> View All Packets Reported by This Node
                                </a>
                            </div>
                        </div>
                        {% endif %}

                        {% if matrix_gateways and recent_packets %}
                        <div class="tab-pane fade" id="matrix-tab-pane" role="tabpanel" aria-labelledby="matrix-tab">
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered table-hover matrix-table">
                                    <thead>
                                        <tr>
                                            <th>Packet</th>
                                            {% for gw in matrix_gateways %}
                                                <th class="vertical-header">
                                                    {{ node_link(gw.gateway_id, gw.display_name, display_text=gw.short_name, additional_classes="text-white text-decoration-none fw-bold") }}
                                                </th>
                                            {% endfor %}
                                            <th>Count</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for packet in recent_packets %}
                                        {% set received_ids = packet.gateways_detailed | map(attribute='gateway_id') | list %}
                                        {% set received_count = received_ids | length %}
                                        <tr>
                                            <td>
                                                <a href="/packet/{{ packet.id }}" data-bs-toggle="tooltip" title="Sent {{ packet.timestamp_relative }}">
                                                    <code>{% if packet.mesh_packet_id %}{{ "%08x"|format(packet.mesh_packet_id|int) }}{% else %}{{ "%08x"|format(packet.id|int) }}{% endif %}</code>
                                                </a>
                                            </td>
                                            {% for gw in matrix_gateways %}
                                                {% set gw_entry = (packet.gateways_detailed | selectattr('gateway_id', 'equalto', gw.gateway_id) | list | first) %}
                                                {% if gw_entry %}
                                                    {% if gw_entry.hop_count == 0 %}
                                                        <td class="text-center">
                                                            <span class="text-success fw-bold" data-bs-toggle="tooltip" title="{% if gw_entry.rssi is not none %}RSSI: {{ gw_entry.rssi }} dBm {% endif %}{% if gw_entry.snr is not none %}SNR: {{ gw_entry.snr }} dB{% endif %}">0</span>
                                                        </td>
                                                    {% else %}
                                                        <td class="text-center">{{ gw_entry.hop_count }}</td>
                                                    {% endif %}
                                                {% else %}
                                                    <td class="text-muted text-center">-</td>
                                                {% endif %}
                                            {% endfor %}
                                            <td>{{ received_count }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Neighbors & Analytics -->
        <div class="col-lg-4">
            <!-- Received Gateways -->
            {% if received_gateways %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="bi bi-broadcast"></i> Received Gateways</h5>
                    <small class="text-muted">Gateways that have received packets from this node</small>
                </div>
                <div class="card-body">
                    {% for gateway in received_gateways %}
                    <div class="neighbor-card card">
                        <div class="card-body p-2">
                            <h6 class="card-title mb-1">
                                {% if gateway.gateway_node_id %}
                                    {{ node_link(gateway.gateway_node_id, gateway.display_name) }}
                                {% else %}
                                    {{ gateway.display_name }}
                                {% endif %}
                                {% if gateway.is_direct %}
                                    <span class="badge bg-success ms-1" title="Direct connection (0 hops)">Direct</span>
                                {% endif %}
                            </h6>
                            <div class="row">
                                <div class="col-6">
                                    <small><strong>Packets:</strong> {{ gateway.packet_count }}</small>
                                </div>
                                <div class="col-6">
                                    <small><strong>Hops:</strong> {{ gateway.hop_display }}</small>
                                </div>
                            </div>
                            <div class="row mt-1">
                                <div class="col-6">
                                    <small><strong>Last:</strong> {{ gateway.last_received_relative }}</small>
                                </div>
                                <div class="col-6">
                                    {% if gateway.is_direct and gateway.direct_packet_count > 0 %}
                                        <small><strong>Direct:</strong> {{ gateway.direct_packet_count }} pkts</small>
                                    {% endif %}
                                </div>
                            </div>
                            {% if gateway.avg_rssi or gateway.avg_snr %}
                            <div class="row mt-1">
                                <div class="col-6">
                                    {% if gateway.avg_rssi %}
                                        <small><strong>RSSI:</strong> {{ gateway.avg_rssi }} dBm</small>
                                        {% if gateway.is_direct %}
                                            <i class="bi bi-info-circle text-muted"
                                               data-bs-toggle="tooltip"
                                               title="Signal strength for direct connections (0 hops)"></i>
                                        {% endif %}
                                    {% endif %}
                                </div>
                                <div class="col-6">
                                    {% if gateway.avg_snr %}
                                        <small><strong>SNR:</strong> {{ gateway.avg_snr }} dB</small>
                                        {% if gateway.is_direct %}
                                            <i class="bi bi-info-circle text-muted"
                                               data-bs-toggle="tooltip"
                                               title="Signal quality for direct connections (0 hops)"></i>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-lightning"></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="/packets?from_node={{ node.node_id }}" class="btn btn-outline-primary">
                            <i class="bi bi-box"></i> View All Packets
                        </a>
                        {% if location %}
                        <a href="/map?highlight={{ node.node_id }}" class="btn btn-outline-info">
                            <i class="bi bi-map"></i> View on Map
                        </a>
                        {% endif %}
                        <a href="/traceroute?from_node={{ node.node_id }}" class="btn btn-outline-warning">
                            <i class="bi bi-route"></i> View Traceroutes
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Direct Receptions Chart Component -->
<script src="{{ url_for('static', filename='js/direct_receptions.js') }}"></script>

<!-- Relay Node Analysis Component -->
<script src="{{ url_for('static', filename='js/relay_node_analysis.js') }}"></script>

<!-- Location data for JavaScript -->
{% if location %}
<script id="location-data" type="application/json">
{
    "latitude": {{ location.latitude }},
    "longitude": {{ location.longitude }},
    {% if location.altitude %}"altitude": {{ location.altitude }},{% endif %}
    "timestamp": "{{ location.timestamp }}",
    "timestamp_relative": "{{ location.timestamp_relative }}",
    "node_name": "{{ node.node_name }}"
}
</script>
{% endif %}

<script data-node-id="{{ node.node_id }}">
document.addEventListener('DOMContentLoaded', function() {
    // Set progress bar widths from data attributes
    document.querySelectorAll('.progress-bar[data-width]').forEach(function(bar) {
        const width = bar.getAttribute('data-width');
        bar.style.width = width + '%';
    });

    // Load current location map if location data exists
    loadCurrentLocationMap();

    // Load location history map
    loadLocationHistoryMap();
});

function loadCurrentLocationMap() {
    const currentLocationContainer = document.getElementById('current-location-map');
    if (!currentLocationContainer) {
        return; // No current location data available
    }

    // Get location data from the JSON script tag
    const locationDataScript = document.getElementById('location-data');
    if (!locationDataScript) {
        return; // No location data available
    }

    const currentLocation = JSON.parse(locationDataScript.textContent);

    // Initialize map centered on current location
    const currentMap = L.map('current-location-map').setView([
        currentLocation.latitude,
        currentLocation.longitude
    ], 15);

    // Add OpenStreetMap tiles
    // Add theme-appropriate tile layer
    const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
    const tileUrl = isDark
        ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
        : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';

    L.tileLayer(tileUrl, {
        attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors © <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 20
    }).addTo(currentMap);

    // Add marker for current location
    const marker = L.marker([currentLocation.latitude, currentLocation.longitude]).addTo(currentMap);

    // Create popup content
    const popupContent = `
        <div>
            <strong>${currentLocation.node_name}</strong><br>
            <strong>Current Location</strong><br>
            <strong>Coordinates:</strong> ${currentLocation.latitude.toFixed(6)}, ${currentLocation.longitude.toFixed(6)}<br>
            ${currentLocation.altitude ? `<strong>Altitude:</strong> ${currentLocation.altitude}m<br>` : ''}
            <strong>Updated:</strong> ${currentLocation.timestamp_relative}<br>
            <small><strong>Recorded:</strong> ${currentLocation.timestamp}</small>
        </div>
    `;
    marker.bindPopup(popupContent).openPopup();
}

async function loadLocationHistoryMap() {
    const scriptTag = document.querySelector('script[data-node-id]');
    const nodeId = scriptTag.getAttribute('data-node-id');
    const mapContainer = document.getElementById('location-history-map');
    const cardContainer = document.getElementById('location-history-card');
    const locationCount = document.getElementById('location-count');

    try {
        // Fetch location history data
        const response = await fetch(`/api/node/${nodeId}/location-history?limit=100`);
        const data = await response.json();

        if (data.error) {
            throw new Error(data.error);
        }

        if (!data.location_history || data.location_history.length === 0) {
            // No location data available, hide the card
            return;
        }

        // Show the card now that we have data
        cardContainer.style.display = 'block';

        // Clear loading content
        mapContainer.innerHTML = '';

        // Initialize map centered on the most recent location
        const mostRecentLocation = data.location_history[0];
        const map = L.map('location-history-map').setView([
            mostRecentLocation.latitude,
            mostRecentLocation.longitude
        ], 13);

        // Add OpenStreetMap tiles
        // Add theme-appropriate tile layer
        const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
        const tileUrl = isDark
            ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
            : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';

        L.tileLayer(tileUrl, {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors © <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        // Calculate age-based colors and add markers
        const now = Date.now() / 1000; // Current time in seconds
        const oldestTime = Math.min(...data.location_history.map(loc => loc.timestamp));
        const newestTime = Math.max(...data.location_history.map(loc => loc.timestamp));
        const timeRange = newestTime - oldestTime;

        const pathCoords = [];

        data.location_history.forEach((location, index) => {
            // Calculate age-based color (green for recent, red for old)
            const age = (now - location.timestamp) / 3600; // Age in hours
            let markerColor;
            let radius = 6;

            if (age < 1) {
                markerColor = '#28a745'; // Green for < 1 hour
                radius = 8;
            } else if (age < 24) {
                markerColor = '#ffc107'; // Yellow for < 24 hours
                radius = 7;
            } else if (age < 168) { // 1 week
                markerColor = '#fd7e14'; // Orange for < 1 week
                radius = 6;
            } else {
                markerColor = '#dc3545'; // Red for > 1 week
                radius = 5;
            }

            // Create circle marker
            const marker = L.circleMarker([location.latitude, location.longitude], {
                radius: radius,
                fillColor: markerColor,
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map);

            // Create popup content
            // Format timestamp using timezone preference
            const formattedTime = typeof formatTimestamp === 'function'
                ? formatTimestamp(location.timestamp)
                : location.timestamp_str;

            const popupContent = `
                <div>
                    <strong>Location #${data.location_history.length - index}</strong><br>
                    <small class="text-muted">${formattedTime}</small><br>
                    <strong>Coordinates:</strong> ${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}<br>
                    ${location.altitude ? `<strong>Altitude:</strong> ${location.altitude}m<br>` : ''}
                </div>
            `;
            marker.bindPopup(popupContent);

            // Add to path coordinates (in chronological order for path)
            pathCoords.unshift([location.latitude, location.longitude]);
        });

        // Draw path line if we have multiple points
        if (pathCoords.length > 1) {
            L.polyline(pathCoords, {
                color: '#007bff',
                weight: 2,
                opacity: 0.6,
                dashArray: '5, 5' // Dashed line to show movement path
            }).addTo(map);
        }

        // Fit map to show all markers
        if (data.location_history.length > 1) {
            const bounds = L.latLngBounds(data.location_history.map(loc => [loc.latitude, loc.longitude]));
            map.fitBounds(bounds, { padding: [20, 20] });
        }

        // Update location count
        locationCount.textContent = `${data.location_history.length} location points found`;

    } catch (error) {
        console.error('Error loading location history:', error);

        // Show error in map container
        mapContainer.innerHTML = `
            <div class="d-flex align-items-center justify-content-center h-100">
                <div class="text-center text-danger">
                    <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
                    <div class="mt-2">Error loading location history</div>
                    <div class="small">${error.message}</div>
                </div>
            </div>
        `;

        // Still show the card even on error so users can see what went wrong
        cardContainer.style.display = 'block';
        locationCount.textContent = 'Error loading location data';
    }
}

// ========================= Direct Receptions Chart =========================
// Initialize Direct Receptions Chart Component
let directReceptionsChart;

document.addEventListener('DOMContentLoaded', function() {
    const scriptTag = document.querySelector('script[data-node-id]');
    const nodeId = scriptTag.getAttribute('data-node-id');

    if (nodeId && window.DirectReceptionsChart) {
        directReceptionsChart = new DirectReceptionsChart(nodeId);
        directReceptionsChart.initialize();
    }

    // Format all timestamps based on current timezone preference
    // This ensures timestamps on the detail page respect the timezone setting
    if (typeof updateAllTimestamps === 'function') {
        updateAllTimestamps();
    }

    // Load telemetry data
    loadTelemetryData();

    // Load health warnings
    loadHealthWarnings();
});

async function loadHealthWarnings() {
    const scriptTag = document.querySelector('script[data-node-id]');
    const nodeId = scriptTag.getAttribute('data-node-id');
    const warningsContainer = document.getElementById('health-warnings-container');
    const warningsContent = document.getElementById('health-warnings-content');

    try {
        const response = await fetch(`/api/health/node/${nodeId}?hours=24`);
        const data = await response.json();

        if (data.error) {
            // Error fetching health data - show error message
            warningsContainer.style.display = 'block';
            warningsContent.innerHTML = `<div class="alert alert-warning mb-0"><small>${data.error}</small></div>`;
            return;
        }

        // Always show the health status, even if no warnings
        warningsContainer.style.display = 'block';

        // Build warnings HTML
        let html = '';

        // Show issues if any exist
        if (data.issues && data.issues.length > 0) {
            // Filter out info-level issues, show only warnings and critical
            const importantIssues = data.issues.filter(i => i.severity !== 'info');

            if (importantIssues.length > 0) {
                html += '<div class="list-group list-group-flush mb-2">';
                for (const issue of importantIssues) {
                    const severityClass = issue.severity === 'critical' ? 'danger' : 'warning';
                    const severityIcon = issue.severity === 'critical' ? 'exclamation-circle-fill' : 'exclamation-triangle-fill';

                    html += `<div class="list-group-item list-group-item-${severityClass} p-2">`;
                    html += `<small><i class="bi bi-${severityIcon}"></i> ${issue.message}</small>`;
                    html += '</div>';
                }
                html += '</div>';
            }
        }

        // Always show health score and confidence
        if (data.health_score !== undefined) {
            const scoreClass = data.health_status === 'healthy' ? 'success' :
                              data.health_status === 'degraded' ? 'warning' :
                              data.health_status === 'poor' ? 'danger' : 'dark';

            const confidenceClass = data.confidence_score >= 80 ? 'success' :
                                   data.confidence_score >= 60 ? 'warning' : 'danger';

            html += `<div class="text-center">`;
            html += `<span class="badge bg-${scoreClass}">Health: ${data.health_score}/100</span>`;
            html += ` <span class="badge bg-${confidenceClass}" data-bs-toggle="tooltip"
                            title="Confidence in health assessment. Based on: ${data.confidence_factors ? data.confidence_factors.join('; ') : 'Available data'}">
                        Confidence: ${data.confidence_score}%</span>`;
            html += '</div>';
        }

        // Add baseline info if available
        if (data.baseline && data.baseline.has_baseline) {
            html += `<div class="mt-2"><small class="text-muted">`;
            html += `<i class="bi bi-graph-up"></i> Baseline: ${data.baseline.avg_packets_per_day.toFixed(1)} packets/day `;
            html += `(${data.baseline.total_days.toFixed(0)} days, ${data.baseline.total_packets} packets)`;
            html += '</small></div>';
        }

        warningsContent.innerHTML = html;

        // Reinitialize tooltips
        const tooltipTriggerList = warningsContent.querySelectorAll('[data-bs-toggle="tooltip"]');
        [...tooltipTriggerList].forEach(tooltipTriggerEl => {
            if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
                new bootstrap.Tooltip(tooltipTriggerEl);
            }
        });

    } catch (error) {
        console.error('Error loading health warnings:', error);
    }
}

async function loadTelemetryData() {
    const scriptTag = document.querySelector('script[data-node-id]');
    const nodeId = scriptTag.getAttribute('data-node-id');
    const telemetryCard = document.getElementById('telemetry-card');
    const telemetryContent = document.getElementById('telemetry-content');

    try {
        // Fetch both current telemetry and history data
        const [telemetryResponse, historyResponse] = await Promise.all([
            fetch(`/api/node/${nodeId}/telemetry`),
            fetch(`/api/node/${nodeId}/telemetry/history`)
        ]);

        const data = await telemetryResponse.json();
        const historyData = await historyResponse.json();

        if (data.error) {
            throw new Error(data.error);
        }

        const telemetry = data.telemetry;
        const history = historyData.history || {};

        if (!telemetry) {
            // No telemetry data available, hide the card
            return;
        }

        // Show the card now that we have data
        telemetryCard.style.display = 'block';

        // Build comprehensive telemetry HTML
        let html = '';

        // Fetch comprehensive health data from the health API
        let nodeHealth = {};
        try {
            const healthResponse = await fetch(`/api/health/node/${nodeId}?hours=24`);
            if (healthResponse.ok) {
                const healthData = await healthResponse.json();
                nodeHealth = healthData;
            }
        } catch (error) {
            console.debug('Could not load health data:', error);
        }

        // Use health data from API
        let healthScore = nodeHealth.health_score !== undefined ? nodeHealth.health_score : 100;
        let healthStatus = nodeHealth.health_status || 'unknown';
        let issues = nodeHealth.issues || [];
        let metrics = nodeHealth.metrics || {};
        let confidenceScore = nodeHealth.confidence_score !== undefined ? nodeHealth.confidence_score : 100;
        let baseline = nodeHealth.baseline || {};

        // Fallback to telemetry-based health if API data unavailable
        if (healthScore === 100 && telemetry.device_metrics) {
            const dm = telemetry.device_metrics;

            // Evaluate battery
            if (dm.battery_level !== undefined) {
                if (dm.battery_level < 20) {
                    healthScore -= 30;
                } else if (dm.battery_level < 50) {
                    healthScore -= 15;
                }
            }

            // Evaluate channel utilization
            if (dm.channel_utilization !== undefined && dm.channel_utilization > 80) {
                healthScore -= 15;
            }
        }

        // Determine health color
        let healthColor = 'success';
        let healthStatusText = 'Healthy';
        if (healthScore >= 80) {
            healthColor = 'success';
            healthStatusText = 'Healthy';
        } else if (healthScore >= 60) {
            healthColor = 'warning';
            healthStatusText = 'Degraded';
        } else if (healthScore >= 40) {
            healthColor = 'danger';
            healthStatusText = 'Poor';
        } else {
            healthColor = 'danger';
            healthStatusText = 'Critical';
        }

        // Build health alerts from issues
        let healthAlerts = [];
        let detailedIssues = [];
        issues.forEach(issue => {
            // Create badge for quick view
            let badgeClass = 'bg-info text-dark';
            if (issue.severity === 'critical') {
                badgeClass = 'bg-danger';
            } else if (issue.severity === 'warning') {
                badgeClass = 'bg-warning text-dark';
            }

            // Format issue with category if available
            let issueText = issue.message;
            if (issue.category) {
                issueText = issue.category + ': ' + issue.message;
            }

            healthAlerts.push('<span class="badge ' + badgeClass + '">' + issueText + '</span>');

            // Store detailed issues for display
            detailedIssues.push({
                severity: issue.severity,
                category: issue.category || 'Other',
                message: issue.message,
                outage_details: issue.outage_details || []
            });
        });

        // Health Summary Row
        html += '<div class="row mb-3 pb-3 border-bottom">';
        html += '<div class="col-12">';
        html += '<div class="d-flex justify-content-between align-items-start mb-2">';
        html += '<div>';
        html += '<h5 class="mb-1"><i class="bi bi-heart-pulse text-' + healthColor + '"></i> <strong>Health: <span class="text-' + healthColor + '">' + healthStatusText + ' (' + Math.round(healthScore) + '/100)</span></strong></h5>';
        html += '<small class="text-muted">Confidence: <span class="badge bg-secondary">' + Math.round(confidenceScore) + '%</span></small>';
        html += '</div>';
        html += '<small class="text-muted text-end" id="telemetry-timestamp-small"></small>';
        html += '</div>';

        if (healthAlerts.length > 0) {
            html += '<div class="d-flex flex-wrap gap-2 mt-2">' + healthAlerts.join('') + '</div>';

            // Show detailed outage information if available
            detailedIssues.forEach(issue => {
                if (issue.outage_details && issue.outage_details.length > 0) {
                    html += '<div class="mt-2 small alert alert-warning mb-0">';
                    html += '<strong>' + issue.category + ' Details:</strong><ul class="mt-1 mb-0">';
                    issue.outage_details.forEach(outage => {
                        html += '<li>' + outage.duration_formatted + ' - ' + outage.start_time + ' to ' + outage.end_time + '</li>';
                    });
                    html += '</ul></div>';
                }
            });
        } else if (issues.length === 0) {
            html += '<small class="text-success"><i class="bi bi-check-circle"></i> No issues detected</small>';
        }

        // Show metrics summary if available
        if (metrics.total_packets !== undefined) {
            html += '<div class="mt-2 pt-2 border-top" style="font-size: 0.85rem;">';
            html += '<small class="text-muted">24h Metrics: ';
            html += '<strong>' + metrics.total_packets + ' packets</strong>';
            if (metrics.avg_rssi !== undefined && metrics.avg_rssi !== null) {
                html += ' • RSSI: <strong>' + metrics.avg_rssi.toFixed(1) + ' dBm</strong>';
            }
            if (metrics.avg_snr !== undefined && metrics.avg_snr !== null) {
                html += ' • SNR: <strong>' + metrics.avg_snr.toFixed(1) + ' dB</strong>';
            }
            if (metrics.unique_gateways !== undefined) {
                html += ' • <strong>' + metrics.unique_gateways + ' gateway(s)</strong>';
            }
            if (metrics.activity_gaps !== undefined && metrics.activity_gaps > 0) {
                html += ' • <strong>' + metrics.activity_gaps + ' activity gap(s)</strong>';
            }
            if (metrics.long_outages !== undefined && metrics.long_outages > 0) {
                html += ' • <span class="text-warning"><strong>' + metrics.long_outages + ' outage(s)</strong></span>';
            }
            html += '</small>';
            html += '</div>';
        }

        // Show baseline information if available
        if (baseline && baseline.has_baseline) {
            const variabilityText = baseline.coefficient_of_variation > 1.5 ? 'highly variable' :
                                   baseline.coefficient_of_variation > 1.0 ? 'moderately variable' : 'consistent';
            html += '<div class="mt-2 pt-2 border-top small alert alert-info mb-0" style="font-size: 0.85rem;">';
            html += '<strong>Baseline Behavior:</strong> ';
            html += 'Avg ' + baseline.avg_packets_per_day.toFixed(1) + ' packets/day • ';
            html += baseline.total_packets + ' packets over ' + Math.round(baseline.total_days) + ' days • ';
            html += variabilityText + ' pattern';
            html += '</div>';
        }

        html += '</div>';
        html += '</div>';

        // Main Telemetry Grid
        html += '<div class="row g-3">';

        // Power & Battery Section
        html += '<div class="col-lg-6">';
        html += '<h6 class="text-secondary mb-2"><i class="bi bi-battery-charging"></i> Power & Battery</h6>';
        html += '<div class="table-responsive">';

        html += '<table class="table table-sm table-borderless mb-0" style="font-size: 0.9rem;">';

        if (telemetry.device_metrics) {
            const dm = telemetry.device_metrics;

            if (dm.battery_level !== undefined) {
                const batteryClass = dm.battery_level > 80 ? 'text-success' : dm.battery_level > 20 ? 'text-warning' : 'text-danger';
                html += '<tr>';
                html += '<td class="text-muted" style="width: 50%;">Battery Level</td>';
                html += '<td class="text-end"><span class="' + batteryClass + ' fw-bold">' + dm.battery_level + '%</span> <span id="spark-battery_level"></span></td>';
                html += '</tr>';
            }

            if (dm.voltage !== undefined && dm.voltage > 0) {
                html += '<tr>';
                html += '<td class="text-muted">Voltage</td>';
                html += '<td class="text-end fw-bold">' + dm.voltage.toFixed(2) + ' V <span id="spark-voltage"></span></td>';
                html += '</tr>';
            }

            if (dm.uptime_seconds !== undefined) {
                const uptime = formatUptime(dm.uptime_seconds);
                html += '<tr>';
                html += '<td class="text-muted">Uptime</td>';
                html += '<td class="text-end fw-bold">' + uptime + '</td>';
                html += '</tr>';
            }
        }

        html += '</table>';
        html += '</div>';
        html += '</div>';

        // Network & Channel Section
        html += '<div class="col-lg-6">';
        html += '<h6 class="text-secondary mb-2"><i class="bi bi-wifi"></i> Network & Radio</h6>';
        html += '<div class="table-responsive">';
        html += '<table class="table table-sm table-borderless mb-0" style="font-size: 0.9rem;">';

        if (telemetry.device_metrics) {
            const dm = telemetry.device_metrics;

            if (dm.channel_utilization !== undefined) {
                const chanClass = dm.channel_utilization > 80 ? 'text-danger' : dm.channel_utilization > 50 ? 'text-warning' : 'text-success';
                html += '<tr>';
                html += '<td class="text-muted" style="width: 50%;">Channel Util</td>';
                html += '<td class="text-end"><span class="' + chanClass + ' fw-bold">' + dm.channel_utilization.toFixed(1) + '%</span> <span id="spark-channel_utilization"></span></td>';
                html += '</tr>';
            }

            if (dm.air_util_tx !== undefined) {
                html += '<tr>';
                html += '<td class="text-muted">Air Util TX</td>';
                html += '<td class="text-end fw-bold">' + dm.air_util_tx.toFixed(1) + '% <span id="spark-air_util_tx"></span></td>';
                html += '</tr>';
            }
        }

        html += '</table>';
        html += '</div>';
        html += '</div>';

        // Environment Section
        if (telemetry.environment_metrics) {
            const em = telemetry.environment_metrics;
            html += '<div class="col-lg-6">';
            html += '<h6 class="text-secondary mb-2"><i class="bi bi-cloud"></i> Environment</h6>';
            html += '<div class="table-responsive">';
            html += '<table class="table table-sm table-borderless mb-0" style="font-size: 0.9rem;">';

            if (em.temperature !== undefined) {
                html += '<tr>';
                html += '<td class="text-muted" style="width: 50%;">Temperature</td>';
                // Use TemperatureToggle.formatTemperature to respect user preference, fallback to Celsius
                let tempDisplay = em.temperature.toFixed(1) + ' °C';
                if (typeof TemperatureToggle !== 'undefined' && TemperatureToggle.formatTemperature) {
                    tempDisplay = TemperatureToggle.formatTemperature(em.temperature, 1);
                }
                html += '<td class="text-end fw-bold"><span class="temperature-display" data-temperature-celsius="' + em.temperature + '">' + tempDisplay + '</span> <span id="spark-temperature"></span></td>';
                html += '</tr>';
            }

            if (em.relative_humidity !== undefined) {
                html += '<tr>';
                html += '<td class="text-muted">Humidity</td>';
                html += '<td class="text-end fw-bold">' + em.relative_humidity.toFixed(1) + '% <span id="spark-relative_humidity"></span></td>';
                html += '</tr>';
            }

            if (em.barometric_pressure !== undefined) {
                html += '<tr>';
                html += '<td class="text-muted">Pressure</td>';
                html += '<td class="text-end fw-bold">' + em.barometric_pressure.toFixed(1) + ' hPa <span id="spark-barometric_pressure"></span></td>';
                html += '</tr>';
            }

            if (em.gas_resistance !== undefined) {
                html += '<tr>';
                html += '<td class="text-muted">Gas Resistance</td>';
                html += '<td class="text-end fw-bold">' + em.gas_resistance.toFixed(0) + ' Ω</td>';
                html += '</tr>';
            }

            html += '</table>';
            html += '</div>';
            html += '</div>';
        }

        // Power Metrics Section
        if (telemetry.power_metrics) {
            const pm = telemetry.power_metrics;
            html += '<div class="col-lg-6">';
            html += '<h6 class="text-secondary mb-2"><i class="bi bi-lightning-charge"></i> Power Metrics</h6>';
            html += '<div class="table-responsive">';
            html += '<table class="table table-sm table-borderless mb-0" style="font-size: 0.9rem;">';

            if (pm.ch1_voltage !== undefined) {
                html += '<tr>';
                html += '<td class="text-muted" style="width: 50%;">CH1 Voltage</td>';
                html += '<td class="text-end fw-bold">' + pm.ch1_voltage.toFixed(2) + ' V</td>';
                html += '</tr>';
            }
            if (pm.ch1_current !== undefined) {
                html += '<tr>';
                html += '<td class="text-muted">CH1 Current</td>';
                html += '<td class="text-end fw-bold">' + pm.ch1_current.toFixed(2) + ' mA</td>';
                html += '</tr>';
            }
            if (pm.ch2_voltage !== undefined) {
                html += '<tr>';
                html += '<td class="text-muted">CH2 Voltage</td>';
                html += '<td class="text-end fw-bold">' + pm.ch2_voltage.toFixed(2) + ' V</td>';
                html += '</tr>';
            }
            if (pm.ch2_current !== undefined) {
                html += '<tr>';
                html += '<td class="text-muted">CH2 Current</td>';
                html += '<td class="text-end fw-bold">' + pm.ch2_current.toFixed(2) + ' mA</td>';
                html += '</tr>';
            }
            if (pm.ch3_voltage !== undefined) {
                html += '<tr>';
                html += '<td class="text-muted">CH3 Voltage</td>';
                html += '<td class="text-end fw-bold">' + pm.ch3_voltage.toFixed(2) + ' V</td>';
                html += '</tr>';
            }
            if (pm.ch3_current !== undefined) {
                html += '<tr>';
                html += '<td class="text-muted">CH3 Current</td>';
                html += '<td class="text-end fw-bold">' + pm.ch3_current.toFixed(2) + ' mA</td>';
                html += '</tr>';
            }

            html += '</table>';
            html += '</div>';
            html += '</div>';
        }

        // Air Quality Section
        if (telemetry.air_quality_metrics) {
            const aq = telemetry.air_quality_metrics;
            html += '<div class="col-lg-6">';
            html += '<h6 class="text-secondary mb-2"><i class="bi bi-wind"></i> Air Quality</h6>';
            html += '<div class="table-responsive">';
            html += '<table class="table table-sm table-borderless mb-0" style="font-size: 0.9rem;">';

            if (aq.pm10_standard !== undefined) {
                html += '<tr>';
                html += '<td class="text-muted" style="width: 50%;">PM1.0</td>';
                html += '<td class="text-end fw-bold">' + aq.pm10_standard + ' µg/m³</td>';
                html += '</tr>';
            }
            if (aq.pm25_standard !== undefined) {
                html += '<tr>';
                html += '<td class="text-muted">PM2.5</td>';
                html += '<td class="text-end fw-bold">' + aq.pm25_standard + ' µg/m³</td>';
                html += '</tr>';
            }
            if (aq.pm100_standard !== undefined) {
                html += '<tr>';
                html += '<td class="text-muted">PM10</td>';
                html += '<td class="text-end fw-bold">' + aq.pm100_standard + ' µg/m³</td>';
                html += '</tr>';
            }

            html += '</table>';
            html += '</div>';
            html += '</div>';
        }

        html += '</div>';

        // Update content
        telemetryContent.innerHTML = html;

        // Update timestamp
        if (telemetry.timestamp_relative) {
            document.getElementById('telemetry-timestamp').textContent = telemetry.timestamp_relative;
            document.getElementById('telemetry-timestamp-small').textContent = telemetry.timestamp;
        }

        // Render sparklines for metrics with history data
        renderSparklines(history);

        // Update timestamps if the function is available
        if (typeof updateAllTimestamps === 'function') {
            updateAllTimestamps();
        }

    } catch (error) {
        console.error('Error loading telemetry data:', error);

        // Show error in content
        telemetryContent.innerHTML = `
            <div class="text-center text-muted">
                <i class="bi bi-info-circle" style="font-size: 2rem;"></i>
                <div class="mt-2">No telemetry data available</div>
                <div class="small">${error.message || 'This node has not sent any telemetry packets yet.'}</div>
            </div>
        `;
    }
}

function renderSparklines(history) {
    // Define sparkline configurations for each metric
    const sparklineConfigs = {
        'battery_level': { color: '#28a745', suffix: '%', min: 0, max: 100 },
        'voltage': { color: '#ffc107', suffix: 'V', min: 0 },
        'channel_utilization': { color: '#17a2b8', suffix: '%', min: 0, max: 100 },
        'air_util_tx': { color: '#6c757d', suffix: '%', min: 0, max: 100 },
        'temperature': { color: '#dc3545', suffix: '', isTemperature: true },
        'relative_humidity': { color: '#007bff', suffix: '%', min: 0, max: 100 },
        'barometric_pressure': { color: '#6610f2', suffix: 'hPa' }
    };

    // Render each sparkline
    Object.keys(sparklineConfigs).forEach(metricName => {
        const container = document.getElementById(`spark-${metricName}`);
        if (container && history[metricName] && history[metricName].length > 1) {
            const config = sparklineConfigs[metricName];
            renderSparkline(container, history[metricName], config);
        }
    });
}

function renderSparkline(container, data, config) {
    const width = 100;
    const height = 20;
    const color = config.color || '#007bff';

    // Determine temperature suffix at runtime if this is a temperature metric
    let suffix = config.suffix;
    if (config.isTemperature) {
        // Get temperature unit - check if TemperatureToggle is available
        const unit = (typeof TemperatureToggle !== 'undefined' && TemperatureToggle.getUnit)
            ? TemperatureToggle.getUnit()
            : 'C';
        suffix = unit === 'F' ? '°F' : '°C';
    }

    // Convert temperature data if needed
    let processedData = data;
    if (config.isTemperature && typeof TemperatureToggle !== 'undefined' && TemperatureToggle.celsiusToFahrenheit) {
        const unit = TemperatureToggle.getUnit();
        if (unit === 'F') {
            processedData = data.map(d => ({
                x: d.x,
                y: TemperatureToggle.celsiusToFahrenheit(d.y)
            }));
        }
    }

    // Extract y values
    const values = processedData.map(d => d.y);
    const minVal = config.min !== undefined ? config.min : Math.min(...values);
    const maxVal = config.max !== undefined ? config.max : Math.max(...values);
    const range = maxVal - minVal || 1;

    // Create SVG points for the line
    const points = processedData.map((d, i) => {
        const x = (i / (processedData.length - 1)) * width;
        const y = height - ((d.y - minVal) / range) * height;
        return `${x},${y}`;
    }).join(' ');

    // Create tooltip with trend info
    const lastValue = values[values.length - 1];
    const firstValue = values[0];
    const trend = lastValue > firstValue ? '↗' : lastValue < firstValue ? '↘' : '→';
    const trendColor = lastValue > firstValue ? '#28a745' : lastValue < firstValue ? '#dc3545' : '#6c757d';

    container.innerHTML = `
        <svg width="${width}" height="${height}" style="vertical-align: middle;">
            <polyline
                fill="none"
                stroke="${color}"
                stroke-width="1.5"
                points="${points}"
            />
        </svg>
        <span style="color: ${trendColor}; font-size: 12px; margin-left: 4px;" title="24h trend">${trend}</span>
    `;
}

function formatUptime(seconds) {
    const days = Math.floor(seconds / 86400);
    const hours = Math.floor((seconds % 86400) / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);

    let parts = [];
    if (days > 0) parts.push(days + 'd');
    if (hours > 0) parts.push(hours + 'h');
    if (minutes > 0) parts.push(minutes + 'm');

    return parts.join(' ') || '0m';
}

// Listen for temperature unit changes and re-render telemetry
document.addEventListener('temperatureUnitChanged', function() {
    loadTelemetryData();
});
</script>
{% endblock %}
