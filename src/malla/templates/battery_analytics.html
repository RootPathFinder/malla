{% extends "base.html" %}

{% block title %}Battery Analytics - {{ APP_NAME }}{% endblock %}

{% block styles %}
<style>
    /* Solar cloud indicator styling */
    .solar-clouds {
        display: inline-flex;
        align-items: center;
        margin-left: 4px;
        cursor: help;
    }
    .solar-clouds i {
        font-size: 0.75rem;
        margin-left: -2px;
    }
    .solar-clouds i:first-child {
        margin-left: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    {% if error_message %}
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle"></i>
        <strong>Notice:</strong> {{ error_message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="h2">
                <i class="bi bi-battery-charging"></i> Battery &amp; Power Analytics
            </h1>
        </div>
        <div class="col-md-4 text-end">
            <div class="text-muted">
                <i class="bi bi-info-circle"></i> Auto-updates every 10 minutes
                <span id="last-update-time" class="ms-2"></span>
            </div>
        </div>
    </div>

    <!-- Power Type Detection Status -->
    <div class="row mb-3">
        <div class="col">
            <div id="power-detection-status" class="alert alert-info" role="alert" style="display: none;">
                <i class="bi bi-info-circle"></i>
                <span id="power-detection-message">Analyzing power types...</span>
            </div>
        </div>
    </div>

    <!-- Power Source Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body card-metric">
                    <div class="metric-value text-warning">{{ power_summary.solar }}</div>
                    <div class="metric-label">
                        <i class="bi bi-sun-fill"></i> Solar Nodes
                    </div>
                    <small class="text-muted">Renewable powered</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body card-metric">
                    <div class="metric-value text-info">{{ power_summary.battery }}</div>
                    <div class="metric-label">
                        <i class="bi bi-battery-half"></i> Battery Nodes
                    </div>
                    <small class="text-muted">Battery only</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body card-metric">
                    <div class="metric-value text-success">{{ power_summary.mains }}</div>
                    <div class="metric-label">
                        <i class="bi bi-plug-fill"></i> Mains Powered
                    </div>
                    <small class="text-muted">Constant power</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body card-metric">
                    <div class="metric-value text-secondary">{{ power_summary.unknown }}</div>
                    <div class="metric-label">
                        <i class="bi bi-question-circle"></i> Unknown
                    </div>
                    <small class="text-muted">Insufficient data</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Power Type Distribution Bar -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-body">
                    <h6>
                        Power Type Distribution
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top"
                           title="Distribution of node power sources across the network. Solar uses renewable energy, Battery runs on stored power, Mains has constant power, Unknown needs detection."></i>
                    </h6>
                    <div class="progress" style="height: 32px; font-size: 0.875rem;">
                        {% set total_known = power_summary.solar + power_summary.battery + power_summary.mains + power_summary.unknown %}
                        {% if total_known > 0 %}
                            {% set solar_pct = (power_summary.solar / total_known * 100)|round(1) %}
                            {% set battery_pct = (power_summary.battery / total_known * 100)|round(1) %}
                            {% set mains_pct = (power_summary.mains / total_known * 100)|round(1) %}
                            {% set unknown_pct = (power_summary.unknown / total_known * 100)|round(1) %}
                        {% else %}
                            {% set solar_pct = 0 %}
                            {% set battery_pct = 0 %}
                            {% set mains_pct = 0 %}
                            {% set unknown_pct = 0 %}
                        {% endif %}

                        <div class="progress-bar bg-warning" role="progressbar" style="width: {{ solar_pct }}%"
                             data-bs-toggle="tooltip" data-bs-placement="top" title="{{ power_summary.solar }} solar nodes ({{ solar_pct }}%)">
                            <span class="health-bar-text"><span>{{ power_summary.solar }}</span> <span class="health-label">Solar</span></span>
                        </div>
                        <div class="progress-bar bg-info" role="progressbar" style="width: {{ battery_pct }}%"
                             data-bs-toggle="tooltip" data-bs-placement="top" title="{{ power_summary.battery }} battery nodes ({{ battery_pct }}%)">
                            <span class="health-bar-text"><span>{{ power_summary.battery }}</span> <span class="health-label">Battery</span></span>
                        </div>
                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ mains_pct }}%"
                             data-bs-toggle="tooltip" data-bs-placement="top" title="{{ power_summary.mains }} mains nodes ({{ mains_pct }}%)">
                            <span class="health-bar-text"><span>{{ power_summary.mains }}</span> <span class="health-label">Mains</span></span>
                        </div>
                        <div class="progress-bar bg-secondary" role="progressbar" style="width: {{ unknown_pct }}%"
                             data-bs-toggle="tooltip" data-bs-placement="top" title="{{ power_summary.unknown }} unknown nodes ({{ unknown_pct }}%)">
                            <span class="health-bar-text"><span>{{ power_summary.unknown }}</span> <span class="health-label">Unknown</span></span>
                        </div>
                    </div>
                    <!-- Legend for small screens -->
                    <div class="d-flex justify-content-around mt-2 small text-muted d-lg-none">
                        <span><span class="badge bg-warning">■</span> {{ power_summary.solar }} Solar</span>
                        <span><span class="badge bg-info">■</span> {{ power_summary.battery }} Battery</span>
                        <span><span class="badge bg-success">■</span> {{ power_summary.mains }} Mains</span>
                        <span><span class="badge bg-secondary">■</span> {{ power_summary.unknown }} Unknown</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Critical Batteries Alert -->
    {% if critical_batteries %}
    <div class="row mb-4">
        <div class="col">
            <div class="alert alert-danger" role="alert">
                <h5 class="alert-heading"><i class="bi bi-exclamation-triangle-fill"></i> Critical Battery Alert</h5>
                <p>The following nodes have critical battery levels and may go offline soon:</p>
                <ul class="mb-0">
                    {% for node in critical_batteries %}
                    <li>
                        <strong>{{ node.name }}</strong> ({{ node.hex_id }}) -
                        {% if node.voltage %}
                            Voltage: {{ "%.2f"|format(node.voltage) }}V
                        {% else %}
                            Health Score: {{ node.health_score }}
                        {% endif %}
                        - Last seen: {{ node.last_seen }}
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Battery Health Overview Table -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="bi bi-list-check"></i> Battery Health Overview</h5>
                </div>
                <div class="card-body">
                    {% if battery_health %}
                    <div class="mb-2">
                        <input type="text" id="battery-health-filter" class="form-control form-control-sm"
                               placeholder="Filter nodes..." style="max-width: 300px;">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover table-sm" id="battery-health-table">
                            <thead>
                                <tr>
                                    <th class="sortable-col" data-sort="name" style="cursor: pointer;">
                                        Node <i class="bi bi-arrow-down-up text-muted"></i>
                                    </th>
                                    <th class="sortable-col" data-sort="power_type" style="cursor: pointer;">
                                        Power Type <i class="bi bi-arrow-down-up text-muted"></i>
                                    </th>
                                    <th class="sortable-col" data-sort="battery_level" style="cursor: pointer;">
                                        Battery % <i class="bi bi-arrow-down-up text-muted"></i>
                                    </th>
                                    <th class="sortable-col" data-sort="voltage" style="cursor: pointer;">
                                        Voltage <i class="bi bi-arrow-down-up text-muted"></i>
                                    </th>
                                    <th class="sortable-col" data-sort="health_score" style="cursor: pointer;">
                                        Health Score <i class="bi bi-arrow-down-up text-muted"></i>
                                    </th>
                                    <th class="sortable-col" data-sort="status" style="cursor: pointer;">
                                        Status <i class="bi bi-arrow-down-up text-muted"></i>
                                    </th>
                                    <th>Last Telemetry</th>
                                </tr>
                            </thead>
                            <tbody id="battery-health-tbody">
                                {% for node in battery_health %}
                                <tr class="battery-health-row"
                                    data-name="{{ node.name|lower }}"
                                    data-power_type="{{ node.power_type or 'unknown' }}"
                                    data-battery_level="{{ node.battery_level or -1 }}"
                                    data-voltage="{{ node.voltage or -1 }}"
                                    data-health_score="{{ node.health_score or -1 }}"
                                    data-status="{{ 'critical' if node.voltage and node.voltage < 3.3 else ('low' if node.voltage and node.voltage < 3.6 else ('issues' if node.health_score and node.health_score < 70 else 'good')) }}"
                                    style="{% if node.status_class == 'danger' %}background-color: rgba(220, 53, 69, 0.08);{% elif node.status_class == 'warning' %}background-color: rgba(255, 193, 7, 0.08);{% elif node.status_class == 'success' %}background-color: rgba(25, 135, 84, 0.05);{% endif %}">
                                    <td>
                                        <a href="/node/{{ node.node_id }}" class="text-decoration-none">
                                            {{ node.name }}
                                        </a>
                                        <small class="text-muted d-block">{{ node.hex_id }}</small>
                                    </td>
                                    <td>
                                        <span {% if node.power_type_reason %}data-bs-toggle="tooltip" data-bs-placement="top" title="{{ node.power_type_reason }}" style="cursor:help; border-bottom: 1px dotted #ccc;"{% endif %}>
                                        {% if node.power_type == 'solar' %}
                                            <i class="bi bi-sun-fill text-warning"></i> Solar
                                            {% if node.cloud_level >= 4 %}
                                                <span class="solar-clouds" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ node.solar_charging_reason or 'Critical: No solar charging' }}">
                                                    <i class="bi bi-cloud-fill text-secondary"></i>
                                                    <i class="bi bi-cloud-fill text-secondary"></i>
                                                    <i class="bi bi-cloud-fill text-secondary"></i>
                                                    <i class="bi bi-cloud-fill text-danger"></i>
                                                </span>
                                            {% elif node.cloud_level >= 3 %}
                                                <span class="solar-clouds" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ node.solar_charging_reason or 'Poor solar charging' }}">
                                                    <i class="bi bi-cloud-fill text-secondary"></i>
                                                    <i class="bi bi-cloud-fill text-secondary"></i>
                                                    <i class="bi bi-cloud-fill text-warning"></i>
                                                </span>
                                            {% elif node.cloud_level >= 2 %}
                                                <span class="solar-clouds" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ node.solar_charging_reason or 'Reduced solar charging' }}">
                                                    <i class="bi bi-cloud-fill text-secondary"></i>
                                                    <i class="bi bi-cloud text-secondary"></i>
                                                </span>
                                            {% elif node.cloud_level == 1 %}
                                                <span class="solar-clouds" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ node.solar_charging_reason or 'Slightly reduced charging' }}">
                                                    <i class="bi bi-cloud text-secondary opacity-50"></i>
                                                </span>
                                            {% endif %}
                                        {% elif node.power_type == 'battery' %}
                                            <i class="bi bi-battery-half text-info"></i> Battery
                                        {% elif node.power_type == 'mains' %}
                                            <i class="bi bi-plug-fill text-success"></i> Mains
                                        {% else %}
                                            <i class="bi bi-question-circle text-secondary"></i> {{ node.power_type or 'Unknown' }}
                                        {% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        {% if node.battery_level %}
                                            {{ node.battery_level }}%
                                            <div class="progress" style="height: 4px; width: 50px;">
                                                <div class="progress-bar" role="progressbar"
                                                     style="width: {{ node.battery_level }}%"></div>
                                            </div>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if node.voltage %}
                                            {{ "%.2f"|format(node.voltage) }}V
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if node.health_score %}
                                            <span class="badge
                                                {% if node.health_score >= 80 %}bg-success
                                                {% elif node.health_score >= 40 %}bg-warning
                                                {% else %}bg-danger{% endif %}">
                                                {{ node.health_score }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if node.voltage and node.voltage < 3.3 %}
                                            <span class="badge bg-danger">Critical</span>
                                        {% elif node.voltage and node.voltage < 3.6 %}
                                            <span class="badge bg-warning">Low</span>
                                        {% elif node.health_score and node.health_score < 70 %}
                                            <span class="badge bg-warning">Issues</span>
                                        {% else %}
                                            <span class="badge bg-success">Good</span>
                                        {% endif %}
                                        {% if node.health_issues %}
                                        <small class="text-muted d-block" style="font-size: 0.75rem;">
                                            {{ node.health_issues[0] if node.health_issues else '' }}
                                        </small>
                                        {% endif %}
                                    </td>
                                    <td>{{ node.last_telemetry }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <script>
                        // Pure JavaScript sortable table implementation
                        (function() {
                            const table = document.getElementById('battery-health-table');
                            const tbody = document.getElementById('battery-health-tbody');
                            const filterInput = document.getElementById('battery-health-filter');
                            const headers = table.querySelectorAll('.sortable-col');

                            let currentSort = { column: null, direction: 'asc' };

                            // Sorting logic
                            function sortTable(column) {
                                const rows = Array.from(tbody.querySelectorAll('.battery-health-row'));

                                // Toggle direction if same column
                                if (currentSort.column === column) {
                                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                                } else {
                                    currentSort.column = column;
                                    currentSort.direction = 'asc';
                                }

                                rows.sort((a, b) => {
                                    let aVal = a.dataset[column];
                                    let bVal = b.dataset[column];

                                    // Handle numeric sorting
                                    if (['battery_level', 'voltage', 'health_score'].includes(column)) {
                                        aVal = parseFloat(aVal) || -999;
                                        bVal = parseFloat(bVal) || -999;
                                        return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
                                    }

                                    // Handle status sorting (critical < low < issues < good)
                                    if (column === 'status') {
                                        const statusOrder = { 'critical': 0, 'low': 1, 'issues': 2, 'good': 3 };
                                        aVal = statusOrder[aVal] ?? 4;
                                        bVal = statusOrder[bVal] ?? 4;
                                        return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
                                    }

                                    // String sorting
                                    return currentSort.direction === 'asc'
                                        ? aVal.localeCompare(bVal)
                                        : bVal.localeCompare(aVal);
                                });

                                // Re-append sorted rows
                                rows.forEach(row => tbody.appendChild(row));

                                // Update header icons
                                updateSortIcons();
                            }

                            function updateSortIcons() {
                                headers.forEach(header => {
                                    const icon = header.querySelector('i');
                                    const col = header.dataset.sort;

                                    if (col === currentSort.column) {
                                        icon.className = currentSort.direction === 'asc'
                                            ? 'bi bi-arrow-up'
                                            : 'bi bi-arrow-down';
                                        icon.classList.remove('text-muted');
                                    } else {
                                        icon.className = 'bi bi-arrow-down-up text-muted';
                                    }
                                });
                            }

                            // Add click handlers to sortable headers
                            headers.forEach(header => {
                                header.addEventListener('click', () => {
                                    sortTable(header.dataset.sort);
                                });
                            });

                            // Filter logic
                            if (filterInput) {
                                filterInput.addEventListener('input', function() {
                                    const filter = this.value.toLowerCase();
                                    const rows = tbody.querySelectorAll('.battery-health-row');

                                    rows.forEach(row => {
                                        const name = row.dataset.name || '';
                                        const powerType = row.dataset.power_type || '';
                                        const visible = name.includes(filter) || powerType.includes(filter);
                                        row.style.display = visible ? '' : 'none';
                                    });
                                });
                            }

                            // Initial sort by health score (ascending = worst first)
                            sortTable('health_score');
                        })();
                    </script>
                    {% else %}
                    <p class="text-muted mb-0">No battery-powered nodes found with telemetry data.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Voltage Trends Chart Section -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="bi bi-graph-up"></i> Voltage Trends (Last 7 Days)</h5>
                </div>
                <div class="card-body">
                    <div id="voltage-trends-chart" style="height: 400px;"></div>
                    <p class="text-muted text-center mt-3">
                        <small>Chart will be available once nodes start reporting telemetry data. Solar nodes will show daily charging cycles.</small>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval = null;

        // Auto-refresh page every 10 minutes (600000ms)
        document.addEventListener('DOMContentLoaded', function() {
            // Update last update timestamp
            updateLastUpdateTime();

            // Set up auto-refresh every 10 minutes
            autoRefreshInterval = setInterval(() => {
                console.log('Auto-refreshing battery analytics...');
                location.reload();
            }, 600000); // 10 minutes in milliseconds

            // Load and render voltage trends chart
            fetch('/api/voltage-trends')
                .then(response => response.json())
                .then(data => {
                    if (data.nodes && Object.keys(data.nodes).length > 0) {
                        renderVoltageTrendsChart(data.nodes);
                    } else {
                        console.log('No voltage trend data available');
                    }
                })
                .catch(error => console.error('Error loading voltage trends:', error));
        });

        function updateLastUpdateTime() {
            const lastUpdateEl = document.getElementById('last-update-time');
            if (lastUpdateEl) {
                const now = new Date();
                const timeStr = typeof formatTimestamp === 'function' ? formatTimestamp(Math.floor(now.getTime() / 1000), 'time') : now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                lastUpdateEl.textContent = `(Updated: ${timeStr})`;
            }
        }

        function renderVoltageTrendsChart(nodesData) {
            // Prepare traces for Plotly
            const traces = [];

            Object.entries(nodesData).forEach(([nodeId, nodeData]) => {
                traces.push({
                    x: nodeData.timestamps,
                    y: nodeData.voltages,
                    mode: 'lines+markers',
                    name: nodeData.name,
                    type: 'scatter',
                    line: {
                        shape: 'spline'
                    }
                });
            });

            const layout = {
                title: 'Voltage Trends (Last 7 Days)',
                xaxis: {
                    title: 'Time'
                },
                yaxis: {
                    title: 'Voltage (V)',
                    rangemode: 'tozero'
                },
                hovermode: 'x unified',
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: {
                    color: getComputedStyle(document.documentElement).getPropertyValue('--bs-body-color') || '#000'
                }
            };

            // Use Plotly if available
            if (typeof Plotly !== 'undefined') {
                Plotly.newPlot('voltage-trends-chart', traces, layout, {responsive: true, displayModeBar: false});
            } else {
                console.warn('Plotly not loaded, cannot render chart');
            }
        }
    </script>

    <!-- Nodes Sharing Battery Telemetry Section -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="bi bi-diagram-2"></i> Nodes Sharing Battery Telemetry</h5>
                </div>
                <div class="card-body">
                    {% if nodes_with_telemetry %}
                    <div class="row">
                        {% for node in nodes_with_telemetry %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card border-light h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <h6 class="card-title mb-0">
                                                <a href="/node/{{ node.node_id }}" class="text-decoration-none">
                                                    {{ node.name }}
                                                </a>
                                            </h6>
                                            <small class="text-muted">{{ node.hex_id }}</small>
                                        </div>
                                        <span class="badge bg-{{ node.power_class }}">
                                            <i class="bi bi-{{ node.power_icon }}"></i> {{ node.power_type|title }}
                                        </span>
                                    </div>

                                    <div class="row g-2 mt-2">
                                        {% if node.voltage %}
                                        <div class="col-6">
                                            <small class="text-muted d-block">Voltage</small>
                                            <strong>{{ "%.2f"|format(node.voltage) }}V</strong>
                                        </div>
                                        {% endif %}
                                        {% if node.health_score %}
                                        <div class="col-6">
                                            <small class="text-muted d-block">Health</small>
                                            <strong>
                                                <span class="badge
                                                    {% if node.health_score >= 80 %}bg-success
                                                    {% elif node.health_score >= 40 %}bg-warning
                                                    {% else %}bg-danger{% endif %}">
                                                    {{ node.health_score }}
                                                </span>
                                            </strong>
                                        </div>
                                        {% endif %}
                                    </div>

                                    <hr class="my-2">
                                    <small class="text-muted">
                                        <i class="bi bi-clock"></i> Last telemetry: {{ node.last_telemetry }}
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted mb-0"><i class="bi bi-info-circle"></i> No nodes are currently sharing battery telemetry data.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Add Bootstrap Icons CSS if not already included -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

{% endblock %}
