{% extends "base.html" %}

{% block title %}Battery Analytics - {{ APP_NAME }}{% endblock %}

{% block content %}
<div class="container-fluid">
    {% if error_message %}
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle"></i>
        <strong>Notice:</strong> {{ error_message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="h2">
                <i class="bi bi-battery-charging"></i> Battery &amp; Power Analytics
            </h1>
        </div>
        <div class="col-md-4 text-end">
            <div class="btn-group" role="group">
                <button id="detect-power-btn" class="btn btn-primary" onclick="detectPowerTypes(false)">
                    <i class="bi bi-lightning-fill"></i> Detect Power Types
                </button>
                <button class="btn btn-outline-primary" onclick="detectPowerTypes(true)" title="Re-detect all nodes, even those already classified">
                    <i class="bi bi-arrow-clockwise"></i> Force Re-detect
                </button>
            </div>
        </div>
    </div>

    <!-- Power Type Detection Status -->
    <div class="row mb-3">
        <div class="col">
            <div id="power-detection-status" class="alert alert-info" role="alert" style="display: none;">
                <i class="bi bi-info-circle"></i>
                <span id="power-detection-message">Analyzing power types...</span>
            </div>
        </div>
    </div>

    <!-- Power Source Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body card-metric">
                    <div class="metric-value text-warning">{{ power_summary.solar }}</div>
                    <div class="metric-label">
                        <i class="bi bi-sun-fill"></i> Solar Nodes
                    </div>
                    <small class="text-muted">Renewable powered</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body card-metric">
                    <div class="metric-value text-info">{{ power_summary.battery }}</div>
                    <div class="metric-label">
                        <i class="bi bi-battery-half"></i> Battery Nodes
                    </div>
                    <small class="text-muted">Battery only</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body card-metric">
                    <div class="metric-value text-success">{{ power_summary.mains }}</div>
                    <div class="metric-label">
                        <i class="bi bi-plug-fill"></i> Mains Powered
                    </div>
                    <small class="text-muted">Constant power</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body card-metric">
                    <div class="metric-value text-secondary">{{ power_summary.unknown }}</div>
                    <div class="metric-label">
                        <i class="bi bi-question-circle"></i> Unknown
                    </div>
                    <small class="text-muted">Insufficient data</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Power Type Distribution Bar -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-body">
                    <h6>
                        Power Type Distribution
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top"
                           title="Distribution of node power sources across the network. Solar uses renewable energy, Battery runs on stored power, Mains has constant power, Unknown needs detection."></i>
                    </h6>
                    <div class="progress" style="height: 32px; font-size: 0.875rem;">
                        {% set total_known = power_summary.solar + power_summary.battery + power_summary.mains + power_summary.unknown %}
                        {% if total_known > 0 %}
                            {% set solar_pct = (power_summary.solar / total_known * 100)|round(1) %}
                            {% set battery_pct = (power_summary.battery / total_known * 100)|round(1) %}
                            {% set mains_pct = (power_summary.mains / total_known * 100)|round(1) %}
                            {% set unknown_pct = (power_summary.unknown / total_known * 100)|round(1) %}
                        {% else %}
                            {% set solar_pct = 0 %}
                            {% set battery_pct = 0 %}
                            {% set mains_pct = 0 %}
                            {% set unknown_pct = 0 %}
                        {% endif %}

                        <div class="progress-bar bg-warning" role="progressbar" style="width: {{ solar_pct }}%"
                             data-bs-toggle="tooltip" data-bs-placement="top" title="{{ power_summary.solar }} solar nodes ({{ solar_pct }}%)">
                            <span class="health-bar-text"><span>{{ power_summary.solar }}</span> <span class="health-label">Solar</span></span>
                        </div>
                        <div class="progress-bar bg-info" role="progressbar" style="width: {{ battery_pct }}%"
                             data-bs-toggle="tooltip" data-bs-placement="top" title="{{ power_summary.battery }} battery nodes ({{ battery_pct }}%)">
                            <span class="health-bar-text"><span>{{ power_summary.battery }}</span> <span class="health-label">Battery</span></span>
                        </div>
                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ mains_pct }}%"
                             data-bs-toggle="tooltip" data-bs-placement="top" title="{{ power_summary.mains }} mains nodes ({{ mains_pct }}%)">
                            <span class="health-bar-text"><span>{{ power_summary.mains }}</span> <span class="health-label">Mains</span></span>
                        </div>
                        <div class="progress-bar bg-secondary" role="progressbar" style="width: {{ unknown_pct }}%"
                             data-bs-toggle="tooltip" data-bs-placement="top" title="{{ power_summary.unknown }} unknown nodes ({{ unknown_pct }}%)">
                            <span class="health-bar-text"><span>{{ power_summary.unknown }}</span> <span class="health-label">Unknown</span></span>
                        </div>
                    </div>
                    <!-- Legend for small screens -->
                    <div class="d-flex justify-content-around mt-2 small text-muted d-lg-none">
                        <span><span class="badge bg-warning">■</span> {{ power_summary.solar }} Solar</span>
                        <span><span class="badge bg-info">■</span> {{ power_summary.battery }} Battery</span>
                        <span><span class="badge bg-success">■</span> {{ power_summary.mains }} Mains</span>
                        <span><span class="badge bg-secondary">■</span> {{ power_summary.unknown }} Unknown</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Critical Batteries Alert -->
    {% if critical_batteries %}
    <div class="row mb-4">
        <div class="col">
            <div class="alert alert-danger" role="alert">
                <h5 class="alert-heading"><i class="bi bi-exclamation-triangle-fill"></i> Critical Battery Alert</h5>
                <p>The following nodes have critical battery levels and may go offline soon:</p>
                <ul class="mb-0">
                    {% for node in critical_batteries %}
                    <li>
                        <strong>{{ node.name }}</strong> ({{ node.hex_id }}) -
                        {% if node.voltage %}
                            Voltage: {{ "%.2f"|format(node.voltage) }}V
                        {% else %}
                            Health Score: {{ node.health_score }}
                        {% endif %}
                        - Last seen: {{ node.last_seen }}
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Battery Health Overview Table -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="bi bi-list-check"></i> Battery Health Overview</h5>
                </div>
                <div class="card-body">
                    {% if battery_health %}
                    <div class="table-responsive">
                        <table class="table table-hover table-sm" id="battery-health-table">
                            <thead>
                                <tr>
                                    <th>Node</th>
                                    <th>Power Type</th>
                                    <th>Battery %</th>
                                    <th>Voltage</th>
                                    <th>Health Score</th>
                                    <th>Status</th>
                                    <th>Last Telemetry</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for node in battery_health %}
                                <tr style="{% if node.status_class == 'danger' %}background-color: rgba(220, 53, 69, 0.08);{% elif node.status_class == 'warning' %}background-color: rgba(255, 193, 7, 0.08);{% elif node.status_class == 'success' %}background-color: rgba(25, 135, 84, 0.05);{% endif %}">
                                    <td>
                                        <a href="/node/{{ node.node_id }}" class="text-decoration-none">
                                            {{ node.name }}
                                        </a>
                                        <small class="text-muted d-block">{{ node.hex_id }}</small>
                                    </td>
                                    <td>
                                        {% if node.power_type == 'solar' %}
                                            <i class="bi bi-sun-fill text-warning"></i> Solar
                                        {% elif node.power_type == 'battery' %}
                                            <i class="bi bi-battery-half text-info"></i> Battery
                                        {% else %}
                                            {{ node.power_type }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if node.battery_level %}
                                            {{ node.battery_level }}%
                                            <div class="progress" style="height: 4px; width: 50px;">
                                                <div class="progress-bar" role="progressbar"
                                                     style="width: {{ node.battery_level }}%"></div>
                                            </div>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if node.voltage %}
                                            {{ "%.2f"|format(node.voltage) }}V
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if node.health_score %}
                                            <span class="badge
                                                {% if node.health_score >= 80 %}bg-success
                                                {% elif node.health_score >= 40 %}bg-warning
                                                {% else %}bg-danger{% endif %}">
                                                {{ node.health_score }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if node.voltage and node.voltage < 3.3 %}
                                            <span class="badge bg-danger">Critical</span>
                                        {% elif node.voltage and node.voltage < 3.6 %}
                                            <span class="badge bg-warning">Low</span>
                                        {% else %}
                                            <span class="badge bg-success">Good</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ node.last_telemetry }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <script>
                        // Make table sortable and searchable with DataTables (if available)
                        document.addEventListener('DOMContentLoaded', function() {
                            if (typeof $.fn.DataTable !== 'undefined') {
                                $('#battery-health-table').DataTable({
                                    pageLength: 25,
                                    order: [[4, 'asc']],  // Sort by health score
                                    language: {
                                        search: "Filter nodes:"
                                    }
                                });
                            }
                        });
                    </script>
                    {% else %}
                    <p class="text-muted mb-0">No battery-powered nodes found with telemetry data.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Voltage Trends Chart Section -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="bi bi-graph-up"></i> Voltage Trends (Last 7 Days)</h5>
                </div>
                <div class="card-body">
                    <div id="voltage-trends-chart" style="height: 400px;"></div>
                    <p class="text-muted text-center mt-3">
                        <small>Chart will be available once nodes start reporting telemetry data. Solar nodes will show daily charging cycles.</small>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Auto-detect power types if all are unknown
        document.addEventListener('DOMContentLoaded', function() {
            // Check if auto-detection is needed
            const hasTelemetry = {{ (nodes_with_telemetry|length > 0)|tojson }};
            const allUnknown = {{ power_summary.solar }} === 0 &&
                              {{ power_summary.battery }} === 0 &&
                              {{ power_summary.mains }} === 0 &&
                              {{ power_summary.unknown }} > 0;

            if (hasTelemetry && allUnknown) {
                console.log('Auto-detecting power types on first load...');
                setTimeout(() => detectPowerTypes(false, true), 500);
            }

            // Load and render voltage trends chart
            fetch('/api/voltage-trends')
                .then(response => response.json())
                .then(data => {
                    if (data.nodes && Object.keys(data.nodes).length > 0) {
                        renderVoltageTrendsChart(data.nodes);
                    } else {
                        console.log('No voltage trend data available');
                    }
                })
                .catch(error => console.error('Error loading voltage trends:', error));
        });

        function detectPowerTypes(force = false, autoDetect = false) {
            const button = document.getElementById('detect-power-btn');
            const statusDiv = document.getElementById('power-detection-status');
            const messageSpan = document.getElementById('power-detection-message');

            // Disable button and show status
            if (button) button.disabled = true;
            statusDiv.style.display = 'block';
            statusDiv.className = 'alert alert-info';

            if (force) {
                messageSpan.textContent = 'Re-analyzing all nodes to detect power sources...';
            } else if (autoDetect) {
                messageSpan.textContent = 'Automatically detecting power types from voltage patterns...';
            } else {
                messageSpan.textContent = 'Analyzing voltage patterns to detect power sources...';
            }

            const url = force ? '/api/detect-power-types?force=true' : '/api/detect-power-types';

            fetch(url, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.results) {
                        const total = data.results.solar + data.results.battery + data.results.mains;
                        statusDiv.className = 'alert alert-success';
                        messageSpan.innerHTML = `
                            <strong>Detection complete!</strong>
                            Found ${data.results.solar} solar, ${data.results.battery} battery,
                            and ${data.results.mains} mains-powered nodes.
                            <a href="javascript:location.reload()" class="alert-link">Refresh page</a> to see updated counts.
                        `;
                        if (total > 0 && autoDetect) {
                            // Auto-reload after successful auto-detection
                            setTimeout(() => location.reload(), 2000);
                        }
                    } else {
                        statusDiv.className = 'alert alert-warning';
                        messageSpan.textContent = 'Detection completed but no power types were identified. More data may be needed.';
                    }
                })
                .catch(error => {
                    statusDiv.className = 'alert alert-danger';
                    messageSpan.textContent = 'Error detecting power types: ' + error.message;
                    console.error('Error:', error);
                })
                .finally(() => {
                    if (button) button.disabled = false;
                });
        }

        function renderVoltageTrendsChart(nodesData) {
            // Prepare traces for Plotly
            const traces = [];

            Object.entries(nodesData).forEach(([nodeId, nodeData]) => {
                traces.push({
                    x: nodeData.timestamps,
                    y: nodeData.voltages,
                    mode: 'lines+markers',
                    name: nodeData.name,
                    type: 'scatter',
                    line: {
                        shape: 'spline'
                    }
                });
            });

            const layout = {
                title: 'Voltage Trends (Last 7 Days)',
                xaxis: {
                    title: 'Time'
                },
                yaxis: {
                    title: 'Voltage (V)',
                    rangemode: 'tozero'
                },
                hovermode: 'x unified',
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: {
                    color: getComputedStyle(document.documentElement).getPropertyValue('--bs-body-color') || '#000'
                }
            };

            // Use Plotly if available
            if (typeof Plotly !== 'undefined') {
                Plotly.newPlot('voltage-trends-chart', traces, layout, {responsive: true, displayModeBar: false});
            } else {
                console.warn('Plotly not loaded, cannot render chart');
            }
        }
    </script>

    <!-- Nodes Sharing Battery Telemetry Section -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="bi bi-diagram-2"></i> Nodes Sharing Battery Telemetry</h5>
                </div>
                <div class="card-body">
                    {% if nodes_with_telemetry %}
                    <div class="row">
                        {% for node in nodes_with_telemetry %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card border-light h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <h6 class="card-title mb-0">
                                                <a href="/node/{{ node.node_id }}" class="text-decoration-none">
                                                    {{ node.name }}
                                                </a>
                                            </h6>
                                            <small class="text-muted">{{ node.hex_id }}</small>
                                        </div>
                                        <span class="badge bg-{{ node.power_class }}">
                                            <i class="bi bi-{{ node.power_icon }}"></i> {{ node.power_type|title }}
                                        </span>
                                    </div>

                                    <div class="row g-2 mt-2">
                                        {% if node.voltage %}
                                        <div class="col-6">
                                            <small class="text-muted d-block">Voltage</small>
                                            <strong>{{ "%.2f"|format(node.voltage) }}V</strong>
                                        </div>
                                        {% endif %}
                                        {% if node.health_score %}
                                        <div class="col-6">
                                            <small class="text-muted d-block">Health</small>
                                            <strong>
                                                <span class="badge
                                                    {% if node.health_score >= 80 %}bg-success
                                                    {% elif node.health_score >= 40 %}bg-warning
                                                    {% else %}bg-danger{% endif %}">
                                                    {{ node.health_score }}
                                                </span>
                                            </strong>
                                        </div>
                                        {% endif %}
                                    </div>

                                    <hr class="my-2">
                                    <small class="text-muted">
                                        <i class="bi bi-clock"></i> Last telemetry: {{ node.last_telemetry }}
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted mb-0"><i class="bi bi-info-circle"></i> No nodes are currently sharing battery telemetry data.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Add Bootstrap Icons CSS if not already included -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

{% endblock %}
