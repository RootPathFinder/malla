{#
    7-Day Availability Visualization Component - Compact Version

    Parameters:
        - container_id: Unique ID for this visualization container
        - node_id: Node ID to fetch uptime data for
        - days: Number of days to show (default: 7)
        - show_labels: Whether to show time block labels (default: true)
#}

<style>
    .uptime-compact {
        background: var(--bs-body-bg);
        border-radius: 6px;
    }

    .uptime-compact .uptime-row {
        display: flex;
        align-items: flex-start;
        gap: 4px;
    }

    .uptime-compact .uptime-days {
        display: flex;
        gap: 4px;
        flex: 1;
    }

    .uptime-compact .uptime-day {
        flex: 1;
        min-width: 0;
    }

    .uptime-compact .uptime-day-blocks {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .uptime-compact .uptime-block {
        height: 8px;
        border-radius: 2px;
        transition: opacity 0.15s, transform 0.15s;
        cursor: help;
    }

    .uptime-compact .uptime-block:hover {
        opacity: 0.85;
        transform: scaleY(1.3);
    }

    .uptime-compact .uptime-block.available {
        background: #198754;
    }

    .uptime-compact .uptime-block.degraded {
        background: #ffc107;
    }

    .uptime-compact .uptime-block.unavailable {
        background: #dc3545;
    }

    .uptime-compact .uptime-block.future {
        background: var(--bs-secondary);
        opacity: 0.25;
        cursor: default;
    }

    .uptime-compact .uptime-block.future:hover {
        transform: none;
    }

    .uptime-compact .uptime-day-label {
        text-align: center;
        font-size: 0.6rem;
        color: var(--bs-secondary);
        margin-top: 4px;
        line-height: 1.2;
    }

    .uptime-compact .uptime-day-label .day-name {
        font-weight: 600;
    }

    .uptime-compact .uptime-day-label .day-date {
        opacity: 0.75;
        font-size: 0.55rem;
    }

    .uptime-compact .uptime-day.today .uptime-day-label .day-name {
        color: var(--bs-primary);
    }

    .uptime-compact .uptime-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 10px;
        padding-top: 8px;
        border-top: 1px solid var(--bs-border-color-translucent);
        font-size: 0.7rem;
        color: var(--bs-secondary);
    }

    .uptime-compact .uptime-pct {
        font-weight: 700;
        font-size: 0.8rem;
    }

    .uptime-compact .uptime-pct.good { color: #198754; }
    .uptime-compact .uptime-pct.warn { color: #fd7e14; }
    .uptime-compact .uptime-pct.bad { color: #dc3545; }

    .uptime-compact .uptime-legend {
        display: flex;
        gap: 10px;
        font-size: 0.6rem;
    }

    .uptime-compact .uptime-legend-item {
        display: flex;
        align-items: center;
        gap: 3px;
    }

    .uptime-compact .uptime-legend-dot {
        width: 8px;
        height: 8px;
        border-radius: 2px;
    }

    .uptime-compact .uptime-legend-dot.available { background: #198754; }
    .uptime-compact .uptime-legend-dot.degraded { background: #ffc107; }
    .uptime-compact .uptime-legend-dot.unavailable { background: #dc3545; }
</style>

<div id="{{ container_id }}" class="uptime-compact">
    <div class="text-center text-muted py-2">
        <div class="spinner-border spinner-border-sm" role="status"></div>
        <small class="ms-2">Loading...</small>
    </div>
</div>

<script>
(function() {
    const containerId = '{{ container_id }}';
    const nodeId = '{{ node_id }}';
    const days = {{ days if days else 7 }};

    async function loadUptime() {
        try {
            const response = await fetch(`/api/health/uptime/${nodeId}?days=${days}`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();

            if (data.error) {
                document.getElementById(containerId).innerHTML = `
                    <div class="text-muted small"><i class="bi bi-exclamation-triangle"></i> ${data.error}</div>`;
                return;
            }
            render(data);
        } catch (e) {
            document.getElementById(containerId).innerHTML = `
                <div class="text-muted small"><i class="bi bi-exclamation-triangle"></i> Unable to load</div>`;
        }
    }

    function render(data) {
        const container = document.getElementById(containerId);
        if (!data.daily_summary || data.daily_summary.length === 0) {
            container.innerHTML = `<div class="text-muted small"><i class="bi bi-info-circle"></i> No data</div>`;
            return;
        }

        // Get current date info for "today" detection
        const now = new Date();
        const tzPref = typeof getTimezonePreference === 'function' ? getTimezonePreference() : 'local';
        const tzOption = tzPref === 'utc' ? 'UTC' : undefined;
        const todayStr = now.toISOString().split('T')[0];
        const currentHour = tzPref === 'utc' ? now.getUTCHours() : now.getHours();

        // Build compact visualization - 4 blocks per day (6-hour periods)
        let html = '<div class="uptime-row"><div class="uptime-days">';

        data.daily_summary.forEach(day => {
            const dayDate = new Date(day.date + 'T12:00:00Z');
            const dayName = dayDate.toLocaleDateString(undefined, { weekday: 'short', timeZone: tzOption });
            const monthDay = dayDate.toLocaleDateString(undefined, { month: 'numeric', day: 'numeric', timeZone: tzOption });
            const isToday = day.date === todayStr;

            // Aggregate 12 time blocks into 4 (6-hour periods)
            const blocks = day.time_blocks || [];
            const periods = [
                { blocks: blocks.slice(0, 3), startHour: 0, label: '12am-6am' },
                { blocks: blocks.slice(3, 6), startHour: 6, label: '6am-12pm' },
                { blocks: blocks.slice(6, 9), startHour: 12, label: '12pm-6pm' },
                { blocks: blocks.slice(9, 12), startHour: 18, label: '6pm-12am' }
            ];

            html += `<div class="uptime-day${isToday ? ' today' : ''}">`;
            html += '<div class="uptime-day-blocks">';

            periods.forEach(period => {
                // Calculate period status from sub-blocks
                let avail = 0, deg = 0, unavail = 0;
                period.blocks.forEach(b => {
                    if (b.status === 'available') avail++;
                    else if (b.status === 'degraded') deg++;
                    else unavail++;
                });

                // Determine if this period is in the future (for today)
                const isFuture = isToday && period.startHour > currentHour;

                let status;
                if (isFuture) {
                    status = 'future';
                } else if (period.blocks.length === 0) {
                    // No block data, use day uptime
                    status = day.uptime_percentage >= 80 ? 'available' :
                             day.uptime_percentage >= 50 ? 'degraded' : 'unavailable';
                } else if (avail >= 2) {
                    status = 'available';
                } else if (avail + deg >= 2) {
                    status = 'degraded';
                } else {
                    status = 'unavailable';
                }

                const tooltip = isFuture ? `${period.label}: Future` :
                    `${dayName} ${monthDay} ${period.label}`;

                html += `<div class="uptime-block ${status}" title="${tooltip}"></div>`;
            });

            html += '</div>';
            html += `<div class="uptime-day-label">`;
            html += `<div class="day-name">${isToday ? 'Today' : dayName}</div>`;
            html += `<div class="day-date">${monthDay}</div>`;
            html += '</div></div>';
        });

        html += '</div></div>';

        // Footer with percentage and legend
        const pct = data.uptime_percentage;
        const pctClass = pct >= 80 ? 'good' : pct >= 50 ? 'warn' : 'bad';

        html += `<div class="uptime-footer">`;
        html += `<span class="uptime-pct ${pctClass}">${pct}% uptime</span>`;
        html += `<div class="uptime-legend">`;
        html += `<span class="uptime-legend-item"><span class="uptime-legend-dot available"></span>OK</span>`;
        html += `<span class="uptime-legend-item"><span class="uptime-legend-dot degraded"></span>Degraded</span>`;
        html += `<span class="uptime-legend-item"><span class="uptime-legend-dot unavailable"></span>Down</span>`;
        html += `</div></div>`;

        container.innerHTML = html;

        // Initialize tooltips
        container.querySelectorAll('[title]').forEach(el => {
            new bootstrap.Tooltip(el, { placement: 'top' });
        });
    }

    // Auto-load when document is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadUptime);
    } else {
        loadUptime();
    }
})();
</script>
