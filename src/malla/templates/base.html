<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ APP_NAME }}{% endblock %}</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" integrity="sha384-4LISF5TTJX/fLmGSxO53rV4miRxdg84mZsxmO8Rx5jGtp/LbrixFETvWa5a6sESd" crossorigin="anonymous">

    <!-- Visualization Libraries (opt-in per page to reduce initial load) -->
    {% block head_libs %}
    <!-- Override this block in child templates that need Plotly or Chart.js -->
    {% endblock head_libs %}

    <!-- Inter Font for modern typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Global 2025 theme overrides -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/malla.css') }}">
    <!-- Skeleton loader styles for better perceived performance -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/skeleton-loader.css') }}">

    <style>
        .navbar-brand {
            font-weight: bold;
        }
        .card-metric {
            text-align: center;
            padding: 1.5rem;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #0d6efd;
        }
        .metric-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        .signal-excellent { color: #198754; }
        .signal-good { color: #ffc107; }
        .signal-fair { color: #fd7e14; }
        .signal-poor { color: #dc3545; }
        .table-responsive {
            max-height: 70vh;
        }
        .footer {
            margin-top: 3rem;
            padding: 2rem 0;
            border-top: 1px solid #dee2e6;
            color: #6c757d;
            text-align: center;
        }

        /* Node tooltip styles */
        .node-link {
            position: relative;
            color: var(--bs-primary);
            font-weight: 500;
        }

        .node-link:hover {
            color: var(--bs-primary);
            filter: brightness(0.85);
        }

        .tooltip.bs-tooltip-top .tooltip-inner,
        .tooltip.bs-tooltip-bottom .tooltip-inner {
            max-width: 300px;
            text-align: left;
            background-color: #212529;
            border-radius: 0.375rem;
            padding: 0.75rem;
        }

        .node-tooltip-content {
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .node-tooltip-header {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #fff;
        }

        .node-tooltip-row {
            margin-bottom: 0.25rem;
        }

        .node-tooltip-label {
            color: #adb5bd;
            font-weight: 500;
        }

        .node-tooltip-value {
            color: #fff;
        }

        .table-responsive {
            height: 100%;
            max-height: 100%;
        }

        /* Health distribution bar styles */
        .health-bar-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 4px;
        }

        /* Hide labels on narrow segments */
        .progress-bar[style*="width: 0%"] .health-bar-text,
        .progress-bar[style*="width: 1%"] .health-bar-text,
        .progress-bar[style*="width: 2%"] .health-bar-text,
        .progress-bar[style*="width: 3%"] .health-bar-text,
        .progress-bar[style*="width: 4%"] .health-bar-text,
        .progress-bar[style*="width: 5%"] .health-bar-text {
            display: none;
        }

        /* On smaller screens, hide label text but keep counts */
        @media (max-width: 768px) {
            .health-label {
                display: none;
            }
        }

        /* On very small screens, show only tooltips */
        @media (max-width: 576px) {
            .health-bar-text {
                font-size: 0.75rem;
            }
        }
    </style>

    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top" style="z-index: 1040;">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('main.dashboard') }}">
                <i class="bi bi-radio"></i> {{ APP_NAME }}
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <!-- Dashboard -->
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'main.dashboard' }}" href="{{ url_for('main.dashboard') }}">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                    </li>

                    <!-- Data dropdown (Packets & Nodes) -->
                    <li class="nav-item dropdown">
                        {% set data_active = 'packet' in request.endpoint or 'node' in request.endpoint %}
                        <a class="nav-link dropdown-toggle {{ 'active' if data_active }}" href="#" id="dataDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-database"></i> Data
                        </a>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item {{ 'active' if 'packet' in request.endpoint }}" href="{{ url_for('packet.packets') }}">
                                    <i class="bi bi-box"></i> Packets
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {{ 'active' if 'node' in request.endpoint }}" href="{{ url_for('node.nodes') }}">
                                    <i class="bi bi-router"></i> Nodes
                                </a>
                            </li>
                        </ul>
                    </li>

                    <!-- Network dropdown (Traceroutes, Network Graph & Mesh Topology) -->
                    <li class="nav-item dropdown">
                        {% set network_active = request.endpoint in ['traceroute.traceroute', 'traceroute.traceroute_graph', 'mesh.topology_page'] %}
                        <a class="nav-link dropdown-toggle {{ 'active' if network_active }}" href="#" id="networkDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-diagram-3"></i> Network
                        </a>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item {{ 'active' if request.endpoint == 'traceroute.traceroute' }}" href="{{ url_for('traceroute.traceroute') }}">
                                    <i class="bi bi-list-ul"></i> Traceroutes
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {{ 'active' if request.endpoint == 'traceroute.traceroute_graph' }}" href="{{ url_for('traceroute.traceroute_graph') }}">
                                    <i class="bi bi-diagram-2"></i> Network Graph
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {{ 'active' if request.endpoint == 'mesh.topology_page' }}" href="{{ url_for('mesh.topology_page') }}">
                                    <i class="bi bi-bezier2"></i> Mesh Topology
                                </a>
                            </li>
                        </ul>
                    </li>

                    <!-- Map -->
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'main.map_view' }}" href="{{ url_for('main.map_view') }}">
                            <i class="bi bi-map"></i> Map
                        </a>
                    </li>

                    <!-- Monitoring dropdown (Power, Node Health & Alerts) -->
                    <li class="nav-item dropdown">
                        {% set monitoring_active = request.endpoint in ['battery.battery_analytics', 'main.node_health', 'alerts.alerts_page'] %}
                        <a class="nav-link dropdown-toggle {{ 'active' if monitoring_active }}" href="#" id="monitoringDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-activity"></i> Monitoring
                        </a>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item {{ 'active' if request.endpoint == 'battery.battery_analytics' }}" href="{{ url_for('battery.battery_analytics') }}">
                                    <i class="bi bi-battery-charging"></i> Power Analytics
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {{ 'active' if request.endpoint == 'main.node_health' }}" href="{{ url_for('main.node_health') }}">
                                    <i class="bi bi-heart-pulse"></i> Node Health
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {{ 'active' if request.endpoint == 'alerts.alerts_page' }}" href="{{ url_for('alerts.alerts_page') }}">
                                    <i class="bi bi-bell"></i> Alerts
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {{ 'active' if request.endpoint == 'alerts.archived_nodes_page' }}" href="{{ url_for('alerts.archived_nodes_page') }}">
                                    <i class="bi bi-archive"></i> Archived Nodes
                                </a>
                            </li>
                        </ul>
                    </li>

                    <!-- Analysis Tools dropdown -->
                    <li class="nav-item dropdown">
                        {% set tools_active = request.endpoint in ['traceroute.traceroute_hops', 'gateway.gateway_compare', 'main.longest_links', 'main.line_of_sight'] %}
                        <a class="nav-link dropdown-toggle {{ 'active' if tools_active }}" href="#" id="toolsDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-tools"></i> Analysis
                        </a>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item {{ 'active' if request.endpoint == 'traceroute.traceroute_hops' }}" href="{{ url_for('traceroute.traceroute_hops') }}">
                                    <i class="bi bi-graph-up"></i> Hop Analysis
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {{ 'active' if request.endpoint == 'gateway.gateway_compare' }}" href="{{ url_for('gateway.gateway_compare') }}">
                                    <i class="bi bi-router-fill"></i> Gateway Compare
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {{ 'active' if request.endpoint == 'main.longest_links' }}" href="{{ url_for('main.longest_links') }}">
                                    <i class="bi bi-rulers"></i> Longest Links
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item {{ 'active' if request.endpoint == 'main.line_of_sight' }}" href="{{ url_for('main.line_of_sight') }}">
                                    <i class="bi bi-bezier"></i> Line of Sight
                                </a>
                            </li>
                        </ul>
                    </li>

                    {% if APP_CONFIG.admin_enabled %}
                    <!-- Mesh Admin -->
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'admin.admin_page' }}" href="{{ url_for('admin.admin_page') }}">
                            <i class="bi bi-gear-wide-connected"></i> Admin
                        </a>
                    </li>
                    {% endif %}
                </ul>

                <!-- Timezone Toggle, Temperature Toggle, and Dark Mode Toggle -->
                <div class="navbar-nav d-flex flex-row align-items-center gap-1">
                    <!-- Global Node Search - Collapsible -->
                    <div class="position-relative d-none d-lg-block" style="width: 160px;">
                        <input type="text" id="global-node-search" class="form-control form-control-sm"
                               placeholder="Search nodes..." autocomplete="off"
                               style="padding-right: 28px; font-size: 0.8rem;">
                        <i class="bi bi-search position-absolute" style="right: 8px; top: 50%; transform: translateY(-50%); opacity: 0.5; font-size: 0.75rem;"></i>
                        <div id="global-search-results" class="position-absolute w-100 bg-body border rounded shadow-sm"
                             style="top: 100%; left: 0; max-height: 300px; overflow-y: auto; z-index: 1050; display: none; min-width: 250px;">
                        </div>
                    </div>
                    {% if APP_CONFIG.admin_enabled %}
                    <!-- Background Jobs Indicator -->
                    <a id="jobs-indicator" href="{{ url_for('admin.admin_page') }}?tab=jobs"
                       class="btn btn-outline-light btn-sm d-flex align-items-center d-none px-2"
                       title="Background jobs">
                        <i class="bi bi-list-task"></i>
                        <span class="jobs-count badge bg-primary ms-1" style="font-size: 0.65rem;">0</span>
                    </a>
                    <!-- Node Connection Indicator -->
                    <a id="node-connection-indicator" href="{{ url_for('admin.admin_page') }}"
                       class="btn btn-outline-light btn-sm d-flex align-items-center disconnected px-2"
                       title="Not connected to any node">
                        <i class="bi bi-broadcast connection-icon"></i>
                        <span class="connection-text d-none d-xl-inline ms-1" style="font-size: 0.75rem;">No Node</span>
                    </a>
                    {% endif %}
                    <div class="vr d-none d-lg-block mx-1" style="height: 20px; opacity: 0.3;"></div>
                    <button id="timezone-toggle" class="btn btn-outline-light btn-sm px-2" type="button"
                            title="Toggle timezone"
                            aria-label="Toggle timezone">
                        <i class="bi bi-globe"></i>
                    </button>
                    <button id="temperature-toggle" class="btn btn-outline-light btn-sm px-2" type="button"
                            title="Toggle temperature unit"
                            aria-label="Toggle temperature unit">
                        <i class="bi bi-thermometer-half"></i><span class="d-none d-xl-inline ms-1">C</span>
                    </button>
                    <button id="theme-toggle" class="btn btn-outline-light btn-sm px-2" type="button"
                            title="Toggle theme mode"
                            aria-label="Toggle theme mode">
                        <i class="bi bi-circle-half"></i>
                    </button>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        {% block content %}{% endblock %}
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <small>Powered by <a href="https://github.com/zenitraM/malla">Malla</a></small>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery (still used by some components) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- URL Filter Manager (global utility) -->
    <script src="{{ url_for('static', filename='js/url-filter-manager.js') }}"></script>
    <!-- NodeCache utility (shared across pages) -->
    <script src="{{ url_for('static', filename='js/node-cache.js') }}"></script>
    <!-- Dark Mode Toggle -->
    <script src="{{ url_for('static', filename='js/dark-mode-toggle.js') }}"></script>
    <!-- Timezone Utilities (must load before timezone toggle) -->
    <script src="{{ url_for('static', filename='js/timezone-utils.js') }}"></script>
    <!-- Timezone Toggle -->
    <script src="{{ url_for('static', filename='js/timezone-toggle.js') }}"></script>
    <!-- Temperature Toggle -->
    <script src="{{ url_for('static', filename='js/temperature-toggle.js') }}"></script>
    <!-- Node Connection Manager (global connection state) -->
    <script src="{{ url_for('static', filename='js/node-connection-manager.js') }}"></script>

    <!-- Node tooltip functionality -->
    <script>
        // Cache for node information to avoid repeated API calls
        const nodeInfoCache = new Map();

        // Initialize node tooltips
        function initializeNodeTooltips() {
            // Initialize all node-link elements with tooltips
            const nodeLinks = document.querySelectorAll('.node-link[data-node-id]');

            nodeLinks.forEach(link => {
                // If the node-id is 0xffffffff (the special node ID for broadcast),
                // don't add a link and replace the text with "Broadcast".
                if (link.getAttribute('data-node-id') === '4294967295') {
                    link.textContent = 'Broadcast';
                    link.style.cursor = 'default';
                    link.style.pointerEvents = 'none';
                    return;
                }

                const tooltip = new bootstrap.Tooltip(link, {
                    html: true,
                    trigger: 'hover',
                    delay: { show: 200, hide: 100 },
                    placement: 'top'
                });

                // Load node info on mouse enter
                link.addEventListener('mouseenter', async () => {
                    const nodeId = link.getAttribute('data-node-id');
                    if (nodeId && !nodeInfoCache.has(nodeId)) {
                        try {
                            const nodeInfo = await fetchNodeInfo(nodeId);
                            nodeInfoCache.set(nodeId, nodeInfo);
                            updateTooltipContent(link, nodeInfo);
                        } catch (error) {
                            console.error('Error loading node info:', error);
                            updateTooltipContent(link, { error: 'Failed to load node information' });
                        }
                    } else if (nodeInfoCache.has(nodeId)) {
                        updateTooltipContent(link, nodeInfoCache.get(nodeId));
                    }
                });
            });
        }

        // Fetch node information from cache first, fall back to API if necessary
        async function fetchNodeInfo(nodeId) {
            // Try NodeCache (populated by node-picker or preloaded)
            if (window.NodeCache) {
                const cachedNode = await window.NodeCache.getNode(nodeId);
                if (cachedNode) {
                    return cachedNode;
                }
            }

            // Fallback to API
            const response = await fetch(`/api/node/${nodeId}/info`);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            const data = await response.json();

            // Merge into NodeCache for future lookups
            if (window.NodeCache && (data.node || data).node_id !== undefined) {
                window.NodeCache.addNode(data.node || data);
            }
            return data;
        }

        // Update tooltip content with node information
        function updateTooltipContent(element, nodeInfo) {
            const tooltip = bootstrap.Tooltip.getInstance(element);
            if (!tooltip) return;

            if (nodeInfo.error) {
                tooltip.setContent({
                    '.tooltip-inner': `<div class="node-tooltip-content">
                        <div class="node-tooltip-header text-danger">Error</div>
                        <div class="node-tooltip-value">${nodeInfo.error}</div>
                    </div>`
                });
                return;
            }

            // Extract node data from the API response structure
            const node = nodeInfo.node || nodeInfo;
            const displayName = node.long_name || node.short_name || node.hex_id || 'Unknown Node';

            let content = `
                <div class="node-tooltip-content">
                    <div class="node-tooltip-header">${displayName}</div>
                    <div class="node-tooltip-row">
                        <span class="node-tooltip-label">ID:</span>
                        <span class="node-tooltip-value">${node.hex_id || 'Unknown'}</span>
                    </div>
            `;

            if (node.hw_model) {
                content += `
                    <div class="node-tooltip-row">
                        <span class="node-tooltip-label">Hardware:</span>
                        <span class="node-tooltip-value">${node.hw_model}</span>
                    </div>
                `;
            }

            if (node.last_packet_str) {
                content += `
                    <div class="node-tooltip-row">
                        <span class="node-tooltip-label">Last Packet:</span>
                        <span class="node-tooltip-value">${node.last_packet_str}</span>
                    </div>
                `;
            }

            if (node.packet_count_24h !== undefined) {
                content += `
                    <div class="node-tooltip-row">
                        <span class="node-tooltip-label">24h Packets:</span>
                        <span class="node-tooltip-value">${node.packet_count_24h}</span>
                    </div>
                `;
            }

            if (node.gateway_count_24h !== undefined && node.gateway_count_24h > 0) {
                content += `
                    <div class="node-tooltip-row">
                        <span class="node-tooltip-label">Heard by:</span>
                        <span class="node-tooltip-value">${node.gateway_count_24h} gateway${node.gateway_count_24h > 1 ? 's' : ''}</span>
                    </div>
                `;
            }

            content += '</div>';

            tooltip.setContent({
                '.tooltip-inner': content
            });
        }

        // Initialize tooltips when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeNodeTooltips();

            // Initialize all generic Bootstrap tooltips
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            [...tooltipTriggerList].forEach(tooltipTriggerEl => {
                new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Initialize theme toggle tooltip
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                new bootstrap.Tooltip(themeToggle);
            }

            // Initialize timezone toggle tooltip
            const timezoneToggle = document.getElementById('timezone-toggle');
            if (timezoneToggle) {
                new bootstrap.Tooltip(timezoneToggle);
            }
        });

        // Re-initialize tooltips when new content is loaded dynamically
        function reinitializeTooltips() {
            initializeNodeTooltips();
        }

        // Make reinitializeTooltips available globally for dynamic content
        window.reinitializeTooltips = reinitializeTooltips;
    </script>

    <!-- Background Jobs Indicator -->
    <script>
    (function() {
        const jobsIndicator = document.getElementById('jobs-indicator');
        if (!jobsIndicator) return;  // Admin not enabled

        const jobsCount = jobsIndicator.querySelector('.jobs-count');
        let pollInterval = null;

        async function updateJobsIndicator() {
            try {
                const response = await fetch('/api/jobs/active');
                if (!response.ok) return;

                const data = await response.json();
                const activeJobs = data.jobs || [];
                const runningCount = activeJobs.filter(j => j.status === 'running').length;
                const queuedCount = activeJobs.filter(j => j.status === 'queued').length;
                const totalActive = runningCount + queuedCount;

                if (totalActive > 0) {
                    jobsIndicator.classList.remove('d-none');
                    jobsCount.textContent = totalActive;

                    // Update styling based on state
                    if (runningCount > 0) {
                        jobsIndicator.classList.remove('btn-outline-light');
                        jobsIndicator.classList.add('btn-warning');
                        jobsIndicator.title = `${runningCount} running, ${queuedCount} queued`;
                    } else {
                        jobsIndicator.classList.remove('btn-warning');
                        jobsIndicator.classList.add('btn-outline-light');
                        jobsIndicator.title = `${queuedCount} jobs queued`;
                    }
                } else {
                    jobsIndicator.classList.add('d-none');
                }
            } catch (error) {
                console.debug('Failed to fetch jobs status:', error);
            }
        }

        function startPolling() {
            updateJobsIndicator();
            pollInterval = setInterval(updateJobsIndicator, 3000);
        }

        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }

        // Start polling when page becomes visible, stop when hidden
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopPolling();
            } else {
                startPolling();
            }
        });

        // Initial start
        if (!document.hidden) {
            startPolling();
        }
    })();
    </script>

    <!-- Global Node Search -->
    <script>
    (function() {
        const searchInput = document.getElementById('global-node-search');
        const resultsContainer = document.getElementById('global-search-results');

        if (!searchInput || !resultsContainer) return;

        let searchTimeout = null;
        let cachedNodes = null;

        // Fetch nodes for search (cached)
        async function fetchNodesForSearch() {
            if (cachedNodes) return cachedNodes;
            try {
                const response = await fetch('/api/nodes/data?limit=10000&page=1');
                const data = await response.json();
                cachedNodes = data.data || [];
                // Cache expires after 5 minutes
                setTimeout(() => { cachedNodes = null; }, 300000);
                return cachedNodes;
            } catch (err) {
                console.error('Error fetching nodes for search:', err);
                return [];
            }
        }

        // Perform search
        async function performSearch(query) {
            if (!query || query.length < 2) {
                resultsContainer.style.display = 'none';
                return;
            }

            const nodes = await fetchNodesForSearch();
            const lowerQuery = query.toLowerCase();

            // Search nodes
            const matches = nodes.filter(node => {
                const searchFields = [
                    node.node_name,
                    node.long_name,
                    node.short_name,
                    node.hex_id,
                    node.hw_model
                ].filter(Boolean).join(' ').toLowerCase();
                return searchFields.includes(lowerQuery);
            }).slice(0, 10); // Limit to 10 results

            if (matches.length === 0) {
                resultsContainer.innerHTML = '<div class="p-2 text-muted small">No nodes found</div>';
                resultsContainer.style.display = 'block';
                return;
            }

            let html = '';
            matches.forEach(node => {
                const name = node.node_name || node.long_name || node.short_name || 'Unnamed';
                const statusClass = node.packet_count_24h > 0 ? 'text-success' : 'text-muted';
                const statusIcon = node.packet_count_24h > 0 ? 'bi-circle-fill' : 'bi-circle';
                html += `
                    <a href="/node/${node.node_id}" class="d-flex align-items-center px-3 py-2 text-decoration-none border-bottom search-result-item"
                       style="transition: background 0.15s;">
                        <i class="bi ${statusIcon} ${statusClass} me-2" style="font-size: 0.5rem;"></i>
                        <div class="flex-grow-1 overflow-hidden">
                            <div class="text-body text-truncate">${name}</div>
                            <div class="text-muted small">${node.hex_id} · ${node.hw_model || 'Unknown'}</div>
                        </div>
                    </a>
                `;
            });

            if (nodes.filter(node => {
                const searchFields = [node.node_name, node.long_name, node.short_name, node.hex_id, node.hw_model].filter(Boolean).join(' ').toLowerCase();
                return searchFields.includes(lowerQuery);
            }).length > 10) {
                html += `<a href="/nodes?search=${encodeURIComponent(query)}" class="d-block px-3 py-2 text-center text-primary small">View all results →</a>`;
            }

            resultsContainer.innerHTML = html;
            resultsContainer.style.display = 'block';

            // Add hover effect
            resultsContainer.querySelectorAll('.search-result-item').forEach(item => {
                item.addEventListener('mouseenter', () => item.style.background = 'var(--bs-tertiary-bg)');
                item.addEventListener('mouseleave', () => item.style.background = '');
            });
        }

        // Debounced search
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                performSearch(this.value.trim());
            }, 200);
        });

        // Hide results when clicking outside
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
                resultsContainer.style.display = 'none';
            }
        });

        // Show results when focusing input with existing query
        searchInput.addEventListener('focus', function() {
            if (this.value.trim().length >= 2) {
                performSearch(this.value.trim());
            }
        });

        // Keyboard navigation
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                resultsContainer.style.display = 'none';
                this.blur();
            } else if (e.key === 'Enter') {
                const firstResult = resultsContainer.querySelector('a');
                if (firstResult) {
                    firstResult.click();
                }
            }
        });
    })();
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>
