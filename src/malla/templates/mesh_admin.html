{% extends "base.html" %}

{% block title %}Mesh Admin - {{ APP_NAME }}{% endblock %}

{% block extra_css %}
<style>
    .admin-card {
        transition: all 0.2s ease;
    }
    .admin-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .node-admin-badge {
        font-size: 0.7rem;
        padding: 2px 6px;
    }
    .command-btn {
        min-width: 120px;
    }
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }
    .status-connected {
        background-color: #198754;
        box-shadow: 0 0 8px rgba(25, 135, 84, 0.5);
    }
    .status-disconnected {
        background-color: #dc3545;
    }
    .log-entry {
        font-size: 0.875rem;
    }
    .log-timestamp {
        color: #6c757d;
        font-family: monospace;
    }
    .log-status-success {
        color: #198754;
    }
    .log-status-failed {
        color: #dc3545;
    }
    .log-status-pending {
        color: #ffc107;
    }
    .log-status-timeout {
        color: #fd7e14;
    }
    .config-display {
        font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Mono', monospace;
        font-size: 0.8rem;
        background: var(--bs-dark);
        color: #f8f9fa;
        padding: 1rem;
        border-radius: 0.5rem;
        max-height: 400px;
        overflow-y: auto;
    }
    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
    }
    #nodeSearchResults {
        max-height: 300px;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item active">Mesh Admin</li>
                </ol>
            </nav>
            <h1>
                <i class="bi bi-gear-wide-connected"></i> Mesh Admin
                <small class="text-muted fs-5">Remote Node Administration</small>
            </h1>
        </div>
    </div>

    <!-- Connection Status Card -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card admin-card">
                <div class="card-header">
                    <i class="bi bi-wifi"></i> Connection Status
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="connectionTypeSelect" class="form-label"><strong>Connection Type</strong></label>
                            <select class="form-select" id="connectionTypeSelect" onchange="changeConnectionType()">
                                <option value="mqtt" {{ 'selected' if connection_status.connection_type == 'mqtt' else '' }}>MQTT (via broker)</option>
                                <option value="tcp" {{ 'selected' if connection_status.connection_type == 'tcp' else '' }}>TCP (direct connection)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-2 mt-4">
                                <strong>Status:</strong>
                                <span id="connectionStatus">
                                    {% if connection_status.connected %}
                                        <span class="status-indicator status-connected"></span>Connected
                                    {% else %}
                                        <span class="status-indicator status-disconnected"></span>Disconnected
                                    {% endif %}
                                </span>
                            </p>
                        </div>
                    </div>

                    <!-- MQTT Settings -->
                    <div id="mqttSettings" class="{{ 'd-none' if connection_status.connection_type != 'mqtt' else '' }}">
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-2">
                                    <strong>MQTT Connected:</strong>
                                    <span id="mqttStatus">
                                        {% if connection_status.mqtt_connected %}
                                            <span class="badge bg-success">Yes</span>
                                        {% else %}
                                            <span class="badge bg-secondary">No</span>
                                        {% endif %}
                                    </span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-2">
                                    <strong>Gateway Node:</strong>
                                    <span id="gatewayNodeDisplay">
                                        {% if connection_status.gateway_node_hex %}
                                            <code>{{ connection_status.gateway_node_hex }}</code>
                                        {% else %}
                                            <span class="text-warning">Not configured</span>
                                        {% endif %}
                                    </span>
                                </p>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col">
                                <label for="gatewayNodeInput" class="form-label">Set Gateway Node ID</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="gatewayNodeInput"
                                           placeholder="e.g., !abcd1234 or 2882400052"
                                           value="{{ connection_status.gateway_node_hex or '' }}">
                                    <button class="btn btn-primary" type="button" onclick="setGatewayNode()">
                                        <i class="bi bi-check-lg"></i> Set Gateway
                                    </button>
                                </div>
                                <div class="form-text">
                                    The gateway node is the Meshtastic device connected to the MQTT broker that will relay admin commands.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TCP Settings -->
                    <div id="tcpSettings" class="{{ 'd-none' if connection_status.connection_type != 'tcp' else '' }}">
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label for="tcpHostInput" class="form-label">Node IP Address</label>
                                <input type="text" class="form-control" id="tcpHostInput"
                                       placeholder="192.168.1.1"
                                       value="{{ connection_status.tcp_host or '192.168.1.1' }}">
                            </div>
                            <div class="col-md-4">
                                <label for="tcpPortInput" class="form-label">Port</label>
                                <input type="number" class="form-control" id="tcpPortInput"
                                       placeholder="4403"
                                       value="{{ connection_status.tcp_port or 4403 }}">
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col">
                                <button class="btn btn-success me-2" type="button" onclick="tcpConnect()" id="tcpConnectBtn">
                                    <i class="bi bi-plug"></i> Connect
                                </button>
                                <button class="btn btn-outline-danger" type="button" onclick="tcpDisconnect()" id="tcpDisconnectBtn">
                                    <i class="bi bi-x-circle"></i> Disconnect
                                </button>
                            </div>
                        </div>
                        <div id="tcpConnectResult" class="alert d-none mt-2" role="alert"></div>
                        <div class="form-text">
                            Connect directly to a Meshtastic node via TCP. The node must have WiFi enabled and be accessible on the network.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Test Node Card -->
        <div class="col-lg-6">
            <div class="card admin-card">
                <div class="card-header">
                    <i class="bi bi-search"></i> Test Node Admin Access
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        Test if a node has this server's public key configured and can be remotely administered.
                    </p>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="testNodeInput"
                               placeholder="Enter node ID (e.g., !abcd1234)">
                        <button class="btn btn-outline-primary" type="button" onclick="testNodeAdmin()" id="testNodeBtn">
                            <i class="bi bi-lightning"></i> Test
                        </button>
                    </div>
                    <div id="testNodeResult" class="alert d-none" role="alert"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Tabs -->
    <div class="row">
        <div class="col">
            <ul class="nav nav-tabs" id="adminTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="nodes-tab" data-bs-toggle="tab"
                            data-bs-target="#nodes-pane" type="button" role="tab">
                        <i class="bi bi-router"></i> Administrable Nodes
                        <span class="badge bg-primary">{{ administrable_nodes|length }}</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="commands-tab" data-bs-toggle="tab"
                            data-bs-target="#commands-pane" type="button" role="tab">
                        <i class="bi bi-terminal"></i> Send Command
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="log-tab" data-bs-toggle="tab"
                            data-bs-target="#log-pane" type="button" role="tab">
                        <i class="bi bi-journal-text"></i> Audit Log
                    </button>
                </li>
            </ul>

            <div class="tab-content border border-top-0 rounded-bottom p-3" id="adminTabContent">
                <!-- Administrable Nodes Tab -->
                <div class="tab-pane fade show active" id="nodes-pane" role="tabpanel">
                    {% if administrable_nodes %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Node</th>
                                        <th>Hardware</th>
                                        <th>Firmware</th>
                                        <th>First Confirmed</th>
                                        <th>Last Confirmed</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for node in administrable_nodes %}
                                    <tr>
                                        <td>
                                            <a href="/node/{{ node.node_id }}" class="text-decoration-none">
                                                <strong>{{ node.long_name or node.short_name or 'Unknown' }}</strong>
                                            </a>
                                            <br>
                                            <code class="text-muted small">{{ node.hex_id or ('!' + '%08x'|format(node.node_id)) }}</code>
                                        </td>
                                        <td>{{ node.hw_model or 'Unknown' }}</td>
                                        <td>{{ node.firmware_version or 'Unknown' }}</td>
                                        <td>
                                            <span class="text-muted small">
                                                {{ node.first_confirmed | timestamp_to_datetime }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="text-muted small">
                                                {{ node.last_confirmed | timestamp_to_datetime }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary"
                                                        onclick="selectNode({{ node.node_id }})"
                                                        title="Select for commands">
                                                    <i class="bi bi-cursor"></i>
                                                </button>
                                                <button class="btn btn-outline-info"
                                                        onclick="getNodeConfig({{ node.node_id }}, 'device')"
                                                        title="Get device config">
                                                    <i class="bi bi-gear"></i>
                                                </button>
                                                <button class="btn btn-outline-warning"
                                                        onclick="confirmReboot({{ node.node_id }})"
                                                        title="Reboot node">
                                                    <i class="bi bi-arrow-clockwise"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
                            <h4 class="mt-3">No Administrable Nodes Found</h4>
                            <p class="text-muted">
                                Nodes will appear here once they respond to admin requests.<br>
                                Use the "Test Node Admin Access" feature above to check if a node is administrable.
                            </p>
                        </div>
                    {% endif %}
                </div>

                <!-- Send Command Tab -->
                <div class="tab-pane fade" id="commands-pane" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="mb-3">
                                <label for="targetNodeInput" class="form-label">Target Node ID</label>
                                <input type="text" class="form-control" id="targetNodeInput"
                                       placeholder="e.g., !abcd1234 or 2882400052">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Configuration Requests</label>
                                <div class="d-flex flex-wrap gap-2">
                                    <button class="btn btn-outline-secondary command-btn"
                                            onclick="getConfig('device')">
                                        <i class="bi bi-cpu"></i> Device
                                    </button>
                                    <button class="btn btn-outline-secondary command-btn"
                                            onclick="getConfig('lora')">
                                        <i class="bi bi-broadcast"></i> LoRa
                                    </button>
                                    <button class="btn btn-outline-secondary command-btn"
                                            onclick="getConfig('position')">
                                        <i class="bi bi-geo-alt"></i> Position
                                    </button>
                                    <button class="btn btn-outline-secondary command-btn"
                                            onclick="getConfig('power')">
                                        <i class="bi bi-battery-charging"></i> Power
                                    </button>
                                    <button class="btn btn-outline-secondary command-btn"
                                            onclick="getConfig('network')">
                                        <i class="bi bi-wifi"></i> Network
                                    </button>
                                    <button class="btn btn-outline-secondary command-btn"
                                            onclick="getConfig('display')">
                                        <i class="bi bi-display"></i> Display
                                    </button>
                                    <button class="btn btn-outline-secondary command-btn"
                                            onclick="getConfig('bluetooth')">
                                        <i class="bi bi-bluetooth"></i> Bluetooth
                                    </button>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Channel Requests</label>
                                <div class="d-flex flex-wrap gap-2">
                                    {% for i in range(8) %}
                                    <button class="btn btn-outline-info btn-sm"
                                            onclick="getChannel({{ i }})">
                                        Ch {{ i }}
                                    </button>
                                    {% endfor %}
                                </div>
                            </div>

                            <hr>

                            <div class="mb-3">
                                <label class="form-label text-danger">Dangerous Commands</label>
                                <div class="d-flex flex-wrap gap-2">
                                    <button class="btn btn-warning command-btn" onclick="confirmRebootTarget()">
                                        <i class="bi bi-arrow-clockwise"></i> Reboot
                                    </button>
                                    <button class="btn btn-danger command-btn" onclick="confirmShutdownTarget()">
                                        <i class="bi bi-power"></i> Shutdown
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6">
                            <label class="form-label">Response</label>
                            <div id="commandResponse" class="config-display">
                                <span class="text-muted">Response will appear here...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Audit Log Tab -->
                <div class="tab-pane fade" id="log-pane" role="tabpanel">
                    <div class="mb-3">
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshLog()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                    <div id="auditLogContainer">
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalTitle">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                Are you sure?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmModalBtn">Confirm</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let selectedNodeId = null;

    // Change connection type
    async function changeConnectionType() {
        const connType = document.getElementById('connectionTypeSelect').value;

        // Show/hide appropriate settings
        document.getElementById('mqttSettings').classList.toggle('d-none', connType !== 'mqtt');
        document.getElementById('tcpSettings').classList.toggle('d-none', connType !== 'tcp');

        try {
            const response = await fetch('/api/admin/connection-type', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ connection_type: connType })
            });
            const data = await response.json();

            if (data.success) {
                showAlert('success', `Connection type changed to ${connType.toUpperCase()}`);
                updateConnectionStatus();
            } else {
                showAlert('danger', data.error || 'Failed to change connection type');
            }
        } catch (error) {
            showAlert('danger', 'Error: ' + error.message);
        }
    }

    // TCP Connect
    async function tcpConnect() {
        const host = document.getElementById('tcpHostInput').value.trim();
        const port = parseInt(document.getElementById('tcpPortInput').value) || 4403;

        const btn = document.getElementById('tcpConnectBtn');
        const resultDiv = document.getElementById('tcpConnectResult');

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Connecting...';

        try {
            const response = await fetch('/api/admin/tcp/connect', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ host: host, port: port })
            });
            const data = await response.json();

            resultDiv.classList.remove('d-none', 'alert-success', 'alert-danger');

            if (data.success) {
                resultDiv.classList.add('alert-success');
                resultDiv.innerHTML = `<i class="bi bi-check-circle"></i> Connected to ${data.host}:${data.port}` +
                    (data.local_node_hex ? ` (Local Node: ${data.local_node_hex})` : '');
                updateConnectionStatus();
            } else {
                resultDiv.classList.add('alert-danger');
                resultDiv.innerHTML = `<i class="bi bi-x-circle"></i> ${data.error || 'Failed to connect'}`;
            }
        } catch (error) {
            resultDiv.classList.remove('d-none', 'alert-success');
            resultDiv.classList.add('alert-danger');
            resultDiv.innerHTML = `<i class="bi bi-x-circle"></i> Error: ${error.message}`;
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-plug"></i> Connect';
        }
    }

    // TCP Disconnect
    async function tcpDisconnect() {
        const btn = document.getElementById('tcpDisconnectBtn');
        const resultDiv = document.getElementById('tcpConnectResult');

        btn.disabled = true;

        try {
            const response = await fetch('/api/admin/tcp/disconnect', {
                method: 'POST'
            });
            const data = await response.json();

            resultDiv.classList.remove('d-none', 'alert-success', 'alert-danger');

            if (data.success) {
                resultDiv.classList.add('alert-success');
                resultDiv.innerHTML = '<i class="bi bi-check-circle"></i> Disconnected';
                updateConnectionStatus();
            } else {
                resultDiv.classList.add('alert-danger');
                resultDiv.innerHTML = `<i class="bi bi-x-circle"></i> ${data.error || 'Failed to disconnect'}`;
            }
        } catch (error) {
            resultDiv.classList.remove('d-none', 'alert-success');
            resultDiv.classList.add('alert-danger');
            resultDiv.innerHTML = `<i class="bi bi-x-circle"></i> Error: ${error.message}`;
        } finally {
            btn.disabled = false;
        }
    }

    // Update connection status display
    async function updateConnectionStatus() {
        try {
            const response = await fetch('/api/admin/status');
            const data = await response.json();

            const statusSpan = document.getElementById('connectionStatus');
            if (data.connected) {
                statusSpan.innerHTML = '<span class="status-indicator status-connected"></span>Connected';
            } else {
                statusSpan.innerHTML = '<span class="status-indicator status-disconnected"></span>Disconnected';
            }

            // Update gateway display if available
            if (data.gateway_node_hex) {
                document.getElementById('gatewayNodeDisplay').innerHTML = `<code>${data.gateway_node_hex}</code>`;
            }
        } catch (error) {
            console.error('Failed to update connection status:', error);
        }
    }

    // Set gateway node
    async function setGatewayNode() {
        const nodeId = document.getElementById('gatewayNodeInput').value.trim();
        if (!nodeId) {
            alert('Please enter a node ID');
            return;
        }

        try {
            const response = await fetch('/api/admin/gateway', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ node_id: nodeId })
            });
            const data = await response.json();

            if (data.success) {
                document.getElementById('gatewayNodeDisplay').innerHTML =
                    `<code>${data.gateway_node_hex}</code>`;
                showAlert('success', 'Gateway node set successfully');
            } else {
                showAlert('danger', data.error || 'Failed to set gateway node');
            }
        } catch (error) {
            showAlert('danger', 'Error: ' + error.message);
        }
    }

    // Test node admin access
    async function testNodeAdmin() {
        const nodeId = document.getElementById('testNodeInput').value.trim();
        if (!nodeId) {
            alert('Please enter a node ID');
            return;
        }

        const btn = document.getElementById('testNodeBtn');
        const resultDiv = document.getElementById('testNodeResult');

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Testing...';
        resultDiv.classList.add('d-none');

        try {
            const response = await fetch(`/api/admin/node/${encodeURIComponent(nodeId)}/test`, {
                method: 'POST'
            });
            const data = await response.json();

            resultDiv.classList.remove('d-none', 'alert-success', 'alert-warning', 'alert-danger');

            if (data.success && data.administrable) {
                resultDiv.classList.add('alert-success');
                resultDiv.innerHTML = `<i class="bi bi-check-circle"></i> <strong>Success!</strong>
                    Node ${data.hex_id} is administrable and responded to the test request.`;
            } else {
                resultDiv.classList.add('alert-warning');
                resultDiv.innerHTML = `<i class="bi bi-exclamation-triangle"></i> <strong>Not Administrable</strong><br>
                    ${data.error || 'Node did not respond. It may not have this server\'s public key configured.'}`;
            }
        } catch (error) {
            resultDiv.classList.remove('d-none');
            resultDiv.classList.add('alert-danger');
            resultDiv.innerHTML = `<i class="bi bi-x-circle"></i> Error: ${error.message}`;
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-lightning"></i> Test';
        }
    }

    // Select node for commands
    function selectNode(nodeId) {
        selectedNodeId = nodeId;
        document.getElementById('targetNodeInput').value = nodeId;

        // Switch to commands tab
        const commandsTab = document.getElementById('commands-tab');
        bootstrap.Tab.getOrCreateInstance(commandsTab).show();

        showAlert('info', `Selected node ${nodeId} for commands`);
    }

    // Get configuration
    async function getConfig(configType) {
        const nodeId = document.getElementById('targetNodeInput').value.trim();
        if (!nodeId) {
            alert('Please enter a target node ID');
            return;
        }

        showCommandResponse('Loading...');

        try {
            const response = await fetch(`/api/admin/node/${encodeURIComponent(nodeId)}/config/${configType}`);
            const data = await response.json();

            if (data.success) {
                showCommandResponse(JSON.stringify(data.config, null, 2));
            } else {
                showCommandResponse(`Error: ${data.error}`, true);
            }
        } catch (error) {
            showCommandResponse(`Error: ${error.message}`, true);
        }
    }

    // Get channel
    async function getChannel(channelIndex) {
        const nodeId = document.getElementById('targetNodeInput').value.trim();
        if (!nodeId) {
            alert('Please enter a target node ID');
            return;
        }

        showCommandResponse('Loading...');

        try {
            const response = await fetch(`/api/admin/node/${encodeURIComponent(nodeId)}/channel/${channelIndex}`);
            const data = await response.json();

            if (data.success) {
                showCommandResponse(JSON.stringify(data.channel, null, 2));
            } else {
                showCommandResponse(`Error: ${data.error}`, true);
            }
        } catch (error) {
            showCommandResponse(`Error: ${error.message}`, true);
        }
    }

    // Get node config shortcut from nodes table
    async function getNodeConfig(nodeId, configType) {
        document.getElementById('targetNodeInput').value = nodeId;

        // Switch to commands tab
        const commandsTab = document.getElementById('commands-tab');
        bootstrap.Tab.getOrCreateInstance(commandsTab).show();

        await getConfig(configType);
    }

    // Confirm reboot from nodes table
    function confirmReboot(nodeId) {
        showConfirmModal(
            'Confirm Reboot',
            `Are you sure you want to reboot node ${nodeId}?<br><br>
            <span class="text-muted">The node will restart in 5 seconds after the command is sent.</span>`,
            async () => {
                await sendReboot(nodeId);
            }
        );
    }

    // Confirm reboot target node
    function confirmRebootTarget() {
        const nodeId = document.getElementById('targetNodeInput').value.trim();
        if (!nodeId) {
            alert('Please enter a target node ID');
            return;
        }
        confirmReboot(nodeId);
    }

    // Confirm shutdown target node
    function confirmShutdownTarget() {
        const nodeId = document.getElementById('targetNodeInput').value.trim();
        if (!nodeId) {
            alert('Please enter a target node ID');
            return;
        }
        showConfirmModal(
            'Confirm Shutdown',
            `<strong class="text-danger">Warning!</strong> Are you sure you want to shut down node ${nodeId}?<br><br>
            <span class="text-muted">The node will power off and will need to be manually restarted.</span>`,
            async () => {
                await sendShutdown(nodeId);
            }
        );
    }

    // Send reboot command
    async function sendReboot(nodeId) {
        showCommandResponse('Sending reboot command...');

        try {
            const response = await fetch(`/api/admin/node/${encodeURIComponent(nodeId)}/reboot`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ delay_seconds: 5 })
            });
            const data = await response.json();

            if (data.success) {
                showCommandResponse(data.message);
                showAlert('success', data.message);
            } else {
                showCommandResponse(`Error: ${data.error}`, true);
            }
        } catch (error) {
            showCommandResponse(`Error: ${error.message}`, true);
        }
    }

    // Send shutdown command
    async function sendShutdown(nodeId) {
        showCommandResponse('Sending shutdown command...');

        try {
            const response = await fetch(`/api/admin/node/${encodeURIComponent(nodeId)}/shutdown`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ delay_seconds: 5 })
            });
            const data = await response.json();

            if (data.success) {
                showCommandResponse(data.message);
                showAlert('warning', data.message);
            } else {
                showCommandResponse(`Error: ${data.error}`, true);
            }
        } catch (error) {
            showCommandResponse(`Error: ${error.message}`, true);
        }
    }

    // Show command response
    function showCommandResponse(content, isError = false) {
        const container = document.getElementById('commandResponse');
        if (isError) {
            container.innerHTML = `<span class="text-danger">${content}</span>`;
        } else {
            container.textContent = content;
        }
    }

    // Refresh audit log
    async function refreshLog() {
        const container = document.getElementById('auditLogContainer');
        container.innerHTML = `
            <div class="text-center py-3">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        `;

        try {
            const response = await fetch('/api/admin/log?limit=50');
            const data = await response.json();

            if (data.log && data.log.length > 0) {
                let html = `
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Target</th>
                                    <th>Command</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                for (const entry of data.log) {
                    const timestamp = new Date(entry.timestamp * 1000).toLocaleString();
                    const statusClass = `log-status-${entry.status}`;

                    html += `
                        <tr class="log-entry">
                            <td class="log-timestamp">${timestamp}</td>
                            <td><code>${entry.target_node_hex || entry.target_node_id}</code></td>
                            <td>${entry.command_type}</td>
                            <td class="${statusClass}">
                                <i class="bi bi-${getStatusIcon(entry.status)}"></i>
                                ${entry.status}
                            </td>
                        </tr>
                    `;
                }

                html += '</tbody></table></div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-journal"></i> No admin commands logged yet
                    </div>
                `;
            }
        } catch (error) {
            container.innerHTML = `
                <div class="alert alert-danger">
                    Error loading audit log: ${error.message}
                </div>
            `;
        }
    }

    function getStatusIcon(status) {
        const icons = {
            'success': 'check-circle-fill',
            'failed': 'x-circle-fill',
            'pending': 'clock-fill',
            'timeout': 'exclamation-triangle-fill'
        };
        return icons[status] || 'question-circle';
    }

    // Show confirmation modal
    function showConfirmModal(title, body, onConfirm) {
        document.getElementById('confirmModalTitle').textContent = title;
        document.getElementById('confirmModalBody').innerHTML = body;

        const confirmBtn = document.getElementById('confirmModalBtn');
        confirmBtn.onclick = async () => {
            const modal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
            modal.hide();
            await onConfirm();
        };

        const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
        modal.show();
    }

    // Show toast alert
    function showAlert(type, message) {
        // Create a simple alert at the top of the page
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 80px; right: 20px; z-index: 9999; max-width: 400px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);

        // Auto-remove after 5 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Load audit log when tab is shown
        document.getElementById('log-tab').addEventListener('shown.bs.tab', function() {
            refreshLog();
        });
    });
</script>
{% endblock %}
