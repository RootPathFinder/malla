{% extends "base.html" %}

{% block title %}Network Insights - {{ APP_NAME }}{% endblock %}

{% block extra_css %}
<style>
    /* Health Score Ring */
    .health-score-container {
        position: relative;
        width: 180px;
        height: 180px;
        margin: 0 auto;
    }

    .health-score-ring {
        transform: rotate(-90deg);
    }

    .health-score-bg {
        fill: none;
        stroke: var(--bs-border-color);
        stroke-width: 12;
    }

    .health-score-fill {
        fill: none;
        stroke-width: 12;
        stroke-linecap: round;
        transition: stroke-dashoffset 1s ease-out, stroke 0.3s;
    }

    .health-score-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }

    .health-score-value {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1;
    }

    .health-score-label {
        font-size: 0.875rem;
        color: var(--bs-secondary-color);
    }

    /* Insight Cards */
    .insight-card {
        border-left: 4px solid;
        transition: transform 0.15s, box-shadow 0.15s;
        cursor: pointer;
    }

    .insight-card:hover {
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .insight-card.priority-high { border-left-color: #dc3545; }
    .insight-card.priority-medium { border-left-color: #ffc107; }
    .insight-card.priority-low { border-left-color: #0dcaf0; }
    .insight-card.priority-good { border-left-color: #198754; }

    .insight-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .insight-icon.priority-high { background: rgba(220, 53, 69, 0.1); color: #dc3545; }
    .insight-icon.priority-medium { background: rgba(255, 193, 7, 0.1); color: #b38600; }
    .insight-icon.priority-low { background: rgba(13, 202, 240, 0.1); color: #0dcaf0; }
    .insight-icon.priority-good { background: rgba(25, 135, 84, 0.1); color: #198754; }

    /* Activity Calendar (30-day view) */
    .activity-calendar {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
    }

    .calendar-day {
        aspect-ratio: 1;
        border-radius: 6px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        cursor: pointer;
        transition: transform 0.15s;
        position: relative;
    }

    .calendar-day:hover {
        transform: scale(1.1);
        z-index: 10;
    }

    .calendar-day .day-num {
        font-weight: 600;
        font-size: 0.875rem;
    }

    .calendar-day .day-label {
        font-size: 0.625rem;
        color: var(--bs-secondary-color);
    }

    .calendar-day.today {
        outline: 2px solid var(--bs-primary);
        outline-offset: 2px;
    }

    .calendar-day.future {
        opacity: 0.3;
        pointer-events: none;
    }

    /* Activity level colors */
    .activity-none { background: var(--bs-tertiary-bg); }
    .activity-low { background: #c7f3e3; }
    .activity-medium { background: #69d9a8; }
    .activity-high { background: #2ecc71; }
    .activity-very-high { background: #1a8d4e; color: white; }

    /* Dark mode activity colors */
    [data-bs-theme="dark"] .activity-none { background: var(--bs-tertiary-bg); }
    [data-bs-theme="dark"] .activity-low { background: #1e4a35; }
    [data-bs-theme="dark"] .activity-medium { background: #2a6b4a; }
    [data-bs-theme="dark"] .activity-high { background: #2ecc71; }
    [data-bs-theme="dark"] .activity-very-high { background: #3dd882; color: #000; }

    /* Trend Sparklines */
    .sparkline-container {
        height: 60px;
        width: 100%;
    }

    /* Stats Cards */
    .stat-card {
        text-align: center;
        padding: 1.25rem;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        line-height: 1.2;
    }

    .stat-label {
        font-size: 0.75rem;
        color: var(--bs-secondary-color);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .stat-trend {
        font-size: 0.75rem;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .stat-trend.up { color: #198754; }
    .stat-trend.down { color: #dc3545; }
    .stat-trend.stable { color: var(--bs-secondary-color); }

    /* Node Health List */
    .node-health-item {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        background: var(--bs-tertiary-bg);
        transition: background 0.15s;
    }

    .node-health-item:hover {
        background: var(--bs-secondary-bg);
    }

    .node-health-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 12px;
    }

    .node-health-indicator.healthy { background: #198754; }
    .node-health-indicator.warning { background: #ffc107; }
    .node-health-indicator.critical { background: #dc3545; }
    .node-health-indicator.offline { background: #6c757d; }

    /* Section Headers */
    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
    }

    .section-title {
        font-size: 1.125rem;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--bs-secondary-color);
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h1><i class="bi bi-activity"></i> Network Insights</h1>
            <p class="text-muted">Monitor network health, trends, and actionable insights</p>
        </div>
        <div class="col-auto">
            <button class="btn btn-outline-secondary" id="refreshBtn">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Top Row: Health Score + Key Stats -->
    <div class="row mb-4">
        <!-- Network Health Score -->
        <div class="col-lg-3 col-md-4 mb-3 mb-lg-0">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="text-muted mb-3 text-center">Network Health</h6>
                    <div class="health-score-container">
                        <svg class="health-score-ring" viewBox="0 0 180 180">
                            <circle class="health-score-bg" cx="90" cy="90" r="78"/>
                            <circle class="health-score-fill" id="healthRing" cx="90" cy="90" r="78"
                                stroke-dasharray="490" stroke-dashoffset="490"/>
                        </svg>
                        <div class="health-score-text">
                            <div class="health-score-value" id="healthScore">--</div>
                            <div class="health-score-label" id="healthLabel">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Key Stats -->
        <div class="col-lg-9 col-md-8">
            <div class="row g-3">
                <div class="col-6 col-lg-3">
                    <div class="card stat-card h-100">
                        <div class="stat-value text-primary" id="activeNodes">--</div>
                        <div class="stat-label">Active Nodes</div>
                        <div class="stat-trend" id="activeNodesTrend">
                            <span>vs last week</span>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="card stat-card h-100">
                        <div class="stat-value text-success" id="packetsToday">--</div>
                        <div class="stat-label">Packets (24h)</div>
                        <div class="stat-trend" id="packetsTrend">
                            <span>vs yesterday</span>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="card stat-card h-100">
                        <div class="stat-value" id="avgSignal">--</div>
                        <div class="stat-label">Avg Signal (SNR)</div>
                        <div class="stat-trend" id="signalTrend">
                            <span>vs last week</span>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="card stat-card h-100">
                        <div class="stat-value" id="successRate">--%</div>
                        <div class="stat-label">Success Rate</div>
                        <div class="stat-trend" id="successTrend">
                            <span>vs last week</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="row">
        <!-- Left Column: Insights -->
        <div class="col-lg-8 mb-4">
            <!-- Action Items / Insights -->
            <div class="card mb-4">
                <div class="card-header">
                    <div class="section-header mb-0">
                        <h5 class="section-title mb-0">
                            <i class="bi bi-lightbulb"></i> Insights & Recommendations
                        </h5>
                        <span class="badge bg-secondary" id="insightCount">0</span>
                    </div>
                </div>
                <div class="card-body" id="insightsList">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
            </div>

            <!-- 30-Day Activity Calendar -->
            <div class="card">
                <div class="card-header">
                    <div class="section-header mb-0">
                        <h5 class="section-title mb-0">
                            <i class="bi bi-calendar3"></i> 30-Day Activity
                        </h5>
                        <div class="d-flex align-items-center gap-2">
                            <span class="text-muted small">Less</span>
                            <div class="d-flex gap-1">
                                <div class="activity-none" style="width:16px;height:16px;border-radius:3px;"></div>
                                <div class="activity-low" style="width:16px;height:16px;border-radius:3px;"></div>
                                <div class="activity-medium" style="width:16px;height:16px;border-radius:3px;"></div>
                                <div class="activity-high" style="width:16px;height:16px;border-radius:3px;"></div>
                                <div class="activity-very-high" style="width:16px;height:16px;border-radius:3px;"></div>
                            </div>
                            <span class="text-muted small">More</span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="activityCalendar" class="activity-calendar">
                        <div class="text-center py-4 col-span-7">Loading...</div>
                    </div>
                    <div id="calendarDetails" class="mt-3 p-3 bg-light rounded d-none">
                        <!-- Details shown when clicking a day -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Node Health -->
        <div class="col-lg-4 mb-4">
            <!-- Node Health Overview -->
            <div class="card mb-4">
                <div class="card-header">
                    <div class="section-header mb-0">
                        <h5 class="section-title mb-0">
                            <i class="bi bi-heart-pulse"></i> Node Health
                        </h5>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Health Distribution -->
                    <div class="row g-2 mb-3">
                        <div class="col-3 text-center">
                            <div class="h4 mb-0 text-success" id="healthyCount">--</div>
                            <small class="text-muted">Healthy</small>
                        </div>
                        <div class="col-3 text-center">
                            <div class="h4 mb-0 text-warning" id="warningCount">--</div>
                            <small class="text-muted">Warning</small>
                        </div>
                        <div class="col-3 text-center">
                            <div class="h4 mb-0 text-danger" id="criticalCount">--</div>
                            <small class="text-muted">Critical</small>
                        </div>
                        <div class="col-3 text-center">
                            <div class="h4 mb-0 text-secondary" id="offlineCount">--</div>
                            <small class="text-muted">Offline</small>
                        </div>
                    </div>

                    <!-- Nodes Needing Attention -->
                    <h6 class="text-muted mb-2">Needs Attention</h6>
                    <div id="nodeHealthList" style="max-height: 400px; overflow-y: auto;">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="card">
                <div class="card-header">
                    <h5 class="section-title mb-0">
                        <i class="bi bi-speedometer2"></i> Network Vitals
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <span class="text-muted">Infrastructure Nodes</span>
                        <strong id="infraNodes">--</strong>
                    </div>
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <span class="text-muted">Client Nodes</span>
                        <strong id="clientNodes">--</strong>
                    </div>
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <span class="text-muted">Solar Powered</span>
                        <strong id="solarNodes">--</strong>
                    </div>
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <span class="text-muted">Low Battery Nodes</span>
                        <strong id="lowBatteryNodes" class="text-warning">--</strong>
                    </div>
                    <div class="d-flex justify-content-between align-items-center py-2">
                        <span class="text-muted">Avg Battery Level</span>
                        <strong id="avgBattery">--%</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Day Detail Modal -->
<div class="modal fade" id="dayDetailModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dayDetailTitle">Activity Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="dayDetailBody">
                <!-- Populated dynamically -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    let insightsData = null;
    let calendarData = null;
    let refreshInterval = null;

    document.addEventListener('DOMContentLoaded', function() {
        loadAllData();

        document.getElementById('refreshBtn').addEventListener('click', loadAllData);

        // Auto-refresh every 60 seconds
        refreshInterval = setInterval(loadAllData, 60000);
    });

    async function loadAllData() {
        try {
            // Load all data in parallel
            const [insights, calendar, health, vitals] = await Promise.all([
                fetch('/alerts/api/insights').then(r => r.json()),
                fetch('/alerts/api/activity-calendar').then(r => r.json()),
                fetch('/alerts/api/node-health').then(r => r.json()),
                fetch('/alerts/api/network-vitals').then(r => r.json())
            ]);

            insightsData = insights;
            calendarData = calendar;

            renderHealthScore(insights.health_score);
            renderStats(vitals);
            renderInsights(insights.insights);
            renderCalendar(calendar);
            renderNodeHealth(health);
            renderVitals(vitals);

        } catch (error) {
            console.error('Error loading insights data:', error);
            showError('Failed to load network insights');
        }
    }

    function renderHealthScore(score) {
        const ring = document.getElementById('healthRing');
        const scoreEl = document.getElementById('healthScore');
        const labelEl = document.getElementById('healthLabel');

        const circumference = 2 * Math.PI * 78;
        const offset = circumference - (score / 100) * circumference;

        ring.style.strokeDashoffset = offset;
        scoreEl.textContent = score;

        // Set color based on score
        let color, label;
        if (score >= 90) {
            color = '#198754';
            label = 'Excellent';
        } else if (score >= 75) {
            color = '#20c997';
            label = 'Good';
        } else if (score >= 60) {
            color = '#ffc107';
            label = 'Fair';
        } else if (score >= 40) {
            color = '#fd7e14';
            label = 'Needs Attention';
        } else {
            color = '#dc3545';
            label = 'Critical';
        }

        ring.style.stroke = color;
        scoreEl.style.color = color;
        labelEl.textContent = label;
    }

    function renderStats(vitals) {
        document.getElementById('activeNodes').textContent = vitals.active_nodes_24h || 0;
        document.getElementById('packetsToday').textContent = formatNumber(vitals.packets_24h || 0);
        document.getElementById('avgSignal').textContent = (vitals.avg_snr || 0).toFixed(1) + ' dB';
        document.getElementById('successRate').textContent = (vitals.success_rate || 0).toFixed(0) + '%';

        // Render trends
        renderTrend('activeNodesTrend', vitals.active_nodes_trend, 'vs last week');
        renderTrend('packetsTrend', vitals.packets_trend, 'vs yesterday');
        renderTrend('signalTrend', vitals.signal_trend, 'vs last week');
        renderTrend('successTrend', vitals.success_trend, 'vs last week');
    }

    function renderTrend(elementId, trend, label) {
        const el = document.getElementById(elementId);
        if (!trend || trend === 0) {
            el.className = 'stat-trend stable';
            el.innerHTML = `<i class="bi bi-dash"></i> <span>${label}</span>`;
        } else if (trend > 0) {
            el.className = 'stat-trend up';
            el.innerHTML = `<i class="bi bi-arrow-up"></i> +${Math.abs(trend).toFixed(0)}% <span class="text-muted">${label}</span>`;
        } else {
            el.className = 'stat-trend down';
            el.innerHTML = `<i class="bi bi-arrow-down"></i> ${trend.toFixed(0)}% <span class="text-muted">${label}</span>`;
        }
    }

    function renderInsights(insights) {
        const container = document.getElementById('insightsList');
        document.getElementById('insightCount').textContent = insights.length;

        if (insights.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-check-circle text-success"></i>
                    <h5>All Systems Healthy</h5>
                    <p class="text-muted">No issues detected. Your network is running smoothly.</p>
                </div>
            `;
            return;
        }

        container.innerHTML = insights.map(insight => `
            <div class="card insight-card priority-${insight.priority} mb-2" onclick="handleInsightClick('${insight.id}')">
                <div class="card-body d-flex align-items-start">
                    <div class="insight-icon priority-${insight.priority} me-3">
                        <i class="bi bi-${insight.icon}"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${escapeHtml(insight.title)}</h6>
                        <p class="text-muted mb-2 small">${escapeHtml(insight.description)}</p>
                        ${insight.action ? `
                            <span class="badge bg-primary">
                                <i class="bi bi-arrow-right me-1"></i>${escapeHtml(insight.action)}
                            </span>
                        ` : ''}
                    </div>
                    ${insight.value ? `
                        <div class="text-end ms-3">
                            <div class="h4 mb-0">${insight.value}</div>
                            ${insight.value_label ? `<small class="text-muted">${insight.value_label}</small>` : ''}
                        </div>
                    ` : ''}
                </div>
            </div>
        `).join('');
    }

    function renderCalendar(data) {
        const container = document.getElementById('activityCalendar');

        // Generate last 30 days + padding to start on Sunday
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const days = [];
        for (let i = 29; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            days.push(date);
        }

        // Pad to start on Sunday
        const firstDay = days[0].getDay();
        const padding = [];
        for (let i = 0; i < firstDay; i++) {
            padding.push(null);
        }

        // Build activity lookup
        const activityMap = {};
        if (data.daily_activity) {
            data.daily_activity.forEach(d => {
                activityMap[d.date] = d;
            });
        }

        // Render day headers
        const dayLabels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        let html = dayLabels.map(d => `<div class="text-center text-muted small fw-bold">${d}</div>`).join('');

        // Render padding cells
        padding.forEach(() => {
            html += `<div class="calendar-day future"></div>`;
        });

        // Render day cells
        days.forEach(date => {
            const dateStr = formatDateKey(date);
            const activity = activityMap[dateStr] || { packets: 0, nodes: 0 };
            const isToday = date.getTime() === today.getTime();
            const isFuture = date > today;

            const activityLevel = getActivityLevel(activity.packets, data.max_packets || 1000);

            html += `
                <div class="calendar-day activity-${activityLevel} ${isToday ? 'today' : ''} ${isFuture ? 'future' : ''}"
                     onclick="showDayDetails('${dateStr}')"
                     title="${date.toLocaleDateString()}: ${activity.packets} packets, ${activity.nodes} nodes">
                    <span class="day-num">${date.getDate()}</span>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    function getActivityLevel(packets, maxPackets) {
        if (packets === 0) return 'none';
        const ratio = packets / maxPackets;
        if (ratio < 0.25) return 'low';
        if (ratio < 0.5) return 'medium';
        if (ratio < 0.75) return 'high';
        return 'very-high';
    }

    function renderNodeHealth(health) {
        document.getElementById('healthyCount').textContent = health.healthy || 0;
        document.getElementById('warningCount').textContent = health.warning || 0;
        document.getElementById('criticalCount').textContent = health.critical || 0;
        document.getElementById('offlineCount').textContent = health.offline || 0;

        const container = document.getElementById('nodeHealthList');

        if (!health.nodes_needing_attention || health.nodes_needing_attention.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-3">
                    <i class="bi bi-check-circle text-success"></i>
                    <p class="mb-0 mt-2">All nodes healthy</p>
                </div>
            `;
            return;
        }

        container.innerHTML = health.nodes_needing_attention.map(node => {
            // Determine badge text based on issue type
            let badgeText = node.value || '';
            if (!badgeText && node.issue) {
                if (node.issue.includes('Offline')) badgeText = 'Offline';
                else if (node.issue.includes('Inactive')) badgeText = 'Inactive';
                else if (node.issue.includes('Never')) badgeText = 'Unknown';
                else badgeText = node.status;
            }
            return `
            <a href="/node/${node.node_id_hex}" class="node-health-item text-decoration-none">
                <div class="node-health-indicator ${node.status}"></div>
                <div class="flex-grow-1">
                    <div class="fw-medium">${escapeHtml(node.name || node.node_id_hex)}</div>
                    <small class="text-muted">${escapeHtml(node.issue)}</small>
                </div>
                <span class="badge bg-${node.status === 'critical' ? 'danger' : node.status === 'warning' ? 'warning' : 'secondary'}">${badgeText}</span>
            </a>
        `}).join('');
    }

    function renderVitals(vitals) {
        document.getElementById('infraNodes').textContent = vitals.infrastructure_nodes || 0;
        document.getElementById('clientNodes').textContent = vitals.client_nodes || 0;
        document.getElementById('solarNodes').textContent = vitals.solar_nodes || 0;
        document.getElementById('lowBatteryNodes').textContent = vitals.low_battery_nodes || 0;
        document.getElementById('avgBattery').textContent = (vitals.avg_battery || 0).toFixed(0) + '%';
    }

    window.showDayDetails = function(dateStr) {
        if (!calendarData || !calendarData.daily_activity) return;

        const activity = calendarData.daily_activity.find(d => d.date === dateStr);
        if (!activity) return;

        const modal = new bootstrap.Modal(document.getElementById('dayDetailModal'));
        document.getElementById('dayDetailTitle').textContent = new Date(dateStr).toLocaleDateString(undefined, {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        document.getElementById('dayDetailBody').innerHTML = `
            <div class="row g-3">
                <div class="col-6">
                    <div class="text-center p-3 bg-light rounded">
                        <div class="h3 mb-0">${formatNumber(activity.packets)}</div>
                        <small class="text-muted">Packets</small>
                    </div>
                </div>
                <div class="col-6">
                    <div class="text-center p-3 bg-light rounded">
                        <div class="h3 mb-0">${activity.nodes}</div>
                        <small class="text-muted">Active Nodes</small>
                    </div>
                </div>
                <div class="col-6">
                    <div class="text-center p-3 bg-light rounded">
                        <div class="h3 mb-0">${activity.avg_snr ? activity.avg_snr.toFixed(1) : '--'} dB</div>
                        <small class="text-muted">Avg SNR</small>
                    </div>
                </div>
                <div class="col-6">
                    <div class="text-center p-3 bg-light rounded">
                        <div class="h3 mb-0">${activity.success_rate ? activity.success_rate.toFixed(0) : '--'}%</div>
                        <small class="text-muted">Success Rate</small>
                    </div>
                </div>
            </div>
            ${activity.peak_hour !== undefined ? `
                <div class="mt-3 p-3 bg-light rounded">
                    <small class="text-muted">Peak Activity</small>
                    <div class="fw-medium">${activity.peak_hour}:00 - ${(activity.peak_hour + 1) % 24}:00</div>
                </div>
            ` : ''}
        `;

        modal.show();
    };

    window.handleInsightClick = function(insightId) {
        // Handle insight actions - navigate or show detail
        if (!insightsData || !insightsData.insights) return;

        const insight = insightsData.insights.find(i => i.id === insightId);
        if (insight && insight.link) {
            window.location.href = insight.link;
        }
    };

    function formatNumber(num) {
        if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
        return num.toString();
    }

    function formatDateKey(date) {
        return date.toISOString().split('T')[0];
    }

    function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function showError(message) {
        document.getElementById('insightsList').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>${message}
            </div>
        `;
    }
})();
</script>
{% endblock %}
