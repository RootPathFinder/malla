{% extends "base.html" %}

{% block title %}Node Health - {{ APP_NAME }}{% endblock %}

{% block extra_css %}
<style>
    .health-score-badge {
        font-size: 1.5rem;
        font-weight: bold;
        padding: 0.5rem 1rem;
    }
    .health-healthy { background-color: #198754; }
    .health-degraded { background-color: #ffc107; color: #000; }
    .health-poor { background-color: #fd7e14; }
    .health-critical { background-color: #dc3545; }

    .issue-badge {
        font-size: 0.875rem;
        padding: 0.25rem 0.5rem;
        margin-right: 0.25rem;
    }
    .issue-critical { background-color: #dc3545; }
    .issue-warning { background-color: #ffc107; color: #000; }
    .issue-info { background-color: #0dcaf0; color: #000; }

    .metric-card {
        border-left: 4px solid #0d6efd;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .activity-chart {
        height: 200px;
    }

    /* Compact uptime visualization (matches node detail) */
    .uptime-compact-inline {
        display: flex;
        align-items: flex-start;
        gap: 3px;
    }

    .uptime-compact-inline .uptime-day {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
    }

    .uptime-compact-inline .uptime-day-blocks {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .uptime-compact-inline .uptime-block {
        height: 7px;
        border-radius: 2px;
        transition: opacity 0.15s, transform 0.15s;
        cursor: help;
    }

    .uptime-compact-inline .uptime-block:hover {
        opacity: 0.85;
        transform: scaleY(1.4);
    }

    .uptime-compact-inline .uptime-block.available { background: #198754; }
    .uptime-compact-inline .uptime-block.degraded { background: #ffc107; }
    .uptime-compact-inline .uptime-block.unavailable { background: #dc3545; }
    .uptime-compact-inline .uptime-block.future {
        background: var(--bs-secondary);
        opacity: 0.25;
        cursor: default;
    }
    .uptime-compact-inline .uptime-block.future:hover { transform: none; }

    .uptime-compact-inline .uptime-day-label {
        text-align: center;
        font-size: 0.55rem;
        color: var(--bs-secondary);
        margin-top: 3px;
        line-height: 1.1;
    }

    .uptime-compact-inline .uptime-day-label .day-name { font-weight: 600; }
    .uptime-compact-inline .uptime-day.today .day-name { color: var(--bs-primary); }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1><i class="bi bi-activity"></i> Node Health Monitoring</h1>
            <p class="text-muted">Identify and analyze problematic nodes in the mesh network</p>
        </div>
    </div>

    <!-- Network Health Summary -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-shield-check"></i> Network Health Summary</h5>
                </div>
                <div class="card-body">
                    <div id="network-summary-loading" class="text-center p-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading network health...</span>
                        </div>
                    </div>
                    <div id="network-summary-content" style="display: none;">
                        <div class="row">
                            <div class="col-md-3 text-center">
                                <div class="metric-card">
                                    <div class="metric-label">
                                        Network Health Score
                                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top"
                                           title="Overall network health (0-100) based on node reliability metrics: activity patterns, gateway connectivity, and outages. Does NOT include signal strength to avoid distance bias."></i>
                                    </div>
                                    <div class="metric-value" id="network-health-score">--</div>
                                </div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="metric-card">
                                    <div class="metric-label">
                                        Active Nodes
                                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top"
                                           title="Number of nodes that have transmitted at least one packet during the selected time period."></i>
                                    </div>
                                    <div class="metric-value" id="active-nodes-count">--</div>
                                </div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="metric-card">
                                    <div class="metric-label">
                                        Average RSSI
                                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top"
                                           title="Received Signal Strength Indicator in dBm. Higher values (closer to 0) indicate stronger signal. INFORMATIONAL ONLY - distance-dependent, does not affect health scores."></i>
                                    </div>
                                    <div class="metric-value" id="avg-rssi">--</div>
                                </div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="metric-card">
                                    <div class="metric-label">
                                        Average SNR
                                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top"
                                           title="Signal-to-Noise Ratio in dB. Higher values indicate clearer signal above background noise. INFORMATIONAL ONLY - distance-dependent, does not affect health scores."></i>
                                    </div>
                                    <div class="metric-value" id="avg-snr">--</div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6>
                                    Health Distribution
                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top"
                                       title="Distribution of node health statuses: Healthy (80-100), Degraded (60-79), Poor (40-59), Critical (0-39). Based on reliability metrics, not signal strength."></i>
                                </h6>
                                <div class="progress" style="height: 32px; font-size: 0.875rem;">
                                    <div class="progress-bar bg-success" role="progressbar" id="healthy-bar" style="width: 0%"
                                         data-bs-toggle="tooltip" data-bs-placement="top" title="">
                                        <span class="health-bar-text"><span id="healthy-count">0</span> <span class="health-label">Healthy</span></span>
                                    </div>
                                    <div class="progress-bar bg-warning" role="progressbar" id="degraded-bar" style="width: 0%"
                                         data-bs-toggle="tooltip" data-bs-placement="top" title="">
                                        <span class="health-bar-text"><span id="degraded-count">0</span> <span class="health-label">Degraded</span></span>
                                    </div>
                                    <div class="progress-bar bg-danger" role="progressbar" id="poor-bar" style="width: 0%"
                                         data-bs-toggle="tooltip" data-bs-placement="top" title="">
                                        <span class="health-bar-text"><span id="poor-count">0</span> <span class="health-label">Poor</span></span>
                                    </div>
                                    <div class="progress-bar bg-dark" role="progressbar" id="critical-bar" style="width: 0%"
                                         data-bs-toggle="tooltip" data-bs-placement="top" title="">
                                        <span class="health-bar-text"><span id="critical-count">0</span> <span class="health-label">Critical</span></span>
                                    </div>
                                </div>
                                <!-- Legend for small screens -->
                                <div class="d-flex justify-content-around mt-2 small text-muted d-lg-none">
                                    <span><span class="badge bg-success">■</span> <span id="healthy-legend">0</span> Healthy</span>
                                    <span><span class="badge bg-warning">■</span> <span id="degraded-legend">0</span> Degraded</span>
                                    <span><span class="badge bg-danger">■</span> <span id="poor-legend">0</span> Poor</span>
                                    <span><span class="badge bg-dark">■</span> <span id="critical-legend">0</span> Critical</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Uptime Overview (7-Day Availability) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history"></i> 7-Day Uptime Overview
                        <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip" data-bs-placement="top"
                           title="Node availability based on each node's baseline behavior. A node is 'available' when transmitting at or above its normal rate."></i>
                    </h5>
                    <div>
                        <span class="badge bg-success me-1">●</span><small class="text-muted me-3">Available</small>
                        <span class="badge bg-warning me-1">●</span><small class="text-muted me-3">Degraded</small>
                        <span class="badge bg-danger me-1">●</span><small class="text-muted">Unavailable</small>
                    </div>
                </div>
                <div class="card-body">
                    <div id="uptime-loading" class="text-center p-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading uptime data...</span>
                        </div>
                    </div>
                    <div id="uptime-content" style="display: none;">
                        <div class="row mb-3">
                            <div class="col-md-4 text-center">
                                <div class="metric-card">
                                    <div class="metric-label">Network Avg Uptime</div>
                                    <div class="metric-value" id="network-uptime">--%</div>
                                </div>
                            </div>
                            <div class="col-md-4 text-center">
                                <div class="metric-card">
                                    <div class="metric-label">Nodes Analyzed</div>
                                    <div class="metric-value" id="uptime-nodes-count">--</div>
                                </div>
                            </div>
                            <div class="col-md-4 text-center">
                                <div class="metric-card">
                                    <div class="metric-label">Nodes Below 90%</div>
                                    <div class="metric-value text-warning" id="low-uptime-count">--</div>
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-sm table-striped">
                                <thead class="sticky-top bg-body">
                                    <tr>
                                        <th style="min-width: 180px; cursor: pointer;" class="uptime-sortable-header" data-sort="node">
                                            Node <i class="bi bi-arrow-down-up text-muted" id="uptime-sort-node"></i>
                                        </th>
                                        <th class="text-center uptime-sortable-header" style="width: 80px; cursor: pointer;" data-sort="uptime">
                                            Uptime <i class="bi bi-arrow-down-up text-muted" id="uptime-sort-uptime"></i>
                                        </th>
                                        <th style="min-width: 200px;">7-Day Availability</th>
                                    </tr>
                                </thead>
                                <tbody id="uptime-tbody">
                                    <!-- Populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-3">
        <div class="col-md-4">
            <label for="hours-filter" class="form-label">Analysis Period</label>
            <select class="form-select" id="hours-filter">
                <option value="6">Last 6 hours</option>
                <option value="12">Last 12 hours</option>
                <option value="24" selected>Last 24 hours</option>
                <option value="48">Last 48 hours</option>
                <option value="72">Last 72 hours</option>
                <option value="168">Last 7 days</option>
            </select>
        </div>
        <div class="col-md-4">
            <label for="min-health-score" class="form-label">Max Health Score</label>
            <select class="form-select" id="min-health-score">
                <option value="100">Show All</option>
                <option value="80">Below 80 (Degraded+)</option>
                <option value="70" selected>Below 70 (Poor+)</option>
                <option value="60">Below 60</option>
                <option value="40">Below 40 (Critical)</option>
            </select>
        </div>
        <div class="col-md-4">
            <label for="limit-filter" class="form-label">Results Limit</label>
            <select class="form-select" id="limit-filter">
                <option value="10">10 nodes</option>
                <option value="25">25 nodes</option>
                <option value="50" selected>50 nodes</option>
                <option value="100">100 nodes</option>
            </select>
        </div>
    </div>

    <!-- Problematic Nodes Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Problematic Nodes</h5>
                    <button class="btn btn-sm btn-primary" id="refresh-btn">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div id="problematic-nodes-loading" class="text-center p-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading problematic nodes...</span>
                        </div>
                    </div>
                    <div id="problematic-nodes-content" style="display: none;">
                        <div id="no-issues" class="alert alert-success" style="display: none;">
                            <i class="bi bi-check-circle"></i> No problematic nodes found! All nodes are healthy.
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="problematic-nodes-table">
                                <thead>
                                    <tr>
                                        <th style="cursor: pointer; user-select: none;" data-sort="node" class="sortable-header">
                                            Node <i class="bi bi-arrow-down-up" style="opacity: 0.5; margin-left: 0.25rem;"></i>
                                        </th>
                                        <th style="cursor: pointer; user-select: none;" data-sort="health_score" class="sortable-header">
                                            Health Score
                                            <i class="bi bi-arrow-down-up" style="opacity: 0.5; margin-left: 0.25rem;"></i>
                                            <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top"
                                               title="Node health score (0-100) based on activity, connectivity, and reliability. Higher is better."></i>
                                        </th>
                                        <th style="cursor: pointer; user-select: none;" data-sort="health_status" class="sortable-header">
                                            Status
                                            <i class="bi bi-arrow-down-up" style="opacity: 0.5; margin-left: 0.25rem;"></i>
                                            <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top"
                                               title="Health status: Healthy (80-100), Degraded (60-79), Poor (40-59), Critical (0-39)."></i>
                                        </th>
                                        <th style="cursor: pointer; user-select: none;" data-sort="issues" class="sortable-header">
                                            Issues
                                            <i class="bi bi-arrow-down-up" style="opacity: 0.5; margin-left: 0.25rem;"></i>
                                            <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top"
                                               title="Detected issues categorized by type: activity, connectivity, reliability, or signal (informational only)."></i>
                                        </th>
                                        <th style="cursor: pointer; user-select: none;" data-sort="packets" class="sortable-header">
                                            Packets
                                            <i class="bi bi-arrow-down-up" style="opacity: 0.5; margin-left: 0.25rem;"></i>
                                            <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top"
                                               title="Total number of packets transmitted by this node during the analysis period."></i>
                                        </th>
                                        <th style="cursor: pointer; user-select: none;" data-sort="rssi" class="sortable-header">
                                            Avg RSSI
                                            <i class="bi bi-arrow-down-up" style="opacity: 0.5; margin-left: 0.25rem;"></i>
                                            <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top"
                                               title="Average Received Signal Strength in dBm. INFORMATIONAL ONLY - varies with distance, does not affect health."></i>
                                        </th>
                                        <th style="cursor: pointer; user-select: none;" data-sort="snr" class="sortable-header">
                                            Avg SNR
                                            <i class="bi bi-arrow-down-up" style="opacity: 0.5; margin-left: 0.25rem;"></i>
                                            <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top"
                                               title="Average Signal-to-Noise Ratio in dB. INFORMATIONAL ONLY - varies with distance, does not affect health."></i>
                                        </th>
                                        <th style="cursor: pointer; user-select: none;" data-sort="gateways" class="sortable-header">
                                            Gateways
                                            <i class="bi bi-arrow-down-up" style="opacity: 0.5; margin-left: 0.25rem;"></i>
                                            <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top"
                                               title="Number of unique gateways that heard this node. More gateways = better redundancy and reliability."></i>
                                        </th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody id="problematic-nodes-tbody">
                                    <!-- Populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Node Detail Modal -->
    <div class="modal fade" id="nodeDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="nodeDetailModalTitle">Node Health Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="nodeDetailModalBody">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let healthTableData = [];
let healthCurrentSort = { column: 'health_score', direction: 'desc' };

// Uptime table data for sorting
let uptimeTableData = [];
let uptimeCurrentSort = { column: 'uptime', direction: 'asc' };

let currentFilters = {
    hours: 24,
    minHealthScore: 70,
    limit: 50
};

// Initialize Bootstrap tooltips
function initializeTooltips() {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
}

// Load network health summary
async function loadNetworkSummary() {
    const hours = currentFilters.hours;

    try {
        const response = await fetch(`/api/health/network-summary?hours=${hours}`);
        const data = await response.json();

        if (data.error) {
            console.error('Error loading network summary:', data.error);
            return;
        }

        // Update summary metrics
        document.getElementById('network-health-score').textContent = Math.round(data.network_health_score);
        document.getElementById('active-nodes-count').textContent = data.active_nodes;
        document.getElementById('avg-rssi').textContent = data.network_metrics.avg_rssi ?
            data.network_metrics.avg_rssi.toFixed(1) + ' dBm' : 'N/A';
        document.getElementById('avg-snr').textContent = data.network_metrics.avg_snr ?
            data.network_metrics.avg_snr.toFixed(1) + ' dB' : 'N/A';

        // Update health distribution
        const dist = data.health_distribution;
        const total = dist.healthy + dist.degraded + dist.poor + dist.critical;

        if (total > 0) {
            const healthyPct = (dist.healthy / total * 100).toFixed(1);
            const degradedPct = (dist.degraded / total * 100).toFixed(1);
            const poorPct = (dist.poor / total * 100).toFixed(1);
            const criticalPct = (dist.critical / total * 100).toFixed(1);

            // Update bars
            const healthyBar = document.getElementById('healthy-bar');
            const degradedBar = document.getElementById('degraded-bar');
            const poorBar = document.getElementById('poor-bar');
            const criticalBar = document.getElementById('critical-bar');

            healthyBar.style.width = healthyPct + '%';
            degradedBar.style.width = degradedPct + '%';
            poorBar.style.width = poorPct + '%';
            criticalBar.style.width = criticalPct + '%';

            // Update counts
            document.getElementById('healthy-count').textContent = dist.healthy;
            document.getElementById('degraded-count').textContent = dist.degraded;
            document.getElementById('poor-count').textContent = dist.poor;
            document.getElementById('critical-count').textContent = dist.critical;

            // Update legend for small screens
            if (document.getElementById('healthy-legend')) {
                document.getElementById('healthy-legend').textContent = dist.healthy;
                document.getElementById('degraded-legend').textContent = dist.degraded;
                document.getElementById('poor-legend').textContent = dist.poor;
                document.getElementById('critical-legend').textContent = dist.critical;
            }

            // Update tooltips
            healthyBar.setAttribute('title', `Healthy: ${dist.healthy} nodes (${healthyPct}%)`);
            degradedBar.setAttribute('title', `Degraded: ${dist.degraded} nodes (${degradedPct}%)`);
            poorBar.setAttribute('title', `Poor: ${dist.poor} nodes (${poorPct}%)`);
            criticalBar.setAttribute('title', `Critical: ${dist.critical} nodes (${criticalPct}%)`);
        }

        document.getElementById('network-summary-loading').style.display = 'none';
        document.getElementById('network-summary-content').style.display = 'block';

        // Initialize tooltips after content is loaded
        initializeTooltips();

    } catch (error) {
        console.error('Error loading network summary:', error);
    }
}

// Load problematic nodes
async function loadProblematicNodes() {
    const { hours, minHealthScore, limit } = currentFilters;

    document.getElementById('problematic-nodes-loading').style.display = 'block';
    document.getElementById('problematic-nodes-content').style.display = 'none';

    try {
        const response = await fetch(
            `/api/health/problematic-nodes?hours=${hours}&min_health_score=${minHealthScore}&limit=${limit}`
        );
        const data = await response.json();

        if (data.error) {
            console.error('Error loading problematic nodes:', data.error);
            return;
        }

        if (data.problematic_nodes.length === 0) {
            document.getElementById('no-issues').style.display = 'block';
            document.getElementById('problematic-nodes-table').style.display = 'none';
        } else {
            document.getElementById('no-issues').style.display = 'none';
            document.getElementById('problematic-nodes-table').style.display = 'table';

            // Store data for sorting
            healthTableData = data.problematic_nodes.map(node => {
                const nodeName = node.node_info.long_name || node.node_info.short_name || `!${node.node_id.toString(16).padStart(8, '0')}`;
                const issuesCount = node.issues.length;

                return {
                    node: nodeName,
                    node_id: node.node_id,
                    health_score: node.health_score,
                    health_status: node.health_status,
                    issues: issuesCount,
                    issues_list: node.issues,
                    packets: node.metrics.total_packets,
                    rssi: node.metrics.avg_rssi || -200,
                    snr: node.metrics.avg_snr || -200,
                    gateways: node.metrics.unique_gateways,
                    raw_node: node
                };
            });

            // Set up sorting handlers
            document.querySelectorAll('.sortable-header').forEach(header => {
                header.removeEventListener('click', handleSortClick);
                header.addEventListener('click', handleSortClick);
            });

            // Initial render
            renderHealthTable();
            updateHealthSortIndicators();
        }

        document.getElementById('problematic-nodes-loading').style.display = 'none';
        document.getElementById('problematic-nodes-content').style.display = 'block';

        // Initialize tooltips after table content is loaded
        initializeTooltips();

    } catch (error) {
        console.error('Error loading problematic nodes:', error);
    }
}

// Load uptime overview data
async function loadUptimeOverview() {
    document.getElementById('uptime-loading').style.display = 'block';
    document.getElementById('uptime-content').style.display = 'none';

    try {
        const response = await fetch('/api/health/uptime-overview?days=7&limit=50');
        if (!response.ok) throw new Error('Failed to load uptime data');

        const data = await response.json();

        // Update summary metrics
        document.getElementById('network-uptime').textContent = `${data.network_avg_uptime}%`;
        document.getElementById('uptime-nodes-count').textContent = data.nodes_analyzed;

        // Count nodes below 90% uptime
        const lowUptimeNodes = data.nodes.filter(n => n.uptime_percentage < 90).length;
        document.getElementById('low-uptime-count').textContent = lowUptimeNodes;

        // Store data for sorting
        uptimeTableData = data.nodes;

        // Set up sorting handlers
        document.querySelectorAll('.uptime-sortable-header').forEach(header => {
            header.removeEventListener('click', handleUptimeSortClick);
            header.addEventListener('click', handleUptimeSortClick);
        });

        // Initial render
        renderUptimeTable();
        updateUptimeSortIndicators();

        document.getElementById('uptime-loading').style.display = 'none';
        document.getElementById('uptime-content').style.display = 'block';

        // Initialize tooltips for the new content
        initializeTooltips();

    } catch (error) {
        console.error('Error loading uptime overview:', error);
        document.getElementById('uptime-loading').innerHTML = '<div class="text-muted">Unable to load uptime data</div>';
    }
}

function handleUptimeSortClick(e) {
    const column = e.currentTarget.getAttribute('data-sort');
    if (uptimeCurrentSort.column === column) {
        uptimeCurrentSort.direction = uptimeCurrentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        uptimeCurrentSort.column = column;
        uptimeCurrentSort.direction = column === 'node' ? 'asc' : 'asc'; // uptime defaults to ascending (worst first)
    }
    renderUptimeTable();
    updateUptimeSortIndicators();
}

function updateUptimeSortIndicators() {
    document.querySelectorAll('.uptime-sortable-header i').forEach(icon => {
        icon.className = 'bi bi-arrow-down-up text-muted';
    });
    const activeIcon = document.getElementById(`uptime-sort-${uptimeCurrentSort.column}`);
    if (activeIcon) {
        activeIcon.className = uptimeCurrentSort.direction === 'asc'
            ? 'bi bi-arrow-up'
            : 'bi bi-arrow-down';
    }
}

function renderUptimeTable() {
    const tbody = document.getElementById('uptime-tbody');
    if (!tbody) return;

    // Sort data
    const sorted = [...uptimeTableData].sort((a, b) => {
        let aVal, bVal;
        if (uptimeCurrentSort.column === 'node') {
            aVal = (a.node_name || '').toLowerCase();
            bVal = (b.node_name || '').toLowerCase();
            return uptimeCurrentSort.direction === 'asc'
                ? aVal.localeCompare(bVal)
                : bVal.localeCompare(aVal);
        } else {
            aVal = a.uptime_percentage;
            bVal = b.uptime_percentage;
            return uptimeCurrentSort.direction === 'asc'
                ? aVal - bVal
                : bVal - aVal;
        }
    });

    tbody.innerHTML = '';

    // Get current date info for future block detection and timezone handling
    const now = new Date();
    const tzPref = typeof getTimezonePreference === 'function' ? getTimezonePreference() : 'local';
    const tzOption = tzPref === 'utc' ? 'UTC' : undefined;

    // Calculate today's date string based on timezone preference
    let todayStr;
    let currentHour;
    if (tzPref === 'utc') {
        todayStr = now.toISOString().split('T')[0];
        currentHour = now.getUTCHours();
    } else {
        // Use local timezone
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        todayStr = `${year}-${month}-${day}`;
        currentHour = now.getHours();
    }

    sorted.forEach(node => {
        const row = document.createElement('tr');

        // Determine uptime color class
        let uptimeClass = 'text-success';
        if (node.uptime_percentage < 70) {
            uptimeClass = 'text-danger';
        } else if (node.uptime_percentage < 90) {
            uptimeClass = 'text-warning';
        }

        // Filter out future days when in local mode (API returns UTC dates)
        const filteredSummary = node.daily_summary.filter(day => day.date <= todayStr);

        // Build compact 7-day visual grid (4 blocks per day = 6-hour periods)
        let dayGridHtml = '<div class="uptime-compact-inline">';

        filteredSummary.forEach(day => {
            const dayDate = new Date(day.date + 'T12:00:00Z');
            const dayName = dayDate.toLocaleDateString(undefined, { weekday: 'short', timeZone: tzOption });
            const monthDay = dayDate.toLocaleDateString(undefined, { month: 'numeric', day: 'numeric', timeZone: tzOption });
            const isToday = day.date === todayStr;

            // Aggregate time blocks into 4 periods (6-hour each)
            const blocks = day.time_blocks || [];
            const periods = [
                { blocks: blocks.slice(0, 3), startHour: 0, label: '12am-6am' },
                { blocks: blocks.slice(3, 6), startHour: 6, label: '6am-12pm' },
                { blocks: blocks.slice(6, 9), startHour: 12, label: '12pm-6pm' },
                { blocks: blocks.slice(9, 12), startHour: 18, label: '6pm-12am' }
            ];

            dayGridHtml += `<div class="uptime-day${isToday ? ' today' : ''}">`;
            dayGridHtml += '<div class="uptime-day-blocks">';

            periods.forEach(period => {
                // Calculate period status from sub-blocks
                let avail = 0, deg = 0;
                period.blocks.forEach(b => {
                    if (b.status === 'available') avail++;
                    else if (b.status === 'degraded') deg++;
                });

                // Determine if this period is in the future (for today)
                const isFuture = isToday && period.startHour > currentHour;

                let status;
                if (isFuture) {
                    status = 'future';
                } else if (period.blocks.length === 0) {
                    // No block data, use day uptime
                    status = day.uptime_percentage >= 80 ? 'available' :
                             day.uptime_percentage >= 50 ? 'degraded' : 'unavailable';
                } else if (avail >= 2) {
                    status = 'available';
                } else if (avail + deg >= 2) {
                    status = 'degraded';
                } else {
                    status = 'unavailable';
                }

                const tooltip = isFuture ? `${period.label}: Future` :
                    `${dayName} ${monthDay} ${period.label}`;

                dayGridHtml += `<div class="uptime-block ${status}" title="${tooltip}"></div>`;
            });

            dayGridHtml += '</div>';
            dayGridHtml += `<div class="uptime-day-label">`;
            dayGridHtml += `<span class="day-name">${isToday ? 'Tdy' : dayName}</span>`;
            dayGridHtml += '</div></div>';
        });

        dayGridHtml += '</div>';

        // Format node name with role badge
        const roleLabel = node.role ? `<span class="badge bg-secondary ms-1" style="font-size: 0.65em;">${node.role}</span>` : '';
        const nodeIdHex = node.node_id.toString(16).padStart(8, '0');

        row.innerHTML = `
            <td>
                <a href="/node/${node.node_id}" class="text-decoration-none">
                    ${node.node_name}${roleLabel}
                </a>
                <br><small class="text-muted">!${nodeIdHex}</small>
            </td>
            <td class="text-center ${uptimeClass}" style="font-weight: bold;">
                ${node.uptime_percentage}%
            </td>
            <td>
                ${dayGridHtml}
            </td>
        `;

        tbody.appendChild(row);
    });

    // Reinitialize tooltips
    initializeTooltips();
}

function handleSortClick(e) {
    const column = e.currentTarget.getAttribute('data-sort');
    if (healthCurrentSort.column === column) {
        healthCurrentSort.direction = healthCurrentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        healthCurrentSort.column = column;
        healthCurrentSort.direction = column === 'node' ? 'asc' : 'desc';
    }
    renderHealthTable();
    updateHealthSortIndicators();
}

function renderHealthTable() {
    const tbody = document.getElementById('problematic-nodes-tbody');
    if (!tbody) return;

    // Sort data
    const sorted = [...healthTableData].sort((a, b) => {
        let aVal = a[healthCurrentSort.column];
        let bVal = b[healthCurrentSort.column];

        // Handle string vs number comparisons
        if (typeof aVal === 'string') {
            aVal = aVal.toLowerCase();
            bVal = bVal.toLowerCase();
            return healthCurrentSort.direction === 'asc'
                ? aVal.localeCompare(bVal)
                : bVal.localeCompare(aVal);
        } else {
            return healthCurrentSort.direction === 'asc'
                ? aVal - bVal
                : bVal - aVal;
        }
    });

    // Render sorted rows
    tbody.innerHTML = '';
    sorted.forEach(item => {
        const row = createNodeRow(item);
        tbody.appendChild(row);
    });
}

function updateHealthSortIndicators() {
    document.querySelectorAll('.sortable-header').forEach(header => {
        const column = header.getAttribute('data-sort');
        const icon = header.querySelector('.bi-arrow-down-up, .bi-sort-up, .bi-sort-down');

        if (!icon) return;

        if (column === healthCurrentSort.column) {
            icon.className = healthCurrentSort.direction === 'asc'
                ? 'bi bi-sort-up'
                : 'bi bi-sort-down';
            icon.style.opacity = '1.0';
        } else {
            icon.className = 'bi bi-arrow-down-up';
            icon.style.opacity = '0.5';
        }
    });
}

// Create table row for a node (updated to work with data objects)
function createNodeRow(nodeData) {
    const tr = document.createElement('tr');
    const node = nodeData.raw_node;
    const healthClass = `health-${node.health_status}`;

    // Issues summary - highlight outages
    const issuesHtml = node.issues.map(issue => {
        const badgeClass = `issue-${issue.severity}`;
        let issueText = issue.category;

        // Add outage count badge if present
        if (issue.category === 'reliability' && issue.outage_details && issue.outage_details.length > 0) {
            issueText += ` (${issue.outage_details.length})`;
        }

        return `<span class="badge ${badgeClass}" data-bs-toggle="tooltip" data-bs-placement="top"
                      title="${issue.message}">${issueText}</span>`;
    }).join(' ');

    tr.innerHTML = `
        <td><a href="/node/${node.node_id}">${nodeData.node}</a></td>
        <td><span class="badge health-score-badge ${healthClass}">${node.health_score}</span></td>
        <td><span class="badge ${healthClass}">${node.health_status}</span></td>
        <td>${issuesHtml}</td>
        <td>${node.metrics.total_packets}</td>
        <td>${node.metrics.avg_rssi ? node.metrics.avg_rssi.toFixed(1) : 'N/A'}</td>
        <td>${node.metrics.avg_snr ? node.metrics.avg_snr.toFixed(1) : 'N/A'}</td>
        <td>${node.metrics.unique_gateways}</td>
        <td><button class="btn btn-sm btn-outline-primary view-details-btn" data-node-id="${node.node_id}">
            <i class="bi bi-info-circle"></i> View
        </button></td>
    `;

    return tr;
}

// Show node details modal
async function showNodeDetails(nodeId) {
    const modal = new bootstrap.Modal(document.getElementById('nodeDetailModal'));
    const modalTitle = document.getElementById('nodeDetailModalTitle');
    const modalBody = document.getElementById('nodeDetailModalBody');

    modalBody.innerHTML = '<div class="text-center p-3"><div class="spinner-border text-primary"></div></div>';
    modal.show();

    try {
        const response = await fetch(`/api/health/node/${nodeId}?hours=${currentFilters.hours}`);
        const data = await response.json();

        if (data.error) {
            modalBody.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
            return;
        }

        const nodeName = data.node_info.long_name || data.node_info.short_name ||
                        `!${data.node_id.toString(16).padStart(8, '0')}`;
        modalTitle.textContent = `Health Details: ${nodeName}`;

        // Build detailed view
        const confidenceClass = data.confidence_score >= 80 ? 'success' :
                               data.confidence_score >= 60 ? 'warning' : 'danger';

        let detailsHtml = `
            <div class="row mb-3">
                <div class="col-md-6">
                    <h6>Health Overview</h6>
                    <p><strong>Health Score:</strong> <span class="badge health-score-badge health-${data.health_status}">${data.health_score}</span></p>
                    <p><strong>Status:</strong> <span class="badge health-${data.health_status}">${data.health_status}</span></p>
                    <p><strong>Confidence:</strong>
                        <span class="badge bg-${confidenceClass}" data-bs-toggle="tooltip" data-bs-placement="top"
                              title="${data.confidence_factors ? data.confidence_factors.join('; ') : 'Assessment confidence'}">
                            ${data.confidence_score}%
                        </span>
                        <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip" data-bs-placement="top"
                           title="Confidence score indicates reliability of health assessment based on data availability and consistency"></i>
                    </p>
                    <p><strong>Hardware:</strong> ${data.node_info.hw_model || 'Unknown'}</p>
                    <p><strong>Role:</strong> ${data.node_info.role || 'Unknown'}</p>
                </div>
                <div class="col-md-6">
                    <h6>Metrics (${data.analyzed_hours}h)
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top"
                           title="Metrics calculated over the last ${data.analyzed_hours} hours of network activity"></i>
                    </h6>
                    <p><strong>Total Packets:</strong> ${data.metrics.total_packets}</p>
                    <p><strong>Avg RSSI:</strong> ${data.metrics.avg_rssi ? data.metrics.avg_rssi.toFixed(1) + ' dBm' : 'N/A'}</p>
                    <p><strong>Avg SNR:</strong> ${data.metrics.avg_snr ? data.metrics.avg_snr.toFixed(1) + ' dB' : 'N/A'}</p>
                    <p><strong>Unique Gateways:</strong> ${data.metrics.unique_gateways}</p>
                    <p><strong>Activity Gaps:</strong> ${data.metrics.activity_gaps}
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top"
                           title="Number of gaps in activity (periods > 30 minutes between packets)"></i>
                    </p>
                    <p><strong>Long Outages:</strong> ${data.metrics.long_outages}
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top"
                           title="Outages lasting more than 2 hours. Detected when no packets are received for an extended period, indicating node offline or network issues."></i>
                    </p>
                </div>
            </div>
        `;

        // Add baseline information if available
        if (data.baseline && data.baseline.has_baseline) {
            const variabilityText = data.baseline.coefficient_of_variation > 1.5 ? 'highly variable' :
                                   data.baseline.coefficient_of_variation > 1.0 ? 'moderately variable' : 'consistent';
            detailsHtml += `
                <div class="alert alert-info mb-3">
                    <h6 class="alert-heading"><i class="bi bi-graph-up"></i> Baseline Behavior</h6>
                    <small>
                        <strong>Average Activity:</strong> ${data.baseline.avg_packets_per_day.toFixed(1)} packets/day<br>
                        <strong>History:</strong> ${data.baseline.total_packets} packets over ${data.baseline.total_days.toFixed(0)} days<br>
                        <strong>Pattern:</strong> ${variabilityText} activity pattern<br>
                        <strong>Active Days:</strong> ${data.baseline.days_with_activity} of ${data.baseline.total_days.toFixed(0)} days
                    </small>
                </div>
            `;
        }

        if (data.issues.length > 0) {
            detailsHtml += '<h6>Issues Detected</h6><ul class="list-group mb-3">';
            data.issues.forEach(issue => {
                const badgeClass = `issue-${issue.severity}`;
                detailsHtml += `
                    <li class="list-group-item">
                        <span class="badge ${badgeClass}">${issue.severity}</span>
                        <strong>${issue.category}:</strong> ${issue.message}
                `;

                // Add detailed outage information if available
                if (issue.outage_details && issue.outage_details.length > 0) {
                    detailsHtml += '<div class="mt-2"><small class="text-muted"><strong>Outage Details:</strong></small><ul class="small mt-1">';
                    issue.outage_details.forEach(outage => {
                        detailsHtml += `
                            <li>
                                <span data-bs-toggle="tooltip" data-bs-placement="top"
                                      title="Outage detected when no packets were received for ${outage.duration_formatted}. This indicates the node was offline or unable to transmit.">
                                    <strong>${outage.duration_formatted}</strong> -
                                    ${outage.start_time} to ${outage.end_time}
                                    <i class="bi bi-info-circle text-muted"></i>
                                </span>
                            </li>
                        `;
                    });
                    detailsHtml += '</ul></div>';
                }

                detailsHtml += '</li>';
            });
            detailsHtml += '</ul>';
        }

        modalBody.innerHTML = detailsHtml;

        // Reinitialize tooltips for the modal content
        initializeTooltips();

    } catch (error) {
        console.error('Error loading node details:', error);
        modalBody.innerHTML = `<div class="alert alert-danger">Error loading node details</div>`;
    }
}

// Event listeners
document.getElementById('hours-filter').addEventListener('change', (e) => {
    currentFilters.hours = parseInt(e.target.value);
    loadNetworkSummary();
    loadProblematicNodes();
});

document.getElementById('min-health-score').addEventListener('change', (e) => {
    currentFilters.minHealthScore = parseInt(e.target.value);
    loadProblematicNodes();
});

document.getElementById('limit-filter').addEventListener('change', (e) => {
    currentFilters.limit = parseInt(e.target.value);
    loadProblematicNodes();
});

document.getElementById('refresh-btn').addEventListener('click', () => {
    loadNetworkSummary();
    loadProblematicNodes();
    loadUptimeOverview();
});

// Delegated event listener for view details buttons
document.getElementById('problematic-nodes-tbody').addEventListener('click', (e) => {
    if (e.target.closest('.view-details-btn')) {
        const nodeId = e.target.closest('.view-details-btn').dataset.nodeId;
        showNodeDetails(nodeId);
    }
});

// Initial load
loadNetworkSummary();
loadProblematicNodes();
loadUptimeOverview();

// Initialize tooltips on page load
document.addEventListener('DOMContentLoaded', initializeTooltips);
</script>
{% endblock %}
